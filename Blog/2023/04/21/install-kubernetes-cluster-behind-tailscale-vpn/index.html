
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://readthedocs.vinczejanos.info/Blog/2023/04/21/install-kubernetes-cluster-behind-tailscale-vpn/">
      
      
        <link rel="prev" href="../../../../2022/11/18/deploy-elasticsearch-cluster--kibaba-on-kubernetes/">
      
      
        <link rel="next" href="../../28/upgrade-postgressql-on-kubernetes-with-job/">
      
      
        
      
      
      <link rel="icon" href="../../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Install Kubernetes Cluster Behind Tailscale VPN - Vincze Janos Blog</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../css/width.css">
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#install-kubernetes-cluster-behind-tailscale-vpn" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../.." title="Vincze Janos Blog" class="md-header__button md-logo" aria-label="Vincze Janos Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Vincze Janos Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Install Kubernetes Cluster Behind Tailscale VPN
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="light-green" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/jvincze84/jvincze84.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="Vincze Janos Blog" class="md-nav__button md-logo" aria-label="Vincze Janos Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Vincze Janos Blog
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jvincze84/jvincze84.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Welcome Here
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Tips_And_Tricks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tips And Tricks 2024a
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../new-file/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Ez egy uj test file
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Blog
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Blog
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Kubernetes Templates
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Kubernetes Templates
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Kubernetes_Templates/ConfigMap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ConfigMap
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Kubernetes_Templates/Deployment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deployments
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Kubernetes_Templates/Ingress/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Ingress
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Kubernetes_Templates/PersistentVolumeClaim/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PersistentVolumeClaim
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Kubernetes_Templates/ReverseProxy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Kubernetes Reverse Proxy With Ingress, Service And Endpoint
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Kubernetes_Templates/Secret/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Secret
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Kubernetes_Templates/StatefulSet/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    StatefulSet
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Kubernetes_Templates/services/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Services
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Old Blog Contents
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Old Blog Contents
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1" >
        
          
          <label class="md-nav__link" for="__nav_6_1" id="__nav_6_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Linux
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Linux
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/linux/Compile_Apache_Httpd_2.4.x_Php/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Compile Apache HTTPD 2.4.X &amp; PHP
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/linux/Create_Self_Signed_Certificate_For_Apache_Webserver/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Create Self Signed Certificate For Apache Webserver
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/linux/Install_%28compile%29_%26_Configure_Motion_Av_Tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Install (compile) & Configure Motion Av Tools
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/linux/Install_Mps-youtube_Console_Based_Youtube_Player/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Install Mps youtube Console Based Youtube Player
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/linux/create_Your_Own_Dyndns_Service_With_Bind_named/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    create Your Own Dyndns Service With Bind named
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2" >
        
          
          <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Nodemcu
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Nodemcu
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/nodemcu/How_To_Compile_Nodemcu_Firmware/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    How To Compile Nodemcu Firmware
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/nodemcu/How_To_Unbrick_Esp8266_blinking_Blue_Led/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    How To Unbrick Esp8266 blinking Blue Led
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/nodemcu/Install_Openalpr_On_Raspberry_Pi_3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Install OpenALPR on Raspberry PI 3
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/nodemcu/Logging_Mqtt_Data_%28subscription%29_To_Mysql_With_Shell_Script/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Logging Mqtt Data (subscription) To Mysql With Shell Script
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/nodemcu/Reliable_MQTT_conenction_with_NodeMCU/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Reliable MQTT conenction with NodeMCU
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/nodemcu/Reliable_Mqtt_Connection_With_Nodemcu_%28part_2%29/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Reliable Mqtt Connection With Nodemcu (part 2)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/nodemcu/Very_Simple_Way_To_Send_Email_Using_Nodemcu_Firmware/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Very Simple Way to Send Email Using NodeMCU firmware
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3" >
        
          
          <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Other
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Other
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/other/Collect_Network_Statistic_With_Telegraf_Vnstat/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Collect Network Statistic With Telegraf &amp; VNSTAT
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/other/Iptables_Examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Iptables Examples
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/other/Nokia_6120c_%28bb5%29_Forgotten_Security_Code/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Nokia 6120c (BB5) Forgotten Security Code
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/other/Sonoff_Relays_With_Openhab_And_Tasmota_Firmware/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sonoff Relays With OpenHab And Tasmota Firmware
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4" >
        
          
          <label class="md-nav__link" for="__nav_6_4" id="__nav_6_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Raspberry
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Raspberry
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/raspberry/Compile_Go_Language_On_Raspberry_Pi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Compile Go Language On Raspberry Pi
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/raspberry/Google_Cloud_Print_With_Orange_Pi_or_Rpi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Google Cloud Print With Orange Pi or Rpi
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/raspberry/How_To_Install_Nodered_On_Raspberry_Pi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    How To Install Nodered On Raspberry Pi
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/raspberry/Install_Debian_Jessie_To_Orange_Pi_Plus_2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Install Debian Jessie to Orange PI Plus 2
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/raspberry/Install_Openalpr_On_Raspberry_Pi_3_part_2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Install Openalpr On Raspberry Pi 3 part 2
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/raspberry/Mount_Sd_Card_Image_partitioned_Image_Wo_Kpartx/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mount SD card image (partitioned image) w/o kpartx
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/raspberry/Move_Root_File_System_To_Usb_Storage_%28rpi2_%26_Rpi3%29/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Move root file system to USB storage (RPI2 &amp; RPI3)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/raspberry/Raspberry_Pi_2_As_Print_Server_Airprint/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Raspberry Pi 2 As Print Server Airprint
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/raspberry/Raspberry_Pi_3_As_Wifi_Range_Extender/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Raspberry Pi 3 As Wifi Range Extender
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tldr" class="md-nav__link">
    <span class="md-ellipsis">
      
        TL;DR
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#infrastructure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Infrastructure
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Infrastructure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hardware" class="md-nav__link">
    <span class="md-ellipsis">
      
        Hardware
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#preparing-the-os" class="md-nav__link">
    <span class="md-ellipsis">
      
        Preparing The OS
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Preparing The OS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ansible" class="md-nav__link">
    <span class="md-ellipsis">
      
        Ansible
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Ansible">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ansiblecfg" class="md-nav__link">
    <span class="md-ellipsis">
      
        ansible.cfg
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#myvarsyml" class="md-nav__link">
    <span class="md-ellipsis">
      
        myvars.yml
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hosts" class="md-nav__link">
    <span class="md-ellipsis">
      
        hosts
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update" class="md-nav__link">
    <span class="md-ellipsis">
      
        Update
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-common-packages" class="md-nav__link">
    <span class="md-ellipsis">
      
        Install Common Packages
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-container-engine" class="md-nav__link">
    <span class="md-ellipsis">
      
        Install Container Engine
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-kubernetes-tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        Install Kubernetes Tools
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tailscale-vpn" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tailscale VPN
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tailscale VPN">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#updated-ip-address-table" class="md-nav__link">
    <span class="md-ellipsis">
      
        Updated IP Address Table
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optional-disable-direct-access" class="md-nav__link">
    <span class="md-ellipsis">
      
        (Optional) Disable Direct Access
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#init-the-cluster" class="md-nav__link">
    <span class="md-ellipsis">
      
        Init The Cluster
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Init The Cluster">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prepare-kubelet" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prepare Kubelet
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prepare-the-load-balancer" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prepare The Load Balancer
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#init-the-first-control-plane-node" class="md-nav__link">
    <span class="md-ellipsis">
      
        Init The First Control Plane Node
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#init-additional-control-plane-nodes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Init Additional Control Plane Nodes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optional-post-init-steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        (optional) Post Init Steps
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="(optional) Post Init Steps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mark-nodes-as-worker" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mark Nodes As Worker
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#untaint-the-nodes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Untaint The Nodes
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-network-plugin" class="md-nav__link">
    <span class="md-ellipsis">
      
        Install Network Plugin
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Install Network Plugin">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#weave" class="md-nav__link">
    <span class="md-ellipsis">
      
        Weave
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flannel" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flannel
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#switch-between-iptables-legacy-and-iptables-nft" class="md-nav__link">
    <span class="md-ellipsis">
      
        Switch Between iptables-legacy And iptables-nft
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bonus-persistent-storage" class="md-nav__link">
    <span class="md-ellipsis">
      
        (bonus) - Persistent Storage
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="(bonus) - Persistent Storage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-pvc" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create PVC
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../../" class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg>
                        <time datetime="2023-04-21 00:00:00+00:00" class="md-ellipsis">April 21, 2023</time>
                      </div>
                    </li>
                    
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg>
                          <span class="md-ellipsis">
                            
                              26 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
          </nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  



  
  


<h1 id="install-kubernetes-cluster-behind-tailscale-vpn">Install Kubernetes Cluster Behind Tailscale VPN<a class="headerlink" href="#install-kubernetes-cluster-behind-tailscale-vpn" title="Permanent link">&para;</a></h1>
<h2 id="tldr">TL;DR<a class="headerlink" href="#tldr" title="Permanent link">&para;</a></h2>
<p>In this post we will install a <strong>multi-master</strong> Kubernetes cluster behind Tailscale VPN.
This scenario can be useful when:</p>
<ul>
<li>Your Kubernetes nodes are not in the same subnet. </li>
<li>You are building a home-lab system, and the nodes are behind two or more NAT-ted network, or even behind CGNAT.</li>
<li>Your nodes are running in separate data centers, and don't want to publish API ports on the public internet. </li>
<li>You want to access your cluster only from private VPN network.</li>
<li>You want extra security by encrypted connection between nodes.</li>
<li>Or the mixture of above scenarios. </li>
</ul>
<!-- more -->

<p><strong>Why Tailscale VPN?</strong></p>
<p>You can use any other VPN solution like Wireguard, OpenVPN, IPSec, etc. But nowadays I think Tailscale is the easiest way to bring up a VPN network.
With a free registration you get 100 device, subnet routers, exit nodes, (Magic)DNS, and so many useful features. </p>
<p>For more information check the following links:</p>
<ul>
<li><a href="https://tailscale.com">TailScale</a></li>
<li><a href="https://tailscale.com/pricing/">Tailscale Pricing</a></li>
</ul>
<p>But as I mentioned you can use any other VPN solution, personally I'm using Wireguard in my home-lab system.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Tailscale assigns IP address from <code>100.64.0.0/10</code> range! <a href="https://tailscale.com/kb/1015/100.x-addresses/">IP Address Assignment</a>
If you are planning to use <a href="https://www.kube-ovn.io">Kube-OVN</a> networking don't forget to change the CIDR, because Kube-OVN is also use this subnet!</p>
</div>
<h2 id="infrastructure">Infrastructure<a class="headerlink" href="#infrastructure" title="Permanent link">&para;</a></h2>
<p>As I mentioned we will deploy a multi-master Kubernetes cluster:</p>
<ul>
<li>3 master|worker nodes, without worker nodes. Later additional worker nodes can be added to the cluster, but for the simplicity we won't deploy extra worker nodes.</li>
<li>We need an additional TCP load balancer for the API requests. I prefer HAProxy for this purpose, because it is easy to set up and lightweight. <ul>
<li>For this lab I will deploy only one Load Balancer, but if you need HA solution, at least two Load Balancers are needed. This can be achieved by using Keppalived. Or you can use external load balancer like F5. But this demo is not about HA Load balancers, so it is just enough to have only one LB.</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: left;">Hostname</th>
<th style="text-align: left;">Role</th>
<th style="text-align: left;">IP Address</th>
<th style="text-align: left;">VPN IP Address</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">kube02-m1</td>
<td style="text-align: left;">Control Plane Node 1</td>
<td style="text-align: left;">172.16.1.77</td>
<td style="text-align: left;">Later</td>
</tr>
<tr>
<td style="text-align: left;">kube02-m2</td>
<td style="text-align: left;">Control Plane Node 2</td>
<td style="text-align: left;">172.16.1.78</td>
<td style="text-align: left;">Later</td>
</tr>
<tr>
<td style="text-align: left;">kube02-m3</td>
<td style="text-align: left;">Control Plane Node 3</td>
<td style="text-align: left;">172.16.1.79</td>
<td style="text-align: left;">Later</td>
</tr>
<tr>
<td style="text-align: left;">kube02-haproxy</td>
<td style="text-align: left;">HAProxy Load Balancer</td>
<td style="text-align: left;">172.16.1.80</td>
<td style="text-align: left;">Later</td>
</tr>
<tr>
<td style="text-align: left;">ansible</td>
<td style="text-align: left;">Ansible Host</td>
<td style="text-align: left;">172.16.0.252</td>
<td style="text-align: left;">---</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You don't need the additional Ansible host, if you preparing the OS manually. </p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can use one of the kubernetes node for HAProxy, but in this case you need to configure either the HAProxy listen port or <code>--apiserver-bind-port</code> (kubadm init).</p>
</div>
<p>The nodes in this test environment are connected each other on the same subnet.</p>
<h3 id="hardware">Hardware<a class="headerlink" href="#hardware" title="Permanent link">&para;</a></h3>
<p>These nodes are completely identical both on hardware and OS level, running on Proxmox Virtualization platform with KVM.</p>
<ul>
<li>2 CPU cores</li>
<li>2GB memory</li>
<li>32B system disk</li>
<li>Debian OS</li>
<li>Debian GNU/Linux 11 (bullseye)</li>
<li>Kernel: <code>5.10.0-21-amd64</code></li>
</ul>
<h2 id="preparing-the-os">Preparing The OS<a class="headerlink" href="#preparing-the-os" title="Permanent link">&para;</a></h2>
<p>In this post I'm using <strong>Ansible</strong> to prepare the Debian OSes for Kubernetes installation.
I'm highly recommend to use some kind of automatization tool(s) or scirpt(s) to maintain your infrastructure, especially if you planning to have a bunch of nodes, not just a home-lab.
And if something goes wrong you can start it over in a minute.</p>
<h3 id="ansible">Ansible<a class="headerlink" href="#ansible" title="Permanent link">&para;</a></h3>
<p>Just a quick overview about my Ansible configuration and variables.</p>
<h4 id="ansiblecfg"><code>ansible.cfg</code><a class="headerlink" href="#ansiblecfg" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename"><a href="https://raw.githubusercontent.com/jvincze84/jvincze84.github.io/master/docs/files/kube-ans-tailscale/ansible.cfg" target="_blank">Click Here For Raw Source</a></span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="p p-Indicator">[</span><span class="nv">defaults</span><span class="p p-Indicator">]</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="l l-Scalar l-Scalar-Plain">inventory = hosts</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="l l-Scalar l-Scalar-Plain">host_key_checking = False</span>
</code></pre></div></td></tr></table></div>
<h4 id="myvarsyml"><code>myvars.yml</code><a class="headerlink" href="#myvarsyml" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename"><a href="https://raw.githubusercontent.com/jvincze84/jvincze84.github.io/master/docs/files/kube-ans-tailscale/myvars.yml" target="_blank">Click Here For Raw Source</a></span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span>
<span class="normal"><a href="#__codelineno-1-17">17</a></span>
<span class="normal"><a href="#__codelineno-1-18">18</a></span>
<span class="normal"><a href="#__codelineno-1-19">19</a></span>
<span class="normal"><a href="#__codelineno-1-20">20</a></span>
<span class="normal"><a href="#__codelineno-1-21">21</a></span>
<span class="normal"><a href="#__codelineno-1-22">22</a></span>
<span class="normal"><a href="#__codelineno-1-23">23</a></span>
<span class="normal"><a href="#__codelineno-1-24">24</a></span>
<span class="normal"><a href="#__codelineno-1-25">25</a></span>
<span class="normal"><a href="#__codelineno-1-26">26</a></span>
<span class="normal"><a href="#__codelineno-1-27">27</a></span>
<span class="normal"><a href="#__codelineno-1-28">28</a></span>
<span class="normal"><a href="#__codelineno-1-29">29</a></span>
<span class="normal"><a href="#__codelineno-1-30">30</a></span>
<span class="normal"><a href="#__codelineno-1-31">31</a></span>
<span class="normal"><a href="#__codelineno-1-32">32</a></span>
<span class="normal"><a href="#__codelineno-1-33">33</a></span>
<span class="normal"><a href="#__codelineno-1-34">34</a></span>
<span class="normal"><a href="#__codelineno-1-35">35</a></span>
<span class="normal"><a href="#__codelineno-1-36">36</a></span>
<span class="normal"><a href="#__codelineno-1-37">37</a></span>
<span class="normal"><a href="#__codelineno-1-38">38</a></span>
<span class="normal"><a href="#__codelineno-1-39">39</a></span>
<span class="normal"><a href="#__codelineno-1-40">40</a></span>
<span class="normal"><a href="#__codelineno-1-41">41</a></span>
<span class="normal"><a href="#__codelineno-1-42">42</a></span>
<span class="normal"><a href="#__codelineno-1-43">43</a></span>
<span class="normal"><a href="#__codelineno-1-44">44</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nt">yq_url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/mikefarah/yq/releases/download/v4.30.8/yq_linux_amd64</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="nt">kube_version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.26.4-00</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="nt">common_packages</span><span class="p">:</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apt-transport-https</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sudo</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vim</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vnstat</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">xz-utils</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tcpdump</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">screen</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rsync</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sshpass</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">git</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mc</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">wget</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">curl</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jq</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">htop</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">net-tools</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dnsutils</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ca-certificates</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">telnet</span>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">htop</span>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">iotop</span>
<a id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">curl</span>
<a id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gnupg</span>
<a id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lsb-release</span>
<a id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">wireguard</span>
<a id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">wireguard-tools</span>
<a id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">whois</span>
<a id="__codelineno-1-32" name="__codelineno-1-32"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">samba-common</span>
<a id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">smbclient</span>
<a id="__codelineno-1-34" name="__codelineno-1-34"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cifs-utils</span>
<a id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nfs-common</span>
<a id="__codelineno-1-36" name="__codelineno-1-36"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">open-iscsi</span>
<a id="__codelineno-1-37" name="__codelineno-1-37"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gnupg-agent</span>
<a id="__codelineno-1-38" name="__codelineno-1-38"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">software-properties-common</span>
<a id="__codelineno-1-39" name="__codelineno-1-39"></a>
<a id="__codelineno-1-40" name="__codelineno-1-40"></a><span class="nt">docker_packages</span><span class="p">:</span>
<a id="__codelineno-1-41" name="__codelineno-1-41"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker-ce</span>
<a id="__codelineno-1-42" name="__codelineno-1-42"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker-ce-cli</span>
<a id="__codelineno-1-43" name="__codelineno-1-43"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">containerd.io</span>
<a id="__codelineno-1-44" name="__codelineno-1-44"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker-compose-plugin</span>
</code></pre></div></td></tr></table></div>
<p><strong>Details:</strong></p>
<ul>
<li><code>yq_url</code>: Yq binary URL. This version of yq will be installed on the hosts.</li>
<li><code>kube_version</code>: Here you can define which version of Kubernetes you want to install. (kubelet, kubeadm and kubectl)</li>
<li><code>common_packages</code>: These packages will be installed on the hosts. "Common packages" because usually I install these packages on my VMs, regardless of deploying Docker or Kubernetes. </li>
<li><code>docker_packages</code>: Packages for installing Docker/Containerd engine.</li>
</ul>
<h4 id="hosts"><code>hosts</code><a class="headerlink" href="#hosts" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename"><a href="https://raw.githubusercontent.com/jvincze84/jvincze84.github.io/master/docs/files/kube-ans-tailscale/hosts" target="_blank">Click Here For Raw Source</a></span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a>[pve-kube02]
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>172.16.1.77
<a id="__codelineno-2-3" name="__codelineno-2-3"></a>172.16.1.78
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>172.16.1.79
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>172.16.1.80
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a>[pve-kube02:vars]
<a id="__codelineno-2-8" name="__codelineno-2-8"></a>ansible_connection=ssh
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>ansible_user=root
<a id="__codelineno-2-10" name="__codelineno-2-10"></a>ansible_password=rootpassword
</code></pre></div></td></tr></table></div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Ansible host must access the VMs over ssh. Before you run any of the playbooks please enable root login.
For example: <code>sed -i -e 's/^#\(PermitRootLogin \).*/\1 yes/' /etc/ssh/sshd_config</code> and restart sshd daemon. 
It is highly recommended to use dedicated ansible user (with sudo right) and ssh key authentication! 
<strong>And don't forget to accept ssh key by login to the remotes systems before run the playbooks.</strong>
If you are using other user than root, you may want to use <code>become: 'yes'</code> option it the plays.</p>
</div>
<h3 id="update">Update<a class="headerlink" href="#update" title="Permanent link">&para;</a></h3>
<p>I usually start with updating the OS to the latest version, unless the application to be installed has strict requirements.</p>
<p><strong>playbook-upgrade-debian.yaml</strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename"><a href="https://raw.githubusercontent.com/jvincze84/jvincze84.github.io/master/docs/files/kube-ans-tailscale/playbook-upgrade-debian.yaml" target="_blank">Click Here For Raw Source</a></span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">1</a></span>
<span class="normal"><a href="#__codelineno-3-2">2</a></span>
<span class="normal"><a href="#__codelineno-3-3">3</a></span>
<span class="normal"><a href="#__codelineno-3-4">4</a></span>
<span class="normal"><a href="#__codelineno-3-5">5</a></span>
<span class="normal"><a href="#__codelineno-3-6">6</a></span>
<span class="normal"><a href="#__codelineno-3-7">7</a></span>
<span class="normal"><a href="#__codelineno-3-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pve-kube02</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run Included Task - Upgrade Ddebian</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">      </span><span class="nt">ansible.builtin.import_tasks</span><span class="p">:</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">        </span><span class="nt">file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">task_allow_release_info_change.yaml</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Reboot the machine</span><span class="w"> </span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">      </span><span class="nt">ansible.builtin.reboot</span><span class="p">:</span>
</code></pre></div></td></tr></table></div>
<p><strong>task_allow_release_info_change.yaml</strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename"><a href="https://raw.githubusercontent.com/jvincze84/jvincze84.github.io/master/docs/files/kube-ans-tailscale/task_allow_release_info_change.yaml" target="_blank">Click Here For Raw Source</a></span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow release info change</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">  </span><span class="nt">lineinfile</span><span class="p">:</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/apt/apt.conf.d/99releaseinfochange</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="nt">create</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">    </span><span class="nt">line</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Acquire::AllowReleaseInfoChange::Suite &quot;true&quot;;</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Update apt cache</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">  </span><span class="nt">ansible.builtin.apt</span><span class="p">:</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">    </span><span class="nt">update_cache</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">    </span><span class="nt">upgrade</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">full</span>
</code></pre></div></td></tr></table></div>
<p><strong>Run this playbook:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>ansible-playbook<span class="w"> </span>playbook-upgrade-debian.yaml
</code></pre></div>
<h3 id="install-common-packages">Install Common Packages<a class="headerlink" href="#install-common-packages" title="Permanent link">&para;</a></h3>
<p><strong>playbook-install-common-packages.yaml</strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename"><a href="https://raw.githubusercontent.com/jvincze84/jvincze84.github.io/master/docs/files/kube-ans-tailscale/playbook-install-common-packages.yaml" target="_blank">Click Here For Raw Source</a></span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span>
<span class="normal"><a href="#__codelineno-6-20">20</a></span>
<span class="normal"><a href="#__codelineno-6-21">21</a></span>
<span class="normal"><a href="#__codelineno-6-22">22</a></span>
<span class="normal"><a href="#__codelineno-6-23">23</a></span>
<span class="normal"><a href="#__codelineno-6-24">24</a></span>
<span class="normal"><a href="#__codelineno-6-25">25</a></span>
<span class="normal"><a href="#__codelineno-6-26">26</a></span>
<span class="normal"><a href="#__codelineno-6-27">27</a></span>
<span class="normal"><a href="#__codelineno-6-28">28</a></span>
<span class="normal"><a href="#__codelineno-6-29">29</a></span>
<span class="normal"><a href="#__codelineno-6-30">30</a></span>
<span class="normal"><a href="#__codelineno-6-31">31</a></span>
<span class="normal"><a href="#__codelineno-6-32">32</a></span>
<span class="normal"><a href="#__codelineno-6-33">33</a></span>
<span class="normal"><a href="#__codelineno-6-34">34</a></span>
<span class="normal"><a href="#__codelineno-6-35">35</a></span>
<span class="normal"><a href="#__codelineno-6-36">36</a></span>
<span class="normal"><a href="#__codelineno-6-37">37</a></span>
<span class="normal"><a href="#__codelineno-6-38">38</a></span>
<span class="normal"><a href="#__codelineno-6-39">39</a></span>
<span class="normal"><a href="#__codelineno-6-40">40</a></span>
<span class="normal"><a href="#__codelineno-6-41">41</a></span>
<span class="normal"><a href="#__codelineno-6-42">42</a></span>
<span class="normal"><a href="#__codelineno-6-43">43</a></span>
<span class="normal"><a href="#__codelineno-6-44">44</a></span>
<span class="normal"><a href="#__codelineno-6-45">45</a></span>
<span class="normal"><a href="#__codelineno-6-46">46</a></span>
<span class="normal"><a href="#__codelineno-6-47">47</a></span>
<span class="normal"><a href="#__codelineno-6-48">48</a></span>
<span class="normal"><a href="#__codelineno-6-49">49</a></span>
<span class="normal"><a href="#__codelineno-6-50">50</a></span>
<span class="normal"><a href="#__codelineno-6-51">51</a></span>
<span class="normal"><a href="#__codelineno-6-52">52</a></span>
<span class="normal"><a href="#__codelineno-6-53">53</a></span>
<span class="normal"><a href="#__codelineno-6-54">54</a></span>
<span class="normal"><a href="#__codelineno-6-55">55</a></span>
<span class="normal"><a href="#__codelineno-6-56">56</a></span>
<span class="normal"><a href="#__codelineno-6-57">57</a></span>
<span class="normal"><a href="#__codelineno-6-58">58</a></span>
<span class="normal"><a href="#__codelineno-6-59">59</a></span>
<span class="normal"><a href="#__codelineno-6-60">60</a></span>
<span class="normal"><a href="#__codelineno-6-61">61</a></span>
<span class="normal"><a href="#__codelineno-6-62">62</a></span>
<span class="normal"><a href="#__codelineno-6-63">63</a></span>
<span class="normal"><a href="#__codelineno-6-64">64</a></span>
<span class="normal"><a href="#__codelineno-6-65">65</a></span>
<span class="normal"><a href="#__codelineno-6-66">66</a></span>
<span class="normal"><a href="#__codelineno-6-67">67</a></span>
<span class="normal"><a href="#__codelineno-6-68">68</a></span>
<span class="normal"><a href="#__codelineno-6-69">69</a></span>
<span class="normal"><a href="#__codelineno-6-70">70</a></span>
<span class="normal"><a href="#__codelineno-6-71">71</a></span>
<span class="normal"><a href="#__codelineno-6-72">72</a></span>
<span class="normal"><a href="#__codelineno-6-73">73</a></span>
<span class="normal"><a href="#__codelineno-6-74">74</a></span>
<span class="normal"><a href="#__codelineno-6-75">75</a></span>
<span class="normal"><a href="#__codelineno-6-76">76</a></span>
<span class="normal"><a href="#__codelineno-6-77">77</a></span>
<span class="normal"><a href="#__codelineno-6-78">78</a></span>
<span class="normal"><a href="#__codelineno-6-79">79</a></span>
<span class="normal"><a href="#__codelineno-6-80">80</a></span>
<span class="normal"><a href="#__codelineno-6-81">81</a></span>
<span class="normal"><a href="#__codelineno-6-82">82</a></span>
<span class="normal"><a href="#__codelineno-6-83">83</a></span>
<span class="normal"><a href="#__codelineno-6-84">84</a></span>
<span class="normal"><a href="#__codelineno-6-85">85</a></span>
<span class="normal"><a href="#__codelineno-6-86">86</a></span>
<span class="normal"><a href="#__codelineno-6-87">87</a></span>
<span class="normal"><a href="#__codelineno-6-88">88</a></span>
<span class="normal"><a href="#__codelineno-6-89">89</a></span>
<span class="normal"><a href="#__codelineno-6-90">90</a></span>
<span class="normal"><a href="#__codelineno-6-91">91</a></span>
<span class="normal"><a href="#__codelineno-6-92">92</a></span>
<span class="normal"><a href="#__codelineno-6-93">93</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Gather Facts</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">127.0.0.1</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="w">  </span><span class="nt">connection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">include_vars</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myvars.yml</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Download Yq</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="w">      </span><span class="nt">ansible.builtin.get_url</span><span class="p">:</span>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">yq_url</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/yq</span>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">        </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;755&#39;</span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Calculate MD5</span>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="w">      </span><span class="nt">ansible.builtin.stat</span><span class="p">:</span>
<a id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/yq</span>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="w">        </span><span class="nt">checksum_algorithm</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">md5</span>
<a id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="w">      </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yq_md5</span>
<a id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Delete /tmp/yq</span>
<a id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="w">      </span><span class="nt">ansible.builtin.file</span><span class="p">:</span>
<a id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/yq</span>
<a id="__codelineno-6-19" name="__codelineno-6-19"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">absent</span>
<a id="__codelineno-6-20" name="__codelineno-6-20"></a>
<a id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pve-kube02</span>
<a id="__codelineno-6-22" name="__codelineno-6-22"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install</span>
<a id="__codelineno-6-23" name="__codelineno-6-23"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;yes&#39;</span>
<a id="__codelineno-6-24" name="__codelineno-6-24"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<a id="__codelineno-6-25" name="__codelineno-6-25"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">include_vars</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myvars.yml</span>
<a id="__codelineno-6-26" name="__codelineno-6-26"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run the equivalent of &quot;apt-get update&quot; as a separate step</span>
<a id="__codelineno-6-27" name="__codelineno-6-27"></a><span class="w">      </span><span class="nt">ansible.builtin.apt</span><span class="p">:</span>
<a id="__codelineno-6-28" name="__codelineno-6-28"></a><span class="w">        </span><span class="nt">update_cache</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id="__codelineno-6-29" name="__codelineno-6-29"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set Fact For YQ md5</span>
<a id="__codelineno-6-30" name="__codelineno-6-30"></a><span class="w">      </span><span class="nt">set_fact</span><span class="p">:</span>
<a id="__codelineno-6-31" name="__codelineno-6-31"></a><span class="w">        </span><span class="nt">yq_checksum</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">hostvars[&#39;127.0.0.1&#39;][&#39;yq_md5&#39;].stat.checksum</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-6-32" name="__codelineno-6-32"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">debug</span>
<a id="__codelineno-6-33" name="__codelineno-6-33"></a><span class="w">      </span><span class="nt">debug</span><span class="p">:</span>
<a id="__codelineno-6-34" name="__codelineno-6-34"></a><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;MD5</span><span class="nv"> </span><span class="s">hash</span><span class="nv"> </span><span class="s">:</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">yq_checksum</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-6-35" name="__codelineno-6-35"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ensure a list of packages installed</span>
<a id="__codelineno-6-36" name="__codelineno-6-36"></a><span class="w">      </span><span class="nt">ansible.builtin.apt</span><span class="p">:</span>
<a id="__codelineno-6-37" name="__codelineno-6-37"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">common_packages</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-6-38" name="__codelineno-6-38"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id="__codelineno-6-39" name="__codelineno-6-39"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">All done!</span>
<a id="__codelineno-6-40" name="__codelineno-6-40"></a><span class="w">      </span><span class="nt">debug</span><span class="p">:</span>
<a id="__codelineno-6-41" name="__codelineno-6-41"></a><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Packages have been successfully installed</span>
<a id="__codelineno-6-42" name="__codelineno-6-42"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Calculate Already Existing jq hash</span>
<a id="__codelineno-6-43" name="__codelineno-6-43"></a><span class="w">      </span><span class="nt">ansible.builtin.stat</span><span class="p">:</span>
<a id="__codelineno-6-44" name="__codelineno-6-44"></a><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/bin/yq</span>
<a id="__codelineno-6-45" name="__codelineno-6-45"></a><span class="w">        </span><span class="nt">checksum_algorithm</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">md5</span>
<a id="__codelineno-6-46" name="__codelineno-6-46"></a><span class="w">      </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">exist_yq_md5</span>
<a id="__codelineno-6-47" name="__codelineno-6-47"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Print Existing yq md5 hash</span>
<a id="__codelineno-6-48" name="__codelineno-6-48"></a><span class="w">      </span><span class="nt">debug</span><span class="p">:</span>
<a id="__codelineno-6-49" name="__codelineno-6-49"></a><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;MD5</span><span class="nv"> </span><span class="s">hash</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">existing</span><span class="nv"> </span><span class="s">:</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">exist_yq_md5.stat.checksum</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-6-50" name="__codelineno-6-50"></a><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">exist_yq_md5.stat.exists == true</span>
<a id="__codelineno-6-51" name="__codelineno-6-51"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Remove Old Version Of YQ</span>
<a id="__codelineno-6-52" name="__codelineno-6-52"></a><span class="w">      </span><span class="nt">ansible.builtin.file</span><span class="p">:</span>
<a id="__codelineno-6-53" name="__codelineno-6-53"></a><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/bin/yq</span>
<a id="__codelineno-6-54" name="__codelineno-6-54"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">absent</span>
<a id="__codelineno-6-55" name="__codelineno-6-55"></a><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">exist_yq_md5.stat.exists == false or exist_yq_md5.stat.checksum != yq_checksum</span>
<a id="__codelineno-6-56" name="__codelineno-6-56"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Download Yq</span>
<a id="__codelineno-6-57" name="__codelineno-6-57"></a><span class="w">      </span><span class="nt">ansible.builtin.get_url</span><span class="p">:</span>
<a id="__codelineno-6-58" name="__codelineno-6-58"></a><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">yq_url</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-6-59" name="__codelineno-6-59"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/bin/yq</span>
<a id="__codelineno-6-60" name="__codelineno-6-60"></a><span class="w">        </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;755&#39;</span>
<a id="__codelineno-6-61" name="__codelineno-6-61"></a><span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">exist_yq_md5.stat.exists == false or exist_yq_md5.stat.checksum != yq_checksum</span>
<a id="__codelineno-6-62" name="__codelineno-6-62"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Fix Vimrc</span>
<a id="__codelineno-6-63" name="__codelineno-6-63"></a><span class="w">      </span><span class="nt">ansible.builtin.replace</span><span class="p">:</span>
<a id="__codelineno-6-64" name="__codelineno-6-64"></a><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/vim/vimrc</span>
<a id="__codelineno-6-65" name="__codelineno-6-65"></a><span class="w">        </span><span class="nt">regexp</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;^&quot;\s?(let</span><span class="nv"> </span><span class="s">g:skip_defaults_vim.*)&#39;</span>
<a id="__codelineno-6-66" name="__codelineno-6-66"></a><span class="w">        </span><span class="nt">replace</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;\1&#39;</span>
<a id="__codelineno-6-67" name="__codelineno-6-67"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Fix Vimrc 2</span>
<a id="__codelineno-6-68" name="__codelineno-6-68"></a><span class="w">      </span><span class="nt">ansible.builtin.replace</span><span class="p">:</span>
<a id="__codelineno-6-69" name="__codelineno-6-69"></a><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/vim/vimrc</span>
<a id="__codelineno-6-70" name="__codelineno-6-70"></a><span class="w">        </span><span class="nt">regexp</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;^&quot;\s?(set</span><span class="nv"> </span><span class="s">compatible.*)&#39;</span>
<a id="__codelineno-6-71" name="__codelineno-6-71"></a><span class="w">        </span><span class="nt">replace</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;\1&#39;</span>
<a id="__codelineno-6-72" name="__codelineno-6-72"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Fix Vimrc 3</span>
<a id="__codelineno-6-73" name="__codelineno-6-73"></a><span class="w">      </span><span class="nt">ansible.builtin.replace</span><span class="p">:</span>
<a id="__codelineno-6-74" name="__codelineno-6-74"></a><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/vim/vimrc</span>
<a id="__codelineno-6-75" name="__codelineno-6-75"></a><span class="w">        </span><span class="nt">regexp</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;^&quot;\s?(set</span><span class="nv"> </span><span class="s">background).*&#39;</span>
<a id="__codelineno-6-76" name="__codelineno-6-76"></a><span class="w">        </span><span class="nt">replace</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;\1=dark&#39;</span>
<a id="__codelineno-6-77" name="__codelineno-6-77"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Fix Vimrc 4</span>
<a id="__codelineno-6-78" name="__codelineno-6-78"></a><span class="w">      </span><span class="nt">ansible.builtin.replace</span><span class="p">:</span>
<a id="__codelineno-6-79" name="__codelineno-6-79"></a><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/vim/vimrc</span>
<a id="__codelineno-6-80" name="__codelineno-6-80"></a><span class="w">        </span><span class="nt">regexp</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;^&quot;\s?(syntax</span><span class="nv"> </span><span class="s">on).*&#39;</span>
<a id="__codelineno-6-81" name="__codelineno-6-81"></a><span class="w">        </span><span class="nt">replace</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;\1&#39;</span>
<a id="__codelineno-6-82" name="__codelineno-6-82"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Fix Vimrc 4</span>
<a id="__codelineno-6-83" name="__codelineno-6-83"></a><span class="w">      </span><span class="nt">ansible.builtin.replace</span><span class="p">:</span>
<a id="__codelineno-6-84" name="__codelineno-6-84"></a><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/vim/vimrc</span>
<a id="__codelineno-6-85" name="__codelineno-6-85"></a><span class="w">        </span><span class="nt">regexp</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;^&quot;\s?(set</span><span class="nv"> </span><span class="s">mouse).*&#39;</span>
<a id="__codelineno-6-86" name="__codelineno-6-86"></a><span class="w">        </span><span class="nt">replace</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;\1=c&#39;</span>
<a id="__codelineno-6-87" name="__codelineno-6-87"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow &#39;sudo&#39; group to have passwordless sudo</span>
<a id="__codelineno-6-88" name="__codelineno-6-88"></a><span class="w">      </span><span class="nt">lineinfile</span><span class="p">:</span>
<a id="__codelineno-6-89" name="__codelineno-6-89"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/sudoers</span>
<a id="__codelineno-6-90" name="__codelineno-6-90"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id="__codelineno-6-91" name="__codelineno-6-91"></a><span class="w">        </span><span class="nt">regexp</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;^%sudo&#39;</span>
<a id="__codelineno-6-92" name="__codelineno-6-92"></a><span class="w">        </span><span class="nt">line</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;%sudo</span><span class="nv">   </span><span class="s">ALL=(ALL:ALL)</span><span class="nv"> </span><span class="s">NOPASSWD:ALL&#39;</span>
<a id="__codelineno-6-93" name="__codelineno-6-93"></a><span class="w">        </span><span class="nt">validate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">visudo -cf %s</span>
</code></pre></div></td></tr></table></div>
<p><strong>Run this playbook:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>ansible-playbook<span class="w"> </span>playbook-install-common-packages.yaml
</code></pre></div>
<h3 id="install-container-engine">Install Container Engine<a class="headerlink" href="#install-container-engine" title="Permanent link">&para;</a></h3>
<p><strong>playbook-install-docker.yaml</strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename"><a href="https://raw.githubusercontent.com/jvincze84/jvincze84.github.io/master/docs/files/kube-ans-tailscale/playbook-install-docker.yaml" target="_blank">Click Here For Raw Source</a></span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span>
<span class="normal"><a href="#__codelineno-8-14">14</a></span>
<span class="normal"><a href="#__codelineno-8-15">15</a></span>
<span class="normal"><a href="#__codelineno-8-16">16</a></span>
<span class="normal"><a href="#__codelineno-8-17">17</a></span>
<span class="normal"><a href="#__codelineno-8-18">18</a></span>
<span class="normal"><a href="#__codelineno-8-19">19</a></span>
<span class="normal"><a href="#__codelineno-8-20">20</a></span>
<span class="normal"><a href="#__codelineno-8-21">21</a></span>
<span class="normal"><a href="#__codelineno-8-22">22</a></span>
<span class="normal"><a href="#__codelineno-8-23">23</a></span>
<span class="normal"><a href="#__codelineno-8-24">24</a></span>
<span class="normal"><a href="#__codelineno-8-25">25</a></span>
<span class="normal"><a href="#__codelineno-8-26">26</a></span>
<span class="normal"><a href="#__codelineno-8-27">27</a></span>
<span class="normal"><a href="#__codelineno-8-28">28</a></span>
<span class="normal"><a href="#__codelineno-8-29">29</a></span>
<span class="normal"><a href="#__codelineno-8-30">30</a></span>
<span class="normal"><a href="#__codelineno-8-31">31</a></span>
<span class="normal"><a href="#__codelineno-8-32">32</a></span>
<span class="normal"><a href="#__codelineno-8-33">33</a></span>
<span class="normal"><a href="#__codelineno-8-34">34</a></span>
<span class="normal"><a href="#__codelineno-8-35">35</a></span>
<span class="normal"><a href="#__codelineno-8-36">36</a></span>
<span class="normal"><a href="#__codelineno-8-37">37</a></span>
<span class="normal"><a href="#__codelineno-8-38">38</a></span>
<span class="normal"><a href="#__codelineno-8-39">39</a></span>
<span class="normal"><a href="#__codelineno-8-40">40</a></span>
<span class="normal"><a href="#__codelineno-8-41">41</a></span>
<span class="normal"><a href="#__codelineno-8-42">42</a></span>
<span class="normal"><a href="#__codelineno-8-43">43</a></span>
<span class="normal"><a href="#__codelineno-8-44">44</a></span>
<span class="normal"><a href="#__codelineno-8-45">45</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pve-kube02</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;yes&#39;</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">include_vars</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myvars.yml</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">determine codeversion</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;lsb_release</span><span class="nv"> </span><span class="s">-cs&quot;</span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="w">      </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">release_output</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">set_fact</span><span class="p">:</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">        </span><span class="nt">codename</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">release_output.stdout</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run the equivalent of &quot;apt-get update&quot; as a separate step</span>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="w">      </span><span class="nt">ansible.builtin.apt</span><span class="p">:</span>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="w">        </span><span class="nt">update_cache</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">add Docker GPG key</span>
<a id="__codelineno-8-15" name="__codelineno-8-15"></a><span class="w">      </span><span class="nt">apt_key</span><span class="p">:</span>
<a id="__codelineno-8-16" name="__codelineno-8-16"></a><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://download.docker.com/linux/debian/gpg</span>
<a id="__codelineno-8-17" name="__codelineno-8-17"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id="__codelineno-8-18" name="__codelineno-8-18"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">add docker repository to apt</span>
<a id="__codelineno-8-19" name="__codelineno-8-19"></a><span class="w">      </span><span class="nt">apt_repository</span><span class="p">:</span>
<a id="__codelineno-8-20" name="__codelineno-8-20"></a><span class="w">        </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deb https://download.docker.com/linux/debian &quot;{{ codename }}&quot; stable</span>
<a id="__codelineno-8-21" name="__codelineno-8-21"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id="__codelineno-8-22" name="__codelineno-8-22"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">add tailscale gpg key</span>
<a id="__codelineno-8-23" name="__codelineno-8-23"></a><span class="w">      </span><span class="nt">apt_key</span><span class="p">:</span>
<a id="__codelineno-8-24" name="__codelineno-8-24"></a><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://pkgs.tailscale.com/stable/debian/bullseye.noarmor.gpg</span>
<a id="__codelineno-8-25" name="__codelineno-8-25"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id="__codelineno-8-26" name="__codelineno-8-26"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">add tailscale repository to apt</span>
<a id="__codelineno-8-27" name="__codelineno-8-27"></a><span class="w">      </span><span class="nt">apt_repository</span><span class="p">:</span>
<a id="__codelineno-8-28" name="__codelineno-8-28"></a><span class="w">        </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deb https://pkgs.tailscale.com/stable/debian &quot;{{ codename }}&quot; main</span>
<a id="__codelineno-8-29" name="__codelineno-8-29"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id="__codelineno-8-30" name="__codelineno-8-30"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install docker</span>
<a id="__codelineno-8-31" name="__codelineno-8-31"></a><span class="w">      </span><span class="nt">ansible.builtin.apt</span><span class="p">:</span>
<a id="__codelineno-8-32" name="__codelineno-8-32"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">docker_packages</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-8-33" name="__codelineno-8-33"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id="__codelineno-8-34" name="__codelineno-8-34"></a><span class="w">        </span><span class="nt">update_cache</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id="__codelineno-8-35" name="__codelineno-8-35"></a>
<a id="__codelineno-8-36" name="__codelineno-8-36"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install tailscale</span>
<a id="__codelineno-8-37" name="__codelineno-8-37"></a><span class="w">      </span><span class="nt">apt</span><span class="p">:</span>
<a id="__codelineno-8-38" name="__codelineno-8-38"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tailscale</span>
<a id="__codelineno-8-39" name="__codelineno-8-39"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">latest</span>
<a id="__codelineno-8-40" name="__codelineno-8-40"></a>
<a id="__codelineno-8-41" name="__codelineno-8-41"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">check if docker is started properly</span>
<a id="__codelineno-8-42" name="__codelineno-8-42"></a><span class="w">      </span><span class="nt">service</span><span class="p">:</span>
<a id="__codelineno-8-43" name="__codelineno-8-43"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker</span>
<a id="__codelineno-8-44" name="__codelineno-8-44"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">started</span>
<a id="__codelineno-8-45" name="__codelineno-8-45"></a><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
</code></pre></div></td></tr></table></div>
<p><strong>Run this playbook:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>ansible-playbook<span class="w"> </span>playbook-install-docker.yaml
</code></pre></div>
<h3 id="install-kubernetes-tools">Install Kubernetes Tools<a class="headerlink" href="#install-kubernetes-tools" title="Permanent link">&para;</a></h3>
<p><strong>playbook-install-kubernetes.yaml</strong></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename"><a href="https://raw.githubusercontent.com/jvincze84/jvincze84.github.io/master/docs/files/kube-ans-tailscale/playbook-install-kubernetes.yaml" target="_blank">Click Here For Raw Source</a></span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1">  1</a></span>
<span class="normal"><a href="#__codelineno-10-2">  2</a></span>
<span class="normal"><a href="#__codelineno-10-3">  3</a></span>
<span class="normal"><a href="#__codelineno-10-4">  4</a></span>
<span class="normal"><a href="#__codelineno-10-5">  5</a></span>
<span class="normal"><a href="#__codelineno-10-6">  6</a></span>
<span class="normal"><a href="#__codelineno-10-7">  7</a></span>
<span class="normal"><a href="#__codelineno-10-8">  8</a></span>
<span class="normal"><a href="#__codelineno-10-9">  9</a></span>
<span class="normal"><a href="#__codelineno-10-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-10-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-10-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-10-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-10-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-10-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-10-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-10-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-10-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-10-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-10-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-10-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-10-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-10-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-10-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-10-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-10-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-10-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-10-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-10-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-10-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-10-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-10-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-10-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-10-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-10-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-10-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-10-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-10-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-10-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-10-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-10-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-10-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-10-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-10-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-10-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-10-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-10-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-10-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-10-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-10-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-10-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-10-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-10-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-10-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-10-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-10-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-10-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-10-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-10-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-10-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-10-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-10-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-10-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-10-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-10-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-10-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-10-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-10-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-10-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-10-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-10-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-10-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-10-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-10-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-10-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-10-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-10-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-10-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-10-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-10-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-10-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-10-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-10-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-10-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-10-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-10-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-10-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-10-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-10-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-10-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-10-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-10-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-10-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-10-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-10-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-10-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-10-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-10-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-10-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-10-100">100</a></span>
<span class="normal"><a href="#__codelineno-10-101">101</a></span>
<span class="normal"><a href="#__codelineno-10-102">102</a></span>
<span class="normal"><a href="#__codelineno-10-103">103</a></span>
<span class="normal"><a href="#__codelineno-10-104">104</a></span>
<span class="normal"><a href="#__codelineno-10-105">105</a></span>
<span class="normal"><a href="#__codelineno-10-106">106</a></span>
<span class="normal"><a href="#__codelineno-10-107">107</a></span>
<span class="normal"><a href="#__codelineno-10-108">108</a></span>
<span class="normal"><a href="#__codelineno-10-109">109</a></span>
<span class="normal"><a href="#__codelineno-10-110">110</a></span>
<span class="normal"><a href="#__codelineno-10-111">111</a></span>
<span class="normal"><a href="#__codelineno-10-112">112</a></span>
<span class="normal"><a href="#__codelineno-10-113">113</a></span>
<span class="normal"><a href="#__codelineno-10-114">114</a></span>
<span class="normal"><a href="#__codelineno-10-115">115</a></span>
<span class="normal"><a href="#__codelineno-10-116">116</a></span>
<span class="normal"><a href="#__codelineno-10-117">117</a></span>
<span class="normal"><a href="#__codelineno-10-118">118</a></span>
<span class="normal"><a href="#__codelineno-10-119">119</a></span>
<span class="normal"><a href="#__codelineno-10-120">120</a></span>
<span class="normal"><a href="#__codelineno-10-121">121</a></span>
<span class="normal"><a href="#__codelineno-10-122">122</a></span>
<span class="normal"><a href="#__codelineno-10-123">123</a></span>
<span class="normal"><a href="#__codelineno-10-124">124</a></span>
<span class="normal"><a href="#__codelineno-10-125">125</a></span>
<span class="normal"><a href="#__codelineno-10-126">126</a></span>
<span class="normal"><a href="#__codelineno-10-127">127</a></span>
<span class="normal"><a href="#__codelineno-10-128">128</a></span>
<span class="normal"><a href="#__codelineno-10-129">129</a></span>
<span class="normal"><a href="#__codelineno-10-130">130</a></span>
<span class="normal"><a href="#__codelineno-10-131">131</a></span>
<span class="normal"><a href="#__codelineno-10-132">132</a></span>
<span class="normal"><a href="#__codelineno-10-133">133</a></span>
<span class="normal"><a href="#__codelineno-10-134">134</a></span>
<span class="normal"><a href="#__codelineno-10-135">135</a></span>
<span class="normal"><a href="#__codelineno-10-136">136</a></span>
<span class="normal"><a href="#__codelineno-10-137">137</a></span>
<span class="normal"><a href="#__codelineno-10-138">138</a></span>
<span class="normal"><a href="#__codelineno-10-139">139</a></span>
<span class="normal"><a href="#__codelineno-10-140">140</a></span>
<span class="normal"><a href="#__codelineno-10-141">141</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pve-kube02</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;yes&#39;</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">  </span><span class="nt">vars</span><span class="p">:</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">    </span><span class="nt">kubepackages</span><span class="p">:</span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubelet={{ kube_version }}</span>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeadm={{ kube_version }}</span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubectl={{ kube_version }}</span>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<a id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">include_vars</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myvars.yml</span>
<a id="__codelineno-10-11" name="__codelineno-10-11"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Register architecture (dpkg_output)</span>
<a id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;dpkg</span><span class="nv"> </span><span class="s">--print-architecture&quot;</span>
<a id="__codelineno-10-13" name="__codelineno-10-13"></a><span class="w">      </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dpkg_output</span>
<a id="__codelineno-10-14" name="__codelineno-10-14"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">set_fact</span><span class="p">:</span>
<a id="__codelineno-10-15" name="__codelineno-10-15"></a><span class="w">        </span><span class="nt">arch</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">dpkg_output.stdout</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-10-16" name="__codelineno-10-16"></a>
<a id="__codelineno-10-17" name="__codelineno-10-17"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Register lsb_release</span>
<a id="__codelineno-10-18" name="__codelineno-10-18"></a><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;lsb_release</span><span class="nv"> </span><span class="s">-cs&quot;</span>
<a id="__codelineno-10-19" name="__codelineno-10-19"></a><span class="w">      </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">release_output</span>
<a id="__codelineno-10-20" name="__codelineno-10-20"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">set_fact</span><span class="p">:</span>
<a id="__codelineno-10-21" name="__codelineno-10-21"></a><span class="w">        </span><span class="nt">codename</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">release_output.stdout</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-10-22" name="__codelineno-10-22"></a>
<a id="__codelineno-10-23" name="__codelineno-10-23"></a>
<a id="__codelineno-10-24" name="__codelineno-10-24"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Add Kubernetes gpg to keyring</span>
<a id="__codelineno-10-25" name="__codelineno-10-25"></a><span class="w">      </span><span class="nt">apt_key</span><span class="p">:</span>
<a id="__codelineno-10-26" name="__codelineno-10-26"></a><span class="w">        </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://packages.cloud.google.com/apt/doc/apt-key.gpg</span>
<a id="__codelineno-10-27" name="__codelineno-10-27"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id="__codelineno-10-28" name="__codelineno-10-28"></a>
<a id="__codelineno-10-29" name="__codelineno-10-29"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">add kubernetes repository to apt</span>
<a id="__codelineno-10-30" name="__codelineno-10-30"></a><span class="w">      </span><span class="nt">apt_repository</span><span class="p">:</span>
<a id="__codelineno-10-31" name="__codelineno-10-31"></a><span class="w">        </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deb https://apt.kubernetes.io/ kubernetes-xenial main</span>
<a id="__codelineno-10-32" name="__codelineno-10-32"></a>
<a id="__codelineno-10-33" name="__codelineno-10-33"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Disable SWAP since kubernetes can&#39;t work with swap enabled (1/2)</span>
<a id="__codelineno-10-34" name="__codelineno-10-34"></a><span class="w">      </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<a id="__codelineno-10-35" name="__codelineno-10-35"></a><span class="w">        </span><span class="no">swapoff -a</span>
<a id="__codelineno-10-36" name="__codelineno-10-36"></a>
<a id="__codelineno-10-37" name="__codelineno-10-37"></a>
<a id="__codelineno-10-38" name="__codelineno-10-38"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Disable SWAP in fstab since kubernetes can&#39;t work with swap enabled (2/2)</span>
<a id="__codelineno-10-39" name="__codelineno-10-39"></a><span class="w">      </span><span class="nt">replace</span><span class="p">:</span>
<a id="__codelineno-10-40" name="__codelineno-10-40"></a><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/fstab</span>
<a id="__codelineno-10-41" name="__codelineno-10-41"></a><span class="w">        </span><span class="nt">regexp</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;^([^#].*?\sswap\s+sw\s+.*)$&#39;</span>
<a id="__codelineno-10-42" name="__codelineno-10-42"></a><span class="w">        </span><span class="nt">replace</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;#</span><span class="nv"> </span><span class="s">\1&#39;</span>
<a id="__codelineno-10-43" name="__codelineno-10-43"></a>
<a id="__codelineno-10-44" name="__codelineno-10-44"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Enable overlay &amp; br_netfilter module</span>
<a id="__codelineno-10-45" name="__codelineno-10-45"></a><span class="w">      </span><span class="nt">ansible.builtin.copy</span><span class="p">:</span>
<a id="__codelineno-10-46" name="__codelineno-10-46"></a><span class="w">        </span><span class="nt">content</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<a id="__codelineno-10-47" name="__codelineno-10-47"></a><span class="w">          </span><span class="no">overlay</span>
<a id="__codelineno-10-48" name="__codelineno-10-48"></a><span class="w">          </span><span class="no">br_netfilter</span>
<a id="__codelineno-10-49" name="__codelineno-10-49"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/modules-load.d/k8s.conf</span>
<a id="__codelineno-10-50" name="__codelineno-10-50"></a>
<a id="__codelineno-10-51" name="__codelineno-10-51"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Running modprobe</span>
<a id="__codelineno-10-52" name="__codelineno-10-52"></a><span class="w">      </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<a id="__codelineno-10-53" name="__codelineno-10-53"></a><span class="w">        </span><span class="no">modprobe overlay</span>
<a id="__codelineno-10-54" name="__codelineno-10-54"></a><span class="w">        </span><span class="no">modprobe br_netfilter</span>
<a id="__codelineno-10-55" name="__codelineno-10-55"></a>
<a id="__codelineno-10-56" name="__codelineno-10-56"></a>
<a id="__codelineno-10-57" name="__codelineno-10-57"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set up sysctl /etc/sysctl.d/k8s.conf</span>
<a id="__codelineno-10-58" name="__codelineno-10-58"></a><span class="w">      </span><span class="nt">ansible.builtin.copy</span><span class="p">:</span>
<a id="__codelineno-10-59" name="__codelineno-10-59"></a><span class="w">        </span><span class="nt">content</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<a id="__codelineno-10-60" name="__codelineno-10-60"></a><span class="w">          </span><span class="no">net.bridge.bridge-nf-call-iptables  = 1</span>
<a id="__codelineno-10-61" name="__codelineno-10-61"></a><span class="w">          </span><span class="no">net.bridge.bridge-nf-call-ip6tables = 1</span>
<a id="__codelineno-10-62" name="__codelineno-10-62"></a><span class="w">          </span><span class="no">net.ipv4.ip_forward                 = 1</span>
<a id="__codelineno-10-63" name="__codelineno-10-63"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/sysctl.d/k8s.conf</span>
<a id="__codelineno-10-64" name="__codelineno-10-64"></a>
<a id="__codelineno-10-65" name="__codelineno-10-65"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Add the overlay module</span>
<a id="__codelineno-10-66" name="__codelineno-10-66"></a><span class="w">      </span><span class="nt">community.general.modprobe</span><span class="p">:</span>
<a id="__codelineno-10-67" name="__codelineno-10-67"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">overlay</span>
<a id="__codelineno-10-68" name="__codelineno-10-68"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id="__codelineno-10-69" name="__codelineno-10-69"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Add the br_netfilter module</span>
<a id="__codelineno-10-70" name="__codelineno-10-70"></a><span class="w">      </span><span class="nt">community.general.modprobe</span><span class="p">:</span>
<a id="__codelineno-10-71" name="__codelineno-10-71"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">br_netfilter</span>
<a id="__codelineno-10-72" name="__codelineno-10-72"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id="__codelineno-10-73" name="__codelineno-10-73"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sysctl</span>
<a id="__codelineno-10-74" name="__codelineno-10-74"></a><span class="w">      </span><span class="nt">ansible.builtin.shell</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;sysctl</span><span class="nv"> </span><span class="s">--system&quot;</span>
<a id="__codelineno-10-75" name="__codelineno-10-75"></a>
<a id="__codelineno-10-76" name="__codelineno-10-76"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Generate default containerd config</span>
<a id="__codelineno-10-77" name="__codelineno-10-77"></a><span class="w">      </span><span class="nt">ansible.builtin.shell</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;containerd</span><span class="nv"> </span><span class="s">config</span><span class="nv"> </span><span class="s">default</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">/etc/containerd/config.toml&quot;</span>
<a id="__codelineno-10-78" name="__codelineno-10-78"></a>
<a id="__codelineno-10-79" name="__codelineno-10-79"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Change /etc/containerd/config.toml file SystemdCgroup  to true</span>
<a id="__codelineno-10-80" name="__codelineno-10-80"></a><span class="w">      </span><span class="nt">ansible.builtin.replace</span><span class="p">:</span>
<a id="__codelineno-10-81" name="__codelineno-10-81"></a><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/containerd/config.toml</span>
<a id="__codelineno-10-82" name="__codelineno-10-82"></a><span class="w">        </span><span class="nt">after</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options&#39;</span>
<a id="__codelineno-10-83" name="__codelineno-10-83"></a><span class="w">        </span><span class="nt">before</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.untrusted_workload_runtime]&#39;</span>
<a id="__codelineno-10-84" name="__codelineno-10-84"></a><span class="w">        </span><span class="nt">regexp</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;SystemdCgroup.*&#39;</span>
<a id="__codelineno-10-85" name="__codelineno-10-85"></a><span class="w">        </span><span class="nt">replace</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;SystemdCgroup</span><span class="nv"> </span><span class="s">=</span><span class="nv"> </span><span class="s">true&#39;</span>
<a id="__codelineno-10-86" name="__codelineno-10-86"></a><span class="w">      </span><span class="nt">diff</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id="__codelineno-10-87" name="__codelineno-10-87"></a>
<a id="__codelineno-10-88" name="__codelineno-10-88"></a>
<a id="__codelineno-10-89" name="__codelineno-10-89"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run the equivalent of &quot;apt-get update&quot; as a separate step</span>
<a id="__codelineno-10-90" name="__codelineno-10-90"></a><span class="w">      </span><span class="nt">ansible.builtin.apt</span><span class="p">:</span>
<a id="__codelineno-10-91" name="__codelineno-10-91"></a><span class="w">        </span><span class="nt">update_cache</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id="__codelineno-10-92" name="__codelineno-10-92"></a>
<a id="__codelineno-10-93" name="__codelineno-10-93"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install Kubernetes Packages</span>
<a id="__codelineno-10-94" name="__codelineno-10-94"></a><span class="w">      </span><span class="nt">ansible.builtin.apt</span><span class="p">:</span>
<a id="__codelineno-10-95" name="__codelineno-10-95"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">kubepackages</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-10-96" name="__codelineno-10-96"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id="__codelineno-10-97" name="__codelineno-10-97"></a>
<a id="__codelineno-10-98" name="__codelineno-10-98"></a>
<a id="__codelineno-10-99" name="__codelineno-10-99"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prevent kubelet from being upgraded</span>
<a id="__codelineno-10-100" name="__codelineno-10-100"></a><span class="w">      </span><span class="nt">ansible.builtin.dpkg_selections</span><span class="p">:</span>
<a id="__codelineno-10-101" name="__codelineno-10-101"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubelet</span>
<a id="__codelineno-10-102" name="__codelineno-10-102"></a><span class="w">        </span><span class="nt">selection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hold</span>
<a id="__codelineno-10-103" name="__codelineno-10-103"></a>
<a id="__codelineno-10-104" name="__codelineno-10-104"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prevent kubeadm from being upgraded</span>
<a id="__codelineno-10-105" name="__codelineno-10-105"></a><span class="w">      </span><span class="nt">ansible.builtin.dpkg_selections</span><span class="p">:</span>
<a id="__codelineno-10-106" name="__codelineno-10-106"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeadm</span>
<a id="__codelineno-10-107" name="__codelineno-10-107"></a><span class="w">        </span><span class="nt">selection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hold</span>
<a id="__codelineno-10-108" name="__codelineno-10-108"></a>
<a id="__codelineno-10-109" name="__codelineno-10-109"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prevent kubectl from being upgraded</span>
<a id="__codelineno-10-110" name="__codelineno-10-110"></a><span class="w">      </span><span class="nt">ansible.builtin.dpkg_selections</span><span class="p">:</span>
<a id="__codelineno-10-111" name="__codelineno-10-111"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubectl</span>
<a id="__codelineno-10-112" name="__codelineno-10-112"></a><span class="w">        </span><span class="nt">selection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hold</span>
<a id="__codelineno-10-113" name="__codelineno-10-113"></a>
<a id="__codelineno-10-114" name="__codelineno-10-114"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prevent containerd.io from being upgraded</span>
<a id="__codelineno-10-115" name="__codelineno-10-115"></a><span class="w">      </span><span class="nt">ansible.builtin.dpkg_selections</span><span class="p">:</span>
<a id="__codelineno-10-116" name="__codelineno-10-116"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">containerd.io</span>
<a id="__codelineno-10-117" name="__codelineno-10-117"></a><span class="w">        </span><span class="nt">selection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hold</span>
<a id="__codelineno-10-118" name="__codelineno-10-118"></a>
<a id="__codelineno-10-119" name="__codelineno-10-119"></a>
<a id="__codelineno-10-120" name="__codelineno-10-120"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FIX CRICTRL error</span>
<a id="__codelineno-10-121" name="__codelineno-10-121"></a><span class="w">      </span><span class="nt">ansible.builtin.copy</span><span class="p">:</span>
<a id="__codelineno-10-122" name="__codelineno-10-122"></a><span class="w">        </span><span class="nt">content</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<a id="__codelineno-10-123" name="__codelineno-10-123"></a><span class="w">          </span><span class="no">runtime-endpoint: unix:///run/containerd/containerd.sock</span>
<a id="__codelineno-10-124" name="__codelineno-10-124"></a><span class="w">          </span><span class="no">image-endpoint: unix:///run/containerd/containerd.sock</span>
<a id="__codelineno-10-125" name="__codelineno-10-125"></a><span class="w">          </span><span class="no">timeout: 2</span>
<a id="__codelineno-10-126" name="__codelineno-10-126"></a><span class="w">          </span><span class="no">debug: false</span>
<a id="__codelineno-10-127" name="__codelineno-10-127"></a><span class="w">          </span><span class="no">pull-image-on-create: false</span>
<a id="__codelineno-10-128" name="__codelineno-10-128"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/crictl.yaml</span>
<a id="__codelineno-10-129" name="__codelineno-10-129"></a>
<a id="__codelineno-10-130" name="__codelineno-10-130"></a>
<a id="__codelineno-10-131" name="__codelineno-10-131"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Restart service cron on centos, in all cases, also issue daemon-reload to pick up config changes</span>
<a id="__codelineno-10-132" name="__codelineno-10-132"></a><span class="w">      </span><span class="nt">ansible.builtin.systemd</span><span class="p">:</span>
<a id="__codelineno-10-133" name="__codelineno-10-133"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restarted</span>
<a id="__codelineno-10-134" name="__codelineno-10-134"></a><span class="w">        </span><span class="nt">daemon_reload</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-10-135" name="__codelineno-10-135"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">containerd</span>
<a id="__codelineno-10-136" name="__codelineno-10-136"></a>
<a id="__codelineno-10-137" name="__codelineno-10-137"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install docker-compose from official github repo</span>
<a id="__codelineno-10-138" name="__codelineno-10-138"></a><span class="w">      </span><span class="nt">get_url</span><span class="p">:</span>
<a id="__codelineno-10-139" name="__codelineno-10-139"></a><span class="w">        </span><span class="nt">url </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/docker/compose/releases/download/v2.15.1/docker-compose-linux-x86_64</span>
<a id="__codelineno-10-140" name="__codelineno-10-140"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/local/bin/docker-compose</span>
<a id="__codelineno-10-141" name="__codelineno-10-141"></a><span class="w">        </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;u+x,g+x&#39;</span>
</code></pre></div></td></tr></table></div>
<p><strong>Run this playbook:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>ansible-playbook<span class="w"> </span>playbook-install-kubernetes.yaml
</code></pre></div>
<p>Now we have 3 identical nodes which are waiting for us to install &amp; configure Tailscale VPN and Kubernetes cluster.</p>
<p>Before we proceed, I would like to advise you some really useful links and tips. These are helpful especially if you are not familiar with Ansible and don't want to bother with that:</p>
<ul>
<li>Update OS: <code>apt-get update --allow-releaseinfo-change</code> &amp;&amp; <code>apt-get upgrade</code></li>
<li>Common Packages: You can install all necessary packages with <code>apt-get install</code> command.</li>
<li><a href="https://docs.docker.com/engine/install/debian/">Install Container Engine</a></li>
<li><a href="https://tailscale.com/download/linux">Install Tailscale</a></li>
<li><strong>Install Kubernetes:</strong><ul>
<li><a href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/">container-runtimes</a></li>
<li><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">install-kubeadm</a></li>
<li><a href="https://kubernetes.io/docs/tasks/debug/debug-cluster/crictl/#general-usage">crictl</a></li>
<li><a href="https://github.com/kubernetes-sigs/cri-tools/blob/master/docs/crictl.md">crictl usage</a></li>
</ul>
</li>
</ul>
<p>If you follow these links you should be able to install everything without Ansible.</p>
<h2 id="tailscale-vpn">Tailscale VPN<a class="headerlink" href="#tailscale-vpn" title="Permanent link">&para;</a></h2>
<p>I assume that Tailscale is successfully  installed on every node.
Before you begin please register a free account: <a href="https://login.tailscale.com/start">Tailscale</a></p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>I recommend you to enable "<a href="https://login.tailscale.com/admin/dns">MagicDNS</a>" on the Tailscale web interface. </p>
</div>
<p>Run the following command on all 4 nodes (kube0-m[1,2,3] and kube02-haproxy):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>tailscale<span class="w"> </span>up<span class="w"> </span>--accept-dns<span class="o">=</span><span class="nb">true</span>
</code></pre></div>
<p>Check if all your nodes have VPN IP address:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>root@kube02-m3:~# tailscale status | grep kube02
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>100.124.70.97   kube02-m3            jvincze84@   linux   -
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>100.121.89.125  kube02-haproxy       jvincze84@   linux   -
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>100.122.123.2   kube02-m1            jvincze84@   linux   -
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>100.103.128.9   kube02-m2            jvincze84@   linux   -
</code></pre></div>
<p><strong>Try ping:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>root@kube02-m3:~# ping kube02-m1
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>PING kube02-m1.tailnet-a5cd.ts.net (100.122.123.2) 56(84) bytes of data.
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>64 bytes from kube02-m1.tailnet-a5cd.ts.net (100.122.123.2): icmp_seq=1 ttl=64 time=1.33 ms
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>64 bytes from kube02-m1.tailnet-a5cd.ts.net (100.122.123.2): icmp_seq=2 ttl=64 time=0.976 ms
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>^C
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>--- kube02-m1.tailnet-a5cd.ts.net ping statistics ---
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>2 packets transmitted, 2 received, 0% packet loss, time 1001ms
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>rtt min/avg/max/mdev = 0.976/1.151/1.327/0.175 ms
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>root@kube02-m3:~# ping kube02-m2
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>PING kube02-m2.tailnet-a5cd.ts.net (100.103.128.9) 56(84) bytes of data.
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>64 bytes from kube02-m2.tailnet-a5cd.ts.net (100.103.128.9): icmp_seq=1 ttl=64 time=1.49 ms
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>64 bytes from kube02-m2.tailnet-a5cd.ts.net (100.103.128.9): icmp_seq=2 ttl=64 time=1.06 ms
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>^C
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a>--- kube02-m2.tailnet-a5cd.ts.net ping statistics ---
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>2 packets transmitted, 2 received, 0% packet loss, time 1000ms
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>rtt min/avg/max/mdev = 1.055/1.272/1.490/0.217 ms
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>root@kube02-m3:~# ping kube02-haproxy
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>PING kube02-haproxy.tailnet-a5cd.ts.net (100.121.89.125) 56(84) bytes of data.
<a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a>64 bytes from kube02-haproxy.tailnet-a5cd.ts.net (100.121.89.125): icmp_seq=1 ttl=64 time=1.27 ms
<a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a>^C
<a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a>--- kube02-haproxy.tailnet-a5cd.ts.net ping statistics ---
<a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a>1 packets transmitted, 1 received, 0% packet loss, time 0ms
<a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a>rtt min/avg/max/mdev = 1.269/1.269/1.269/0.000 ms
</code></pre></div>
<p>It seems that everything is fine.</p>
<p>Now check <code>tailscale status</code> command again:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>root@kube02-m3:~# tailscale status | grep kube02
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>100.124.70.97   kube02-m3            jvincze84@   linux   -
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>100.121.89.125  kube02-haproxy       jvincze84@   linux   active; direct 172.16.1.80:41641, tx 468 rx 348
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>100.122.123.2   kube02-m1            jvincze84@   linux   active; direct 172.16.1.77:41641, tx 724 rx 604
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>100.103.128.9   kube02-m2            jvincze84@   linux   active; direct 172.16.1.78:41641, tx 596 rx 476
</code></pre></div>
<p>After you connect to a host, the status command will show extra information: <code>active; direct 172.16.1.80:41641, tx 468 rx 348</code></p>
<h4 id="updated-ip-address-table">Updated IP Address Table<a class="headerlink" href="#updated-ip-address-table" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left;">Hostname</th>
<th style="text-align: left;">Role</th>
<th style="text-align: left;">IP Address</th>
<th style="text-align: left;">VPN IP Address</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">kube02-m1</td>
<td style="text-align: left;">Control Plane Node 1</td>
<td style="text-align: left;">172.16.1.77</td>
<td style="text-align: left;"><strong>100.122.123.2</strong></td>
</tr>
<tr>
<td style="text-align: left;">kube02-m2</td>
<td style="text-align: left;">Control Plane Node 2</td>
<td style="text-align: left;">172.16.1.78</td>
<td style="text-align: left;"><strong>100.103.128.9</strong></td>
</tr>
<tr>
<td style="text-align: left;">kube02-m3</td>
<td style="text-align: left;">Control Plane Node 3</td>
<td style="text-align: left;">172.16.1.79</td>
<td style="text-align: left;"><strong>100.124.70.97</strong></td>
</tr>
<tr>
<td style="text-align: left;">kube02-haproxy</td>
<td style="text-align: left;">HAProxy Load Balancer</td>
<td style="text-align: left;">172.16.1.80</td>
<td style="text-align: left;"><strong>100.121.89.125</strong></td>
</tr>
<tr>
<td style="text-align: left;">ansible</td>
<td style="text-align: left;">Ansible Host</td>
<td style="text-align: left;">172.16.0.252</td>
<td style="text-align: left;">---</td>
</tr>
</tbody>
</table>
<h3 id="optional-disable-direct-access">(Optional) Disable Direct Access<a class="headerlink" href="#optional-disable-direct-access" title="Permanent link">&para;</a></h3>
<p>This step is optional. I want to simulate the situation when the nodes are not sitting in the same subnet, and can talk to each other only over the Tailscale VPN.
This way maybe easier to understand what we doing with the VPN.</p>
<p>I don't want to make it complicated, so simply disable the communication between node with iptables.</p>
<p><strong>kube02-m1</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>iptables<span class="w"> </span>-I<span class="w"> </span>INPUT<span class="w"> </span>-s<span class="w"> </span><span class="m">172</span>.16.1.78<span class="w"> </span>-j<span class="w"> </span>DROP
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>iptables<span class="w"> </span>-I<span class="w"> </span>INPUT<span class="w"> </span>-s<span class="w"> </span><span class="m">172</span>.16.1.79<span class="w"> </span>-j<span class="w"> </span>DROP
</code></pre></div>
<p><strong>kube02-m2</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>iptables<span class="w"> </span>-I<span class="w"> </span>INPUT<span class="w"> </span>-s<span class="w"> </span><span class="m">172</span>.16.1.77<span class="w"> </span>-j<span class="w"> </span>DROP
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>iptables<span class="w"> </span>-I<span class="w"> </span>INPUT<span class="w"> </span>-s<span class="w"> </span><span class="m">172</span>.16.1.79<span class="w"> </span>-j<span class="w"> </span>DROP
</code></pre></div>
<p><strong>kube02-m3</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>iptables<span class="w"> </span>-I<span class="w"> </span>INPUT<span class="w"> </span>-s<span class="w"> </span><span class="m">172</span>.16.1.77<span class="w"> </span>-j<span class="w"> </span>DROP
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>iptables<span class="w"> </span>-I<span class="w"> </span>INPUT<span class="w"> </span>-s<span class="w"> </span><span class="m">172</span>.16.1.78<span class="w"> </span>-j<span class="w"> </span>DROP
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These rules are not permanent. So, if you restart the machine you should apply them again.</p>
</div>
<p><strong>Check the Tailscale Connection</strong></p>
<p>Don't forget the ping hosts before the <code>tailscale status</code> command.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>root@kube02-m1:~# tailscale status | grep kube02-m
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>100.122.123.2   kube02-m1            jvincze84@   linux   -
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>100.103.128.9   kube02-m2            jvincze84@   linux   active; relay &quot;fra&quot;, tx 308 rx 220
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>100.124.70.97   kube02-m3            jvincze84@   linux   active; relay &quot;waw&quot;, tx 308 rx 220
</code></pre></div>
<p>Now you can see that the hosts are connected to each other via relay servers (<code>active; relay "fra", tx 308 rx 22</code>) provided by Tailscale.</p>
<p>To see the available relays, run the <code>tailscale netcheck</code> command.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>root@kube02-m1:~#<span class="w"> </span>tailscale<span class="w"> </span>netcheck
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>Report:
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w">        </span>*<span class="w"> </span>UDP:<span class="w"> </span><span class="nb">true</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="w">        </span>*<span class="w"> </span>IPv4:<span class="w"> </span>yes,<span class="w"> </span><span class="m">176</span>.*.*.107:58839
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="w">        </span>*<span class="w"> </span>IPv6:<span class="w"> </span>no,<span class="w"> </span>but<span class="w"> </span>OS<span class="w"> </span>has<span class="w"> </span>support
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="w">        </span>*<span class="w"> </span>MappingVariesByDestIP:<span class="w"> </span><span class="nb">false</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="w">        </span>*<span class="w"> </span>HairPinning:<span class="w"> </span><span class="nb">false</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="w">        </span>*<span class="w"> </span>PortMapping:
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="w">        </span>*<span class="w"> </span>Nearest<span class="w"> </span>DERP:<span class="w"> </span>Frankfurt
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="w">        </span>*<span class="w"> </span>DERP<span class="w"> </span>latency:
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="w">                </span>-<span class="w"> </span>fra:<span class="w"> </span><span class="m">18</span>.4ms<span class="w">  </span><span class="o">(</span>Frankfurt<span class="o">)</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="w">                </span>-<span class="w"> </span>waw:<span class="w"> </span><span class="m">19</span>.6ms<span class="w">  </span><span class="o">(</span>Warsaw<span class="o">)</span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="w">                </span>-<span class="w"> </span>ams:<span class="w"> </span><span class="m">25</span>.1ms<span class="w">  </span><span class="o">(</span>Amsterdam<span class="o">)</span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="w">                </span>-<span class="w"> </span>par:<span class="w"> </span>32ms<span class="w">    </span><span class="o">(</span>Paris<span class="o">)</span>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="w">                </span>-<span class="w"> </span>mad:<span class="w"> </span><span class="m">44</span>.7ms<span class="w">  </span><span class="o">(</span>Madrid<span class="o">)</span>
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a><span class="w">                </span>-<span class="w"> </span>lhr:<span class="w"> </span><span class="m">59</span>.5ms<span class="w">  </span><span class="o">(</span>London<span class="o">)</span>
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a><span class="w">                </span>-<span class="w"> </span>nyc:<span class="w"> </span><span class="m">119</span>.4ms<span class="w"> </span><span class="o">(</span>New<span class="w"> </span>York<span class="w"> </span>City<span class="o">)</span>
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a><span class="w">                </span>-<span class="w"> </span>tor:<span class="w"> </span><span class="m">119</span>.5ms<span class="w"> </span><span class="o">(</span>Toronto<span class="o">)</span>
<a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a><span class="w">                </span>-<span class="w"> </span>ord:<span class="w"> </span><span class="m">119</span>.9ms<span class="w"> </span><span class="o">(</span>Chicago<span class="o">)</span>
<a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a><span class="w">                </span>-<span class="w"> </span>dbi:<span class="w"> </span><span class="m">130</span>.8ms<span class="w"> </span><span class="o">(</span>Dubai<span class="o">)</span>
<a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a><span class="w">                </span>-<span class="w"> </span>mia:<span class="w"> </span><span class="m">132</span>.8ms<span class="w"> </span><span class="o">(</span>Miami<span class="o">)</span>
<a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a><span class="w">                </span>-<span class="w"> </span>den:<span class="w"> </span><span class="m">140</span>.8ms<span class="w"> </span><span class="o">(</span>Denver<span class="o">)</span>
<a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a><span class="w">                </span>-<span class="w"> </span>dfw:<span class="w"> </span><span class="m">145</span>.8ms<span class="w"> </span><span class="o">(</span>Dallas<span class="o">)</span>
<a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a><span class="w">                </span>-<span class="w"> </span>sfo:<span class="w"> </span><span class="m">166</span>.8ms<span class="w"> </span><span class="o">(</span>San<span class="w"> </span>Francisco<span class="o">)</span>
<a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a><span class="w">                </span>-<span class="w"> </span>lax:<span class="w"> </span><span class="m">170</span>.1ms<span class="w"> </span><span class="o">(</span>Los<span class="w"> </span>Angeles<span class="o">)</span>
<a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a><span class="w">                </span>-<span class="w"> </span>sin:<span class="w"> </span><span class="m">170</span>.5ms<span class="w"> </span><span class="o">(</span>Singapore<span class="o">)</span>
<a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a><span class="w">                </span>-<span class="w"> </span>sea:<span class="w"> </span><span class="m">177</span>.8ms<span class="w"> </span><span class="o">(</span>Seattle<span class="o">)</span>
<a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a><span class="w">                </span>-<span class="w"> </span>blr:<span class="w"> </span><span class="m">193</span>.9ms<span class="w"> </span><span class="o">(</span>Bangalore<span class="o">)</span>
<a id="__codelineno-20-30" name="__codelineno-20-30" href="#__codelineno-20-30"></a><span class="w">                </span>-<span class="w"> </span>jnb:<span class="w"> </span><span class="m">198</span>.7ms<span class="w"> </span><span class="o">(</span>Johannesburg<span class="o">)</span>
<a id="__codelineno-20-31" name="__codelineno-20-31" href="#__codelineno-20-31"></a><span class="w">                </span>-<span class="w"> </span>hkg:<span class="w"> </span>209ms<span class="w">   </span><span class="o">(</span>Hong<span class="w"> </span>Kong<span class="o">)</span>
<a id="__codelineno-20-32" name="__codelineno-20-32" href="#__codelineno-20-32"></a><span class="w">                </span>-<span class="w"> </span>sao:<span class="w"> </span><span class="m">214</span>.5ms<span class="w"> </span><span class="o">(</span>So<span class="w"> </span>Paulo<span class="o">)</span>
<a id="__codelineno-20-33" name="__codelineno-20-33" href="#__codelineno-20-33"></a><span class="w">                </span>-<span class="w"> </span>hnl:<span class="w"> </span><span class="m">215</span>.8ms<span class="w"> </span><span class="o">(</span>Honolulu<span class="o">)</span>
<a id="__codelineno-20-34" name="__codelineno-20-34" href="#__codelineno-20-34"></a><span class="w">                </span>-<span class="w"> </span>syd:<span class="w">         </span><span class="o">(</span>Sydney<span class="o">)</span>
<a id="__codelineno-20-35" name="__codelineno-20-35" href="#__codelineno-20-35"></a><span class="w">                </span>-<span class="w"> </span>tok:<span class="w">         </span><span class="o">(</span>Tokyo<span class="o">)</span>
<a id="__codelineno-20-36" name="__codelineno-20-36" href="#__codelineno-20-36"></a>root@kube02-m1:~#
</code></pre></div>
<p>This is one of my favorite feature of Tailscale. You don't have to have stable static public IP address to use VPN service.
But keep in mind, that connection over relay server can be significantly slower than direct connection. </p>
<h2 id="init-the-cluster">Init The Cluster<a class="headerlink" href="#init-the-cluster" title="Permanent link">&para;</a></h2>
<h3 id="prepare-kubelet">Prepare Kubelet<a class="headerlink" href="#prepare-kubelet" title="Permanent link">&para;</a></h3>
<p>Before you do anything, prepare the kubelet to use Tailscale VPN IP address as node IP address. </p>
<p>Run this command on all Kubernetes nodes:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;KUBELET_EXTRA_ARGS=--node-ip=</span><span class="k">$(</span>tailscale<span class="w"> </span>ip<span class="w"> </span>--4<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/etc/default/kubelet
</code></pre></div>
<details class="example">
<summary>Example Commands:</summary>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>root@kube02-m1:~# echo &quot;KUBELET_EXTRA_ARGS=--node-ip=$(tailscale ip --4)&quot; | tee -a /etc/default/kubelet
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>KUBELET_EXTRA_ARGS=--node-ip=100.122.123.2
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>root@kube02-m1:~#
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>root@kube02-m2:~# echo &quot;KUBELET_EXTRA_ARGS=--node-ip=$(tailscale ip --4)&quot; | tee -a /etc/default/kubelet
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>KUBELET_EXTRA_ARGS=--node-ip=100.103.128.9
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>root@kube02-m2:~#
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>root@kube02-m3:~# echo &quot;KUBELET_EXTRA_ARGS=--node-ip=$(tailscale ip --4)&quot; | tee -a /etc/default/kubelet
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>KUBELET_EXTRA_ARGS=--node-ip=100.124.70.97
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>root@kube02-m3:~#
</code></pre></div>
</details>
<h3 id="prepare-the-load-balancer">Prepare The Load Balancer<a class="headerlink" href="#prepare-the-load-balancer" title="Permanent link">&para;</a></h3>
<p>I won't want to waste a lot time for this task, since this is only a lab env with just one function: demonstrate the installation.
HAProxy is a really good example about how to configure an external Load Balancer for kubernetes control plane nodes. </p>
<p><strong>Check if MagicDNS is working fine</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>root@kube02-haproxy:~#<span class="w"> </span>nslookup<span class="w"> </span>kube02-m1
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>Server:<span class="w">         </span><span class="m">100</span>.100.100.100
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>Address:<span class="w">        </span><span class="m">100</span>.100.100.100#53
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>Name:<span class="w">   </span>kube02-m1.tailnet-a5cd.ts.net
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>Address:<span class="w"> </span><span class="m">100</span>.122.123.2
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>root@kube02-haproxy:~#<span class="w"> </span>nslookup<span class="w"> </span>kube02-m2
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>Server:<span class="w">         </span><span class="m">100</span>.100.100.100
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>Address:<span class="w">        </span><span class="m">100</span>.100.100.100#53
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>Name:<span class="w">   </span>kube02-m2.tailnet-a5cd.ts.net
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>Address:<span class="w"> </span><span class="m">100</span>.103.128.9
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>root@kube02-haproxy:~#<span class="w"> </span>nslookup<span class="w"> </span>kube02-m3
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a>Server:<span class="w">         </span><span class="m">100</span>.100.100.100
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>Address:<span class="w">        </span><span class="m">100</span>.100.100.100#53
<a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a>
<a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a>Name:<span class="w">   </span>kube02-m3.tailnet-a5cd.ts.net
<a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a>Address:<span class="w"> </span><span class="m">100</span>.124.70.97
</code></pre></div>
<p><strong>/etc/haproxy.conf</strong> config file:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>frontend kubeapi
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>  log global
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>  bind *:6443
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>  mode tcp
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>  option tcplog
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>  default_backend kubecontroleplain
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>backend kubecontroleplain
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>  option httpchk GET /healthz
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>  http-check expect status 200
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a>  mode tcp
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a>  log global
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a>  balance roundrobin
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a>  #option tcp-check
<a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a>  option ssl-hello-chk
<a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a>  server kube02-m1 kube02-m1.tailnet-a5cd.ts.net:6443 check
<a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a>  server kube02-m2 kube02-m2.tailnet-a5cd.ts.net:6443 check
<a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a>  server kube02-m3 kube02-m3.tailnet-a5cd.ts.net:6443 check
<a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a>
<a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a>
<a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a>frontend stats
<a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a>    mode http
<a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a>    bind *:8404
<a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a>    stats enable
<a id="__codelineno-24-25" name="__codelineno-24-25" href="#__codelineno-24-25"></a>    stats uri /stats
<a id="__codelineno-24-26" name="__codelineno-24-26" href="#__codelineno-24-26"></a>    stats refresh 10s
<a id="__codelineno-24-27" name="__codelineno-24-27" href="#__codelineno-24-27"></a>    stats admin if LOCALHOST
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>As I know HAProxy resolve DNS only once at startup. So use DNS name in <code>server</code> section with caution. If the IP address has changed, do not forget to restart HAProxy.</p>
</div>
<p>Run <code>HAProxy</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>docker<span class="w"> </span>run<span class="w"> </span>--name<span class="w"> </span>haproxy<span class="w"> </span>-d<span class="w"> </span>-p<span class="w"> </span><span class="m">6443</span>:6443<span class="w"> </span>-p<span class="w"> </span><span class="m">8404</span>:8404<span class="w"> </span>-v<span class="w"> </span>/etc/haproxy.conf:/usr/local/etc/haproxy/haproxy.cfg<span class="w"> </span>haproxy
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p><code>*.tailnet-a5cd.ts.net</code> is my MagicDNS name.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you are looking for a solution without external Load Balancer you may want to take a look at <a href="https://kube-vip.io">Kube-Vip</a></p>
<details class="quote">
<summary>Quote</summary>
<p>kube-vip provides Kubernetes clusters with a virtual IP and load balancer for both the control plane (for building a highly-available cluster) and Kubernetes Services of type LoadBalancer without relying on any external hardware or software.</p>
</details>
</div>
<h3 id="init-the-first-control-plane-node">Init The First Control Plane Node<a class="headerlink" href="#init-the-first-control-plane-node" title="Permanent link">&para;</a></h3>
<p>The command:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>kubeadm<span class="w"> </span>init<span class="w"> </span>--cri-socket<span class="w"> </span>/var/run/containerd/containerd.sock<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>--control-plane-endpoint<span class="w"> </span>kube02-haproxy.tailnet-a5cd.ts.net<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>--apiserver-advertise-address<span class="w"> </span><span class="k">$(</span>tailscale<span class="w"> </span>ip<span class="w"> </span>--4<span class="k">)</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>--pod-network-cidr<span class="w"> </span><span class="m">10</span>.25.0.0/16<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>--service-cidr<span class="w"> </span><span class="m">10</span>.26.0.0/16<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>--upload-certs
</code></pre></div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>If you don't have separate HAProxy node, and you are using one kubernetes node, you should consider changing the <code>--apiserver-bind-port</code> port or the listen port of the HAProxy.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p><code>pod-network-cidr</code> and <code>service-cidr</code> is required by flannel CNI. </p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Do not forget the <code>--upload-certs</code> option, otherwise additional control plane nodes won't be able to join the cluster without extra steps.</p>
</div>
<details class="example">
<summary>Command Output</summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-27-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-27-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-27-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-27-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-27-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-27-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-27-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-27-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-27-10">10</a></span>
<span class="normal"><a href="#__codelineno-27-11">11</a></span>
<span class="normal"><a href="#__codelineno-27-12">12</a></span>
<span class="normal"><a href="#__codelineno-27-13">13</a></span>
<span class="normal"><a href="#__codelineno-27-14">14</a></span>
<span class="normal"><a href="#__codelineno-27-15">15</a></span>
<span class="normal"><a href="#__codelineno-27-16">16</a></span>
<span class="normal"><a href="#__codelineno-27-17">17</a></span>
<span class="normal"><a href="#__codelineno-27-18">18</a></span>
<span class="normal"><a href="#__codelineno-27-19">19</a></span>
<span class="normal"><a href="#__codelineno-27-20">20</a></span>
<span class="normal"><a href="#__codelineno-27-21">21</a></span>
<span class="normal"><a href="#__codelineno-27-22">22</a></span>
<span class="normal"><a href="#__codelineno-27-23">23</a></span>
<span class="normal"><a href="#__codelineno-27-24">24</a></span>
<span class="normal"><a href="#__codelineno-27-25">25</a></span>
<span class="normal"><a href="#__codelineno-27-26">26</a></span>
<span class="normal"><a href="#__codelineno-27-27">27</a></span>
<span class="normal"><a href="#__codelineno-27-28">28</a></span>
<span class="normal"><a href="#__codelineno-27-29">29</a></span>
<span class="normal"><a href="#__codelineno-27-30">30</a></span>
<span class="normal"><a href="#__codelineno-27-31">31</a></span>
<span class="normal"><a href="#__codelineno-27-32">32</a></span>
<span class="normal"><a href="#__codelineno-27-33">33</a></span>
<span class="normal"><a href="#__codelineno-27-34">34</a></span>
<span class="normal"><a href="#__codelineno-27-35">35</a></span>
<span class="normal"><a href="#__codelineno-27-36">36</a></span>
<span class="normal"><a href="#__codelineno-27-37">37</a></span>
<span class="normal"><a href="#__codelineno-27-38">38</a></span>
<span class="normal"><a href="#__codelineno-27-39">39</a></span>
<span class="normal"><a href="#__codelineno-27-40">40</a></span>
<span class="normal"><a href="#__codelineno-27-41">41</a></span>
<span class="normal"><a href="#__codelineno-27-42">42</a></span>
<span class="normal"><a href="#__codelineno-27-43">43</a></span>
<span class="normal"><a href="#__codelineno-27-44">44</a></span>
<span class="normal"><a href="#__codelineno-27-45">45</a></span>
<span class="normal"><a href="#__codelineno-27-46">46</a></span>
<span class="normal"><a href="#__codelineno-27-47">47</a></span>
<span class="normal"><a href="#__codelineno-27-48">48</a></span>
<span class="normal"><a href="#__codelineno-27-49">49</a></span>
<span class="normal"><a href="#__codelineno-27-50">50</a></span>
<span class="normal"><a href="#__codelineno-27-51">51</a></span>
<span class="normal"><a href="#__codelineno-27-52">52</a></span>
<span class="normal"><a href="#__codelineno-27-53">53</a></span>
<span class="normal"><a href="#__codelineno-27-54">54</a></span>
<span class="normal"><a href="#__codelineno-27-55">55</a></span>
<span class="normal"><a href="#__codelineno-27-56">56</a></span>
<span class="normal"><a href="#__codelineno-27-57">57</a></span>
<span class="normal"><a href="#__codelineno-27-58">58</a></span>
<span class="normal"><a href="#__codelineno-27-59">59</a></span>
<span class="normal"><a href="#__codelineno-27-60">60</a></span>
<span class="normal"><a href="#__codelineno-27-61">61</a></span>
<span class="normal"><a href="#__codelineno-27-62">62</a></span>
<span class="normal"><a href="#__codelineno-27-63">63</a></span>
<span class="normal"><a href="#__codelineno-27-64">64</a></span>
<span class="normal"><a href="#__codelineno-27-65">65</a></span>
<span class="normal"><a href="#__codelineno-27-66">66</a></span>
<span class="normal"><a href="#__codelineno-27-67">67</a></span>
<span class="normal"><a href="#__codelineno-27-68">68</a></span>
<span class="normal"><a href="#__codelineno-27-69">69</a></span>
<span class="normal"><a href="#__codelineno-27-70">70</a></span>
<span class="normal"><a href="#__codelineno-27-71">71</a></span>
<span class="normal"><a href="#__codelineno-27-72">72</a></span>
<span class="normal"><a href="#__codelineno-27-73">73</a></span>
<span class="normal"><a href="#__codelineno-27-74">74</a></span>
<span class="normal"><a href="#__codelineno-27-75">75</a></span>
<span class="normal"><a href="#__codelineno-27-76">76</a></span>
<span class="normal"><a href="#__codelineno-27-77">77</a></span>
<span class="normal"><a href="#__codelineno-27-78">78</a></span>
<span class="normal"><a href="#__codelineno-27-79">79</a></span>
<span class="normal"><a href="#__codelineno-27-80">80</a></span>
<span class="normal"><a href="#__codelineno-27-81">81</a></span>
<span class="normal"><a href="#__codelineno-27-82">82</a></span>
<span class="normal"><a href="#__codelineno-27-83">83</a></span>
<span class="normal"><a href="#__codelineno-27-84">84</a></span>
<span class="normal"><a href="#__codelineno-27-85">85</a></span>
<span class="normal"><a href="#__codelineno-27-86">86</a></span>
<span class="normal"><a href="#__codelineno-27-87">87</a></span>
<span class="normal"><a href="#__codelineno-27-88">88</a></span>
<span class="normal"><a href="#__codelineno-27-89">89</a></span>
<span class="normal"><a href="#__codelineno-27-90">90</a></span>
<span class="normal"><a href="#__codelineno-27-91">91</a></span>
<span class="normal"><a href="#__codelineno-27-92">92</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1"></a>root@kube02-m1:# kubeadm init --cri-socket /var/run/containerd/containerd.sock \
<a id="__codelineno-27-2" name="__codelineno-27-2"></a>--control-plane-endpoint kube02-haproxy.tailnet-a5cd.ts.net \
<a id="__codelineno-27-3" name="__codelineno-27-3"></a>--apiserver-advertise-address $(tailscale ip --4) \
<a id="__codelineno-27-4" name="__codelineno-27-4"></a>--pod-network-cidr 10.25.0.0/16 \
<a id="__codelineno-27-5" name="__codelineno-27-5"></a>--service-cidr 10.26.0.0/16 \
<a id="__codelineno-27-6" name="__codelineno-27-6"></a>--upload-certs
<a id="__codelineno-27-7" name="__codelineno-27-7"></a>W0421 16:13:16.891232   25655 initconfiguration.go:119] Usage of CRI endpoints without URL scheme is deprecated and can cause kubelet errors in the future. Automatically prepending scheme &quot;unix&quot; to the &quot;criSocket&quot; with value &quot;/var/run/containerd/containerd.sock&quot;. Please update your configuration!
<a id="__codelineno-27-8" name="__codelineno-27-8"></a>I0421 16:13:17.241235   25655 version.go:256] remote version is much newer: v1.27.1; falling back to: stable-1.26
<a id="__codelineno-27-9" name="__codelineno-27-9"></a>[init] Using Kubernetes version: v1.26.4
<a id="__codelineno-27-10" name="__codelineno-27-10"></a>[preflight] Running pre-flight checks
<a id="__codelineno-27-11" name="__codelineno-27-11"></a>[preflight] Pulling images required for setting up a Kubernetes cluster
<a id="__codelineno-27-12" name="__codelineno-27-12"></a>[preflight] This might take a minute or two, depending on the speed of your internet connection
<a id="__codelineno-27-13" name="__codelineno-27-13"></a>[preflight] You can also perform this action in beforehand using &#39;kubeadm config images pull&#39;
<a id="__codelineno-27-14" name="__codelineno-27-14"></a>[certs] Using certificateDir folder &quot;/etc/kubernetes/pki&quot;
<a id="__codelineno-27-15" name="__codelineno-27-15"></a>[certs] Generating &quot;ca&quot; certificate and key
<a id="__codelineno-27-16" name="__codelineno-27-16"></a>[certs] Generating &quot;apiserver&quot; certificate and key
<a id="__codelineno-27-17" name="__codelineno-27-17"></a>[certs] apiserver serving cert is signed for DNS names [kube02-haproxy.tailnet-a5cd.ts.net kube02-m1 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.26.0.1 100.122.123.2]
<a id="__codelineno-27-18" name="__codelineno-27-18"></a>[certs] Generating &quot;apiserver-kubelet-client&quot; certificate and key
<a id="__codelineno-27-19" name="__codelineno-27-19"></a>[certs] Generating &quot;front-proxy-ca&quot; certificate and key
<a id="__codelineno-27-20" name="__codelineno-27-20"></a>[certs] Generating &quot;front-proxy-client&quot; certificate and key
<a id="__codelineno-27-21" name="__codelineno-27-21"></a>[certs] Generating &quot;etcd/ca&quot; certificate and key
<a id="__codelineno-27-22" name="__codelineno-27-22"></a>[certs] Generating &quot;etcd/server&quot; certificate and key
<a id="__codelineno-27-23" name="__codelineno-27-23"></a>[certs] etcd/server serving cert is signed for DNS names [kube02-m1 localhost] and IPs [100.122.123.2 127.0.0.1 ::1]
<a id="__codelineno-27-24" name="__codelineno-27-24"></a>[certs] Generating &quot;etcd/peer&quot; certificate and key
<a id="__codelineno-27-25" name="__codelineno-27-25"></a>[certs] etcd/peer serving cert is signed for DNS names [kube02-m1 localhost] and IPs [100.122.123.2 127.0.0.1 ::1]
<a id="__codelineno-27-26" name="__codelineno-27-26"></a>[certs] Generating &quot;etcd/healthcheck-client&quot; certificate and key
<a id="__codelineno-27-27" name="__codelineno-27-27"></a>[certs] Generating &quot;apiserver-etcd-client&quot; certificate and key
<a id="__codelineno-27-28" name="__codelineno-27-28"></a>[certs] Generating &quot;sa&quot; key and public key
<a id="__codelineno-27-29" name="__codelineno-27-29"></a>[kubeconfig] Using kubeconfig folder &quot;/etc/kubernetes&quot;
<a id="__codelineno-27-30" name="__codelineno-27-30"></a>[kubeconfig] Writing &quot;admin.conf&quot; kubeconfig file
<a id="__codelineno-27-31" name="__codelineno-27-31"></a>[kubeconfig] Writing &quot;kubelet.conf&quot; kubeconfig file
<a id="__codelineno-27-32" name="__codelineno-27-32"></a>[kubeconfig] Writing &quot;controller-manager.conf&quot; kubeconfig file
<a id="__codelineno-27-33" name="__codelineno-27-33"></a>[kubeconfig] Writing &quot;scheduler.conf&quot; kubeconfig file
<a id="__codelineno-27-34" name="__codelineno-27-34"></a>[kubelet-start] Writing kubelet environment file with flags to file &quot;/var/lib/kubelet/kubeadm-flags.env&quot;
<a id="__codelineno-27-35" name="__codelineno-27-35"></a>[kubelet-start] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;
<a id="__codelineno-27-36" name="__codelineno-27-36"></a>[kubelet-start] Starting the kubelet
<a id="__codelineno-27-37" name="__codelineno-27-37"></a>[control-plane] Using manifest folder &quot;/etc/kubernetes/manifests&quot;
<a id="__codelineno-27-38" name="__codelineno-27-38"></a>[control-plane] Creating static Pod manifest for &quot;kube-apiserver&quot;
<a id="__codelineno-27-39" name="__codelineno-27-39"></a>[control-plane] Creating static Pod manifest for &quot;kube-controller-manager&quot;
<a id="__codelineno-27-40" name="__codelineno-27-40"></a>[control-plane] Creating static Pod manifest for &quot;kube-scheduler&quot;
<a id="__codelineno-27-41" name="__codelineno-27-41"></a>[etcd] Creating static Pod manifest for local etcd in &quot;/etc/kubernetes/manifests&quot;
<a id="__codelineno-27-42" name="__codelineno-27-42"></a>[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory &quot;/etc/kubernetes/manifests&quot;. This can take up to 4m0s
<a id="__codelineno-27-43" name="__codelineno-27-43"></a>[kubelet-check] Initial timeout of 40s passed.
<a id="__codelineno-27-44" name="__codelineno-27-44"></a>[apiclient] All control plane components are healthy after 101.038704 seconds
<a id="__codelineno-27-45" name="__codelineno-27-45"></a>[upload-config] Storing the configuration used in ConfigMap &quot;kubeadm-config&quot; in the &quot;kube-system&quot; Namespace
<a id="__codelineno-27-46" name="__codelineno-27-46"></a>[kubelet] Creating a ConfigMap &quot;kubelet-config&quot; in namespace kube-system with the configuration for the kubelets in the cluster
<a id="__codelineno-27-47" name="__codelineno-27-47"></a>[upload-certs] Storing the certificates in Secret &quot;kubeadm-certs&quot; in the &quot;kube-system&quot; Namespace
<a id="__codelineno-27-48" name="__codelineno-27-48"></a>[upload-certs] Using certificate key:
<a id="__codelineno-27-49" name="__codelineno-27-49"></a>2f2caa21e13d7f4bece27faa2515d024c8b4e93e08d8d21612113a7ebacff5ea
<a id="__codelineno-27-50" name="__codelineno-27-50"></a>[mark-control-plane] Marking the node kube02-m1 as control-plane by adding the labels: [node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]
<a id="__codelineno-27-51" name="__codelineno-27-51"></a>[mark-control-plane] Marking the node kube02-m1 as control-plane by adding the taints [node-role.kubernetes.io/control-plane:NoSchedule]
<a id="__codelineno-27-52" name="__codelineno-27-52"></a>[bootstrap-token] Using token: 1q32dn.swfpr7qj89hl2g4j
<a id="__codelineno-27-53" name="__codelineno-27-53"></a>[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles
<a id="__codelineno-27-54" name="__codelineno-27-54"></a>[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to get nodes
<a id="__codelineno-27-55" name="__codelineno-27-55"></a>[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials
<a id="__codelineno-27-56" name="__codelineno-27-56"></a>[bootstrap-token] Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
<a id="__codelineno-27-57" name="__codelineno-27-57"></a>[bootstrap-token] Configured RBAC rules to allow certificate rotation for all node client certificates in the cluster
<a id="__codelineno-27-58" name="__codelineno-27-58"></a>[bootstrap-token] Creating the &quot;cluster-info&quot; ConfigMap in the &quot;kube-public&quot; namespace
<a id="__codelineno-27-59" name="__codelineno-27-59"></a>[kubelet-finalize] Updating &quot;/etc/kubernetes/kubelet.conf&quot; to point to a rotatable kubelet client certificate and key
<a id="__codelineno-27-60" name="__codelineno-27-60"></a>[addons] Applied essential addon: CoreDNS
<a id="__codelineno-27-61" name="__codelineno-27-61"></a>[addons] Applied essential addon: kube-proxy
<a id="__codelineno-27-62" name="__codelineno-27-62"></a>
<a id="__codelineno-27-63" name="__codelineno-27-63"></a>Your Kubernetes control-plane has initialized successfully!
<a id="__codelineno-27-64" name="__codelineno-27-64"></a>
<a id="__codelineno-27-65" name="__codelineno-27-65"></a>To start using your cluster, you need to run the following as a regular user:
<a id="__codelineno-27-66" name="__codelineno-27-66"></a>
<a id="__codelineno-27-67" name="__codelineno-27-67"></a><span class="hll">  mkdir -p $HOME/.kube
</span><a id="__codelineno-27-68" name="__codelineno-27-68"></a><span class="hll">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span><a id="__codelineno-27-69" name="__codelineno-27-69"></a><span class="hll">  sudo chown $(id -u):$(id -g) $HOME/.kube/config
</span><a id="__codelineno-27-70" name="__codelineno-27-70"></a>
<a id="__codelineno-27-71" name="__codelineno-27-71"></a>Alternatively, if you are the root user, you can run:
<a id="__codelineno-27-72" name="__codelineno-27-72"></a>
<a id="__codelineno-27-73" name="__codelineno-27-73"></a>  export KUBECONFIG=/etc/kubernetes/admin.conf
<a id="__codelineno-27-74" name="__codelineno-27-74"></a>
<a id="__codelineno-27-75" name="__codelineno-27-75"></a>You should now deploy a pod network to the cluster.
<a id="__codelineno-27-76" name="__codelineno-27-76"></a>Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:
<a id="__codelineno-27-77" name="__codelineno-27-77"></a>  https://kubernetes.io/docs/concepts/cluster-administration/addons/
<a id="__codelineno-27-78" name="__codelineno-27-78"></a>
<a id="__codelineno-27-79" name="__codelineno-27-79"></a>You can now join any number of the control-plane node running the following command on each as root:
<a id="__codelineno-27-80" name="__codelineno-27-80"></a>
<a id="__codelineno-27-81" name="__codelineno-27-81"></a><span class="hll">  kubeadm join kube02-haproxy.tailnet-a5cd.ts.net:6443 --token 1q32dn.swfpr7qj89hl2g4j \
</span><a id="__codelineno-27-82" name="__codelineno-27-82"></a><span class="hll">        --discovery-token-ca-cert-hash sha256:11c669ee4e4e27b997ae5431133dd2cd7c6a2050ddd16b38bee8bee544bbe680 \
</span><a id="__codelineno-27-83" name="__codelineno-27-83"></a><span class="hll">        --control-plane --certificate-key 2f2caa21e13d7f4bece27faa2515d024c8b4e93e08d8d21612113a7ebacff5ea
</span><a id="__codelineno-27-84" name="__codelineno-27-84"></a>
<a id="__codelineno-27-85" name="__codelineno-27-85"></a>Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
<a id="__codelineno-27-86" name="__codelineno-27-86"></a>As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use
<a id="__codelineno-27-87" name="__codelineno-27-87"></a>&quot;kubeadm init phase upload-certs --upload-certs&quot; to reload certs afterward.
<a id="__codelineno-27-88" name="__codelineno-27-88"></a>
<a id="__codelineno-27-89" name="__codelineno-27-89"></a>Then you can join any number of worker nodes by running the following on each as root:
<a id="__codelineno-27-90" name="__codelineno-27-90"></a>
<a id="__codelineno-27-91" name="__codelineno-27-91"></a>kubeadm join kube02-haproxy.tailnet-a5cd.ts.net:6443 --token 1q32dn.swfpr7qj89hl2g4j \
<a id="__codelineno-27-92" name="__codelineno-27-92"></a>        --discovery-token-ca-cert-hash sha256:11c669ee4e4e27b997ae5431133dd2cd7c6a2050ddd16b38bee8bee544bbe680
</code></pre></div></td></tr></table></div>
</details>
<p>Run these commands:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="nv">$HOME</span>/.kube
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>sudo<span class="w"> </span>cp<span class="w"> </span>-i<span class="w"> </span>/etc/kubernetes/admin.conf<span class="w"> </span><span class="nv">$HOME</span>/.kube/config
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>sudo<span class="w"> </span>chown<span class="w"> </span><span class="k">$(</span>id<span class="w"> </span>-u<span class="k">)</span>:<span class="k">$(</span>id<span class="w"> </span>-g<span class="k">)</span><span class="w"> </span><span class="nv">$HOME</span>/.kube/config
</code></pre></div>
<p>And finally check the nodes:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>nodes<span class="w"> </span>-o<span class="w"> </span>wide
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>NAME<span class="w">        </span>STATUS<span class="w">     </span>ROLES<span class="w">           </span>AGE<span class="w">     </span>VERSION<span class="w">   </span>INTERNAL-IP<span class="w">     </span>EXTERNAL-IP<span class="w">   </span>OS-IMAGE<span class="w">                         </span>KERNEL-VERSION<span class="w">    </span>CONTAINER-RUNTIME
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>kube02-m1<span class="w">   </span>NotReady<span class="w">   </span>control-plane<span class="w">   </span>2m45s<span class="w">   </span>v1.26.4<span class="w">   </span><span class="m">100</span>.122.123.2<span class="w">   </span>&lt;none&gt;<span class="w">        </span>Debian<span class="w"> </span>GNU/Linux<span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="o">(</span>bullseye<span class="o">)</span><span class="w">   </span><span class="m">5</span>.10.0-21-amd64<span class="w">   </span>containerd://1.6.20
</code></pre></div>
<h3 id="init-additional-control-plane-nodes">Init Additional Control Plane Nodes<a class="headerlink" href="#init-additional-control-plane-nodes" title="Permanent link">&para;</a></h3>
<p><strong>Command:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>kubeadm<span class="w"> </span>join<span class="w"> </span>kube02-haproxy.tailnet-a5cd.ts.net:6443<span class="w"> </span>--token<span class="w"> </span>1q32dn.swfpr7qj89hl2g4j<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>--apiserver-advertise-address<span class="w"> </span><span class="k">$(</span>tailscale<span class="w"> </span>ip<span class="w"> </span>--4<span class="k">)</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>--cri-socket<span class="w"> </span>/var/run/containerd/containerd.sock<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>--discovery-token-ca-cert-hash<span class="w"> </span>sha256:11c669ee4e4e27b997ae5431133dd2cd7c6a2050ddd16b38bee8bee544bbe680<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>--control-plane<span class="w"> </span>--certificate-key<span class="w"> </span>2f2caa21e13d7f4bece27faa2515d024c8b4e93e08d8d21612113a7ebacff5ea
</code></pre></div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Important that the nodes must use their own VPN address as <code>apiserver-advertise-address</code></p>
</div>
<details class="example">
<summary>Command Output</summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-31-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-31-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-31-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-31-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-31-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-31-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-31-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-31-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-31-10">10</a></span>
<span class="normal"><a href="#__codelineno-31-11">11</a></span>
<span class="normal"><a href="#__codelineno-31-12">12</a></span>
<span class="normal"><a href="#__codelineno-31-13">13</a></span>
<span class="normal"><a href="#__codelineno-31-14">14</a></span>
<span class="normal"><a href="#__codelineno-31-15">15</a></span>
<span class="normal"><a href="#__codelineno-31-16">16</a></span>
<span class="normal"><a href="#__codelineno-31-17">17</a></span>
<span class="normal"><a href="#__codelineno-31-18">18</a></span>
<span class="normal"><a href="#__codelineno-31-19">19</a></span>
<span class="normal"><a href="#__codelineno-31-20">20</a></span>
<span class="normal"><a href="#__codelineno-31-21">21</a></span>
<span class="normal"><a href="#__codelineno-31-22">22</a></span>
<span class="normal"><a href="#__codelineno-31-23">23</a></span>
<span class="normal"><a href="#__codelineno-31-24">24</a></span>
<span class="normal"><a href="#__codelineno-31-25">25</a></span>
<span class="normal"><a href="#__codelineno-31-26">26</a></span>
<span class="normal"><a href="#__codelineno-31-27">27</a></span>
<span class="normal"><a href="#__codelineno-31-28">28</a></span>
<span class="normal"><a href="#__codelineno-31-29">29</a></span>
<span class="normal"><a href="#__codelineno-31-30">30</a></span>
<span class="normal"><a href="#__codelineno-31-31">31</a></span>
<span class="normal"><a href="#__codelineno-31-32">32</a></span>
<span class="normal"><a href="#__codelineno-31-33">33</a></span>
<span class="normal"><a href="#__codelineno-31-34">34</a></span>
<span class="normal"><a href="#__codelineno-31-35">35</a></span>
<span class="normal"><a href="#__codelineno-31-36">36</a></span>
<span class="normal"><a href="#__codelineno-31-37">37</a></span>
<span class="normal"><a href="#__codelineno-31-38">38</a></span>
<span class="normal"><a href="#__codelineno-31-39">39</a></span>
<span class="normal"><a href="#__codelineno-31-40">40</a></span>
<span class="normal"><a href="#__codelineno-31-41">41</a></span>
<span class="normal"><a href="#__codelineno-31-42">42</a></span>
<span class="normal"><a href="#__codelineno-31-43">43</a></span>
<span class="normal"><a href="#__codelineno-31-44">44</a></span>
<span class="normal"><a href="#__codelineno-31-45">45</a></span>
<span class="normal"><a href="#__codelineno-31-46">46</a></span>
<span class="normal"><a href="#__codelineno-31-47">47</a></span>
<span class="normal"><a href="#__codelineno-31-48">48</a></span>
<span class="normal"><a href="#__codelineno-31-49">49</a></span>
<span class="normal"><a href="#__codelineno-31-50">50</a></span>
<span class="normal"><a href="#__codelineno-31-51">51</a></span>
<span class="normal"><a href="#__codelineno-31-52">52</a></span>
<span class="normal"><a href="#__codelineno-31-53">53</a></span>
<span class="normal"><a href="#__codelineno-31-54">54</a></span>
<span class="normal"><a href="#__codelineno-31-55">55</a></span>
<span class="normal"><a href="#__codelineno-31-56">56</a></span>
<span class="normal"><a href="#__codelineno-31-57">57</a></span>
<span class="normal"><a href="#__codelineno-31-58">58</a></span>
<span class="normal"><a href="#__codelineno-31-59">59</a></span>
<span class="normal"><a href="#__codelineno-31-60">60</a></span>
<span class="normal"><a href="#__codelineno-31-61">61</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1"></a>root@kube02-m2:# kubeadm join kube02-haproxy.tailnet-a5cd.ts.net:6443 --token 1q32dn.swfpr7qj89hl2g4j --apiserver-advertise-address $(tailscale ip --4) --cri-socket /var/run/containerd/containerd.sock --discovery-token-ca-cert-hash sha256:11c669ee4e4e27b997ae5431133dd2cd7c6a2050ddd16b38bee8bee544bbe680 --control-plane --certificate-key 2f2caa21e13d7f4bece27faa2515d024c8b4e93e08d8d21612113a7ebacff5ea
<a id="__codelineno-31-2" name="__codelineno-31-2"></a>W0421 16:23:11.602945   26931 initconfiguration.go:119] Usage of CRI endpoints without URL scheme is deprecated and can cause kubelet errors in the future. Automatically prepending scheme &quot;unix&quot; to the &quot;criSocket&quot; with value &quot;/var/run/containerd/containerd.sock&quot;. Please update your configuration!
<a id="__codelineno-31-3" name="__codelineno-31-3"></a>[preflight] Running pre-flight checks
<a id="__codelineno-31-4" name="__codelineno-31-4"></a>[preflight] Reading configuration from the cluster...
<a id="__codelineno-31-5" name="__codelineno-31-5"></a>[preflight] FYI: You can look at this config file with &#39;kubectl -n kube-system get cm kubeadm-config -o yaml&#39;
<a id="__codelineno-31-6" name="__codelineno-31-6"></a>[preflight] Running pre-flight checks before initializing the new control plane instance
<a id="__codelineno-31-7" name="__codelineno-31-7"></a>[preflight] Pulling images required for setting up a Kubernetes cluster
<a id="__codelineno-31-8" name="__codelineno-31-8"></a>[preflight] This might take a minute or two, depending on the speed of your internet connection
<a id="__codelineno-31-9" name="__codelineno-31-9"></a>[preflight] You can also perform this action in beforehand using &#39;kubeadm config images pull&#39;
<a id="__codelineno-31-10" name="__codelineno-31-10"></a>[download-certs] Downloading the certificates in Secret &quot;kubeadm-certs&quot; in the &quot;kube-system&quot; Namespace
<a id="__codelineno-31-11" name="__codelineno-31-11"></a>[download-certs] Saving the certificates to the folder: &quot;/etc/kubernetes/pki&quot;
<a id="__codelineno-31-12" name="__codelineno-31-12"></a>[certs] Using certificateDir folder &quot;/etc/kubernetes/pki&quot;
<a id="__codelineno-31-13" name="__codelineno-31-13"></a>[certs] Generating &quot;apiserver&quot; certificate and key
<a id="__codelineno-31-14" name="__codelineno-31-14"></a>[certs] apiserver serving cert is signed for DNS names [kube02-haproxy.tailnet-a5cd.ts.net kube02-m2 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.26.0.1 100.103.128.9]
<a id="__codelineno-31-15" name="__codelineno-31-15"></a>[certs] Generating &quot;apiserver-kubelet-client&quot; certificate and key
<a id="__codelineno-31-16" name="__codelineno-31-16"></a>[certs] Generating &quot;front-proxy-client&quot; certificate and key
<a id="__codelineno-31-17" name="__codelineno-31-17"></a>[certs] Generating &quot;etcd/peer&quot; certificate and key
<a id="__codelineno-31-18" name="__codelineno-31-18"></a>[certs] etcd/peer serving cert is signed for DNS names [kube02-m2 localhost] and IPs [100.103.128.9 127.0.0.1 ::1]
<a id="__codelineno-31-19" name="__codelineno-31-19"></a>[certs] Generating &quot;apiserver-etcd-client&quot; certificate and key
<a id="__codelineno-31-20" name="__codelineno-31-20"></a>[certs] Generating &quot;etcd/server&quot; certificate and key
<a id="__codelineno-31-21" name="__codelineno-31-21"></a>[certs] etcd/server serving cert is signed for DNS names [kube02-m2 localhost] and IPs [100.103.128.9 127.0.0.1 ::1]
<a id="__codelineno-31-22" name="__codelineno-31-22"></a>[certs] Generating &quot;etcd/healthcheck-client&quot; certificate and key
<a id="__codelineno-31-23" name="__codelineno-31-23"></a>[certs] Valid certificates and keys now exist in &quot;/etc/kubernetes/pki&quot;
<a id="__codelineno-31-24" name="__codelineno-31-24"></a>[certs] Using the existing &quot;sa&quot; key
<a id="__codelineno-31-25" name="__codelineno-31-25"></a>[kubeconfig] Generating kubeconfig files
<a id="__codelineno-31-26" name="__codelineno-31-26"></a>[kubeconfig] Using kubeconfig folder &quot;/etc/kubernetes&quot;
<a id="__codelineno-31-27" name="__codelineno-31-27"></a>[kubeconfig] Writing &quot;admin.conf&quot; kubeconfig file
<a id="__codelineno-31-28" name="__codelineno-31-28"></a>[kubeconfig] Writing &quot;controller-manager.conf&quot; kubeconfig file
<a id="__codelineno-31-29" name="__codelineno-31-29"></a>[kubeconfig] Writing &quot;scheduler.conf&quot; kubeconfig file
<a id="__codelineno-31-30" name="__codelineno-31-30"></a>[control-plane] Using manifest folder &quot;/etc/kubernetes/manifests&quot;
<a id="__codelineno-31-31" name="__codelineno-31-31"></a>[control-plane] Creating static Pod manifest for &quot;kube-apiserver&quot;
<a id="__codelineno-31-32" name="__codelineno-31-32"></a>[control-plane] Creating static Pod manifest for &quot;kube-controller-manager&quot;
<a id="__codelineno-31-33" name="__codelineno-31-33"></a>[control-plane] Creating static Pod manifest for &quot;kube-scheduler&quot;
<a id="__codelineno-31-34" name="__codelineno-31-34"></a>[check-etcd] Checking that the etcd cluster is healthy
<a id="__codelineno-31-35" name="__codelineno-31-35"></a>[kubelet-start] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;
<a id="__codelineno-31-36" name="__codelineno-31-36"></a>[kubelet-start] Writing kubelet environment file with flags to file &quot;/var/lib/kubelet/kubeadm-flags.env&quot;
<a id="__codelineno-31-37" name="__codelineno-31-37"></a>[kubelet-start] Starting the kubelet
<a id="__codelineno-31-38" name="__codelineno-31-38"></a>[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...
<a id="__codelineno-31-39" name="__codelineno-31-39"></a>[etcd] Announced new etcd member joining to the existing etcd cluster
<a id="__codelineno-31-40" name="__codelineno-31-40"></a>[etcd] Creating static Pod manifest for &quot;etcd&quot;
<a id="__codelineno-31-41" name="__codelineno-31-41"></a>[etcd] Waiting for the new etcd member to join the cluster. This can take up to 40s
<a id="__codelineno-31-42" name="__codelineno-31-42"></a>
<a id="__codelineno-31-43" name="__codelineno-31-43"></a>The &#39;update-status&#39; phase is deprecated and will be removed in a future release. Currently it performs no operation
<a id="__codelineno-31-44" name="__codelineno-31-44"></a>[mark-control-plane] Marking the node kube02-m2 as control-plane by adding the labels: [node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]
<a id="__codelineno-31-45" name="__codelineno-31-45"></a>[mark-control-plane] Marking the node kube02-m2 as control-plane by adding the taints [node-role.kubernetes.io/control-plane:NoSchedule]
<a id="__codelineno-31-46" name="__codelineno-31-46"></a>
<a id="__codelineno-31-47" name="__codelineno-31-47"></a>This node has joined the cluster and a new control plane instance was created:
<a id="__codelineno-31-48" name="__codelineno-31-48"></a>
<a id="__codelineno-31-49" name="__codelineno-31-49"></a>* Certificate signing request was sent to apiserver and approval was received.
<a id="__codelineno-31-50" name="__codelineno-31-50"></a>* The Kubelet was informed of the new secure connection details.
<a id="__codelineno-31-51" name="__codelineno-31-51"></a>* Control plane label and taint were applied to the new node.
<a id="__codelineno-31-52" name="__codelineno-31-52"></a>* The Kubernetes control plane instances scaled up.
<a id="__codelineno-31-53" name="__codelineno-31-53"></a>* A new etcd member was added to the local/stacked etcd cluster.
<a id="__codelineno-31-54" name="__codelineno-31-54"></a>
<a id="__codelineno-31-55" name="__codelineno-31-55"></a>To start administering your cluster from this node, you need to run the following as a regular user:
<a id="__codelineno-31-56" name="__codelineno-31-56"></a>
<a id="__codelineno-31-57" name="__codelineno-31-57"></a><span class="hll">        mkdir -p $HOME/.kube
</span><a id="__codelineno-31-58" name="__codelineno-31-58"></a><span class="hll">        sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span><a id="__codelineno-31-59" name="__codelineno-31-59"></a><span class="hll">        sudo chown $(id -u):$(id -g) $HOME/.kube/config
</span><a id="__codelineno-31-60" name="__codelineno-31-60"></a>
<a id="__codelineno-31-61" name="__codelineno-31-61"></a><span class="hll">Run &#39;kubectl get nodes&#39; to see this node join the cluster.
</span></code></pre></div></td></tr></table></div>
</details>
<p><strong>Finally check the nodes:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>root@kube02-m1:~# kubectl get nodes -o wide
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>NAME        STATUS     ROLES           AGE   VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION    CONTAINER-RUNTIME
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>kube02-m1   NotReady   control-plane   10m   v1.26.4   100.122.123.2   &lt;none&gt;        Debian GNU/Linux 11 (bullseye)   5.10.0-21-amd64   containerd://1.6.20
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a>kube02-m2   NotReady   control-plane   98s   v1.26.4   100.103.128.9   &lt;none&gt;        Debian GNU/Linux 11 (bullseye)   5.10.0-21-amd64   containerd://1.6.20
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a>kube02-m3   NotReady   control-plane   16s   v1.26.4   100.124.70.97   &lt;none&gt;        Debian GNU/Linux 11 (bullseye)   5.10.0-21-amd64   containerd://1.6.20
</code></pre></div>
<h3 id="optional-post-init-steps">(optional) Post Init Steps<a class="headerlink" href="#optional-post-init-steps" title="Permanent link">&para;</a></h3>
<p>These steps are useful when you won't have any worker nodes, just control-planes.</p>
<h4 id="mark-nodes-as-worker">Mark Nodes As Worker<a class="headerlink" href="#mark-nodes-as-worker" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>kubectl<span class="w"> </span>label<span class="w"> </span>node<span class="w"> </span>kube02-m1<span class="w"> </span>node-role.kubernetes.io/worker<span class="o">=</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>kubectl<span class="w"> </span>label<span class="w"> </span>node<span class="w"> </span>kube02-m2<span class="w"> </span>node-role.kubernetes.io/worker<span class="o">=</span>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>kubectl<span class="w"> </span>label<span class="w"> </span>node<span class="w"> </span>kube02-m3<span class="w"> </span>node-role.kubernetes.io/worker<span class="o">=</span>
</code></pre></div>
<h4 id="untaint-the-nodes">Untaint The Nodes<a class="headerlink" href="#untaint-the-nodes" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>kubectl<span class="w"> </span>taint<span class="w"> </span>nodes<span class="w"> </span>kube02-m1<span class="w"> </span>node-role.kubernetes.io/control-plane<span class="o">=</span>:NoSchedule-
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>kubectl<span class="w"> </span>taint<span class="w"> </span>nodes<span class="w"> </span>kube02-m2<span class="w"> </span>node-role.kubernetes.io/control-plane<span class="o">=</span>:NoSchedule-
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>kubectl<span class="w"> </span>taint<span class="w"> </span>nodes<span class="w"> </span>kube02-m3<span class="w"> </span>node-role.kubernetes.io/control-plane<span class="o">=</span>:NoSchedule-
</code></pre></div>
<p>Our nodes are in <code>NotReady</code> state, because no network plugin is installed.</p>
<h2 id="install-network-plugin">Install Network Plugin<a class="headerlink" href="#install-network-plugin" title="Permanent link">&para;</a></h2>
<p>In this post I will show two network plugin: <a href="https://github.com/flannel-io/flannel">flannel</a> and <a href="https://www.weave.works/docs/net/latest/kubernetes/kube-addon/">weave</a>.</p>
<h3 id="weave">Weave<a class="headerlink" href="#weave" title="Permanent link">&para;</a></h3>
<p><strong>Download The Manifest</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>wget<span class="w"> </span>https://github.com/weaveworks/weave/releases/download/v2.8.1/weave-daemonset-k8s.yaml
</code></pre></div>
<p>You should consider to change iptables mode:</p>
<blockquote>
<p>IPTABLES_BACKEND - set to nft to use nftables backend for iptables (default is iptables)</p>
</blockquote>
<p>In my case I use nft, so I have to add <code>IPTABLES_BACKEND</code> environment variable and set to <code>nft</code></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-36-1">1</a></span>
<span class="normal"><a href="#__codelineno-36-2">2</a></span>
<span class="normal"><a href="#__codelineno-36-3">3</a></span>
<span class="normal"><a href="#__codelineno-36-4">4</a></span>
<span class="normal"><a href="#__codelineno-36-5">5</a></span>
<span class="normal"><a href="#__codelineno-36-6">6</a></span>
<span class="normal"><a href="#__codelineno-36-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="w">          </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-36-2" name="__codelineno-36-2"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">weave</span>
<a id="__codelineno-36-3" name="__codelineno-36-3"></a><span class="w">              </span><span class="nt">command</span><span class="p">:</span>
<a id="__codelineno-36-4" name="__codelineno-36-4"></a><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/weave/launch.sh</span>
<a id="__codelineno-36-5" name="__codelineno-36-5"></a><span class="hll"><span class="w">              </span><span class="nt">env</span><span class="p">:</span>
</span><a id="__codelineno-36-6" name="__codelineno-36-6"></a><span class="hll"><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPTABLES_BACKEND</span>
</span><a id="__codelineno-36-7" name="__codelineno-36-7"></a><span class="hll"><span class="w">                  </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nft</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>Apply the manifest</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>kubectl<span class="w">  </span>apply<span class="w"> </span>-f<span class="w"> </span>weave-daemonset-k8s.yaml
</code></pre></div>
<p>Check the status of the Weave PODs:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-l<span class="w"> </span><span class="nv">name</span><span class="o">=</span>weave-net<span class="w"> </span>-o<span class="w"> </span>wide
</code></pre></div>
<p>You should see something like this:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a>NAME              READY   STATUS    RESTARTS      AGE   IP              NODE        NOMINATED NODE   READINESS GATES
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>weave-net-drz44   2/2     Running   1 (59s ago)   68s   100.103.128.9   kube02-m2   &lt;none&gt;           &lt;none&gt;
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>weave-net-p72nl   2/2     Running   1 (59s ago)   68s   100.124.70.97   kube02-m3   &lt;none&gt;           &lt;none&gt;
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>weave-net-zzj9p   2/2     Running   1 (59s ago)   68s   100.122.123.2   kube02-m1   &lt;none&gt;           &lt;none&gt;
</code></pre></div>
<p>If everything went good, you should see that the coredns pods are running:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>root@kube02-m1:~#<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-l<span class="w"> </span>k8s-app<span class="o">=</span>kube-dns<span class="w"> </span>-o<span class="w"> </span>wide
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>NAME<span class="w">                       </span>READY<span class="w">   </span>STATUS<span class="w">    </span>RESTARTS<span class="w">   </span>AGE<span class="w">   </span>IP<span class="w">          </span>NODE<span class="w">        </span>NOMINATED<span class="w"> </span>NODE<span class="w">   </span>READINESS<span class="w"> </span>GATES
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a>coredns-787d4945fb-2d5zm<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>21m<span class="w">   </span><span class="m">10</span>.40.0.0<span class="w">   </span>kube02-m1<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a>coredns-787d4945fb-gmtbr<span class="w">   </span><span class="m">1</span>/1<span class="w">     </span>Running<span class="w">   </span><span class="m">0</span><span class="w">          </span>21m<span class="w">   </span><span class="m">10</span>.40.0.1<span class="w">   </span>kube02-m1<span class="w">   </span>&lt;none&gt;<span class="w">           </span>&lt;none&gt;
</code></pre></div>
<h3 id="flannel">Flannel<a class="headerlink" href="#flannel" title="Permanent link">&para;</a></h3>
<p>Download the manifest:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a>wget<span class="w"> </span>https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
</code></pre></div>
<p>Modify the manifest to use the tailscale0 interface (<code>iface=tailscale0</code>) and our network CIDR:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-42-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-42-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-42-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-42-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-42-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-42-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-42-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-42-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-42-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-42-10">10</a></span>
<span class="normal"><a href="#__codelineno-42-11">11</a></span>
<span class="normal"><a href="#__codelineno-42-12">12</a></span>
<span class="normal"><a href="#__codelineno-42-13">13</a></span>
<span class="normal"><a href="#__codelineno-42-14">14</a></span>
<span class="normal"><a href="#__codelineno-42-15">15</a></span>
<span class="normal"><a href="#__codelineno-42-16">16</a></span>
<span class="normal"><a href="#__codelineno-42-17">17</a></span>
<span class="normal"><a href="#__codelineno-42-18">18</a></span>
<span class="normal"><a href="#__codelineno-42-19">19</a></span>
<span class="normal"><a href="#__codelineno-42-20">20</a></span>
<span class="normal"><a href="#__codelineno-42-21">21</a></span>
<span class="normal"><a href="#__codelineno-42-22">22</a></span>
<span class="normal"><a href="#__codelineno-42-23">23</a></span>
<span class="normal"><a href="#__codelineno-42-24">24</a></span>
<span class="normal"><a href="#__codelineno-42-25">25</a></span>
<span class="normal"><a href="#__codelineno-42-26">26</a></span>
<span class="normal"><a href="#__codelineno-42-27">27</a></span>
<span class="normal"><a href="#__codelineno-42-28">28</a></span>
<span class="normal"><a href="#__codelineno-42-29">29</a></span>
<span class="normal"><a href="#__codelineno-42-30">30</a></span>
<span class="normal"><a href="#__codelineno-42-31">31</a></span>
<span class="normal"><a href="#__codelineno-42-32">32</a></span>
<span class="normal"><a href="#__codelineno-42-33">33</a></span>
<span class="normal"><a href="#__codelineno-42-34">34</a></span>
<span class="normal"><a href="#__codelineno-42-35">35</a></span>
<span class="normal"><a href="#__codelineno-42-36">36</a></span>
<span class="normal"><a href="#__codelineno-42-37">37</a></span>
<span class="normal"><a href="#__codelineno-42-38">38</a></span>
<span class="normal"><a href="#__codelineno-42-39">39</a></span>
<span class="normal"><a href="#__codelineno-42-40">40</a></span>
<span class="normal"><a href="#__codelineno-42-41">41</a></span>
<span class="normal"><a href="#__codelineno-42-42">42</a></span>
<span class="normal"><a href="#__codelineno-42-43">43</a></span>
<span class="normal"><a href="#__codelineno-42-44">44</a></span>
<span class="normal"><a href="#__codelineno-42-45">45</a></span>
<span class="normal"><a href="#__codelineno-42-46">46</a></span>
<span class="normal"><a href="#__codelineno-42-47">47</a></span>
<span class="normal"><a href="#__codelineno-42-48">48</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1"></a><span class="gd">--- kube-flannel-orig.yml       2023-03-22 15:48:52.000000000 +0100</span>
<a id="__codelineno-42-2" name="__codelineno-42-2"></a><span class="gi">+++ kube-flannel.yml    2023-04-25 08:27:05.183037370 +0200</span>
<a id="__codelineno-42-3" name="__codelineno-42-3"></a><span class="gu">@@ -81,21 +81,21 @@</span>
<a id="__codelineno-42-4" name="__codelineno-42-4"></a><span class="w"> </span>        {
<a id="__codelineno-42-5" name="__codelineno-42-5"></a><span class="w"> </span>          &quot;type&quot;: &quot;portmap&quot;,
<a id="__codelineno-42-6" name="__codelineno-42-6"></a><span class="w"> </span>          &quot;capabilities&quot;: {
<a id="__codelineno-42-7" name="__codelineno-42-7"></a><span class="w"> </span>            &quot;portMappings&quot;: true
<a id="__codelineno-42-8" name="__codelineno-42-8"></a><span class="w"> </span>          }
<a id="__codelineno-42-9" name="__codelineno-42-9"></a><span class="w"> </span>        }
<a id="__codelineno-42-10" name="__codelineno-42-10"></a><span class="w"> </span>      ]
<a id="__codelineno-42-11" name="__codelineno-42-11"></a><span class="w"> </span>    }
<a id="__codelineno-42-12" name="__codelineno-42-12"></a><span class="w"> </span>  net-conf.json: |
<a id="__codelineno-42-13" name="__codelineno-42-13"></a><span class="w"> </span>    {
<a id="__codelineno-42-14" name="__codelineno-42-14"></a><span class="gd">-      &quot;Network&quot;: &quot;10.244.0.0/16&quot;,</span>
<a id="__codelineno-42-15" name="__codelineno-42-15"></a><span class="gi">+      &quot;Network&quot;: &quot;10.25.0.0/16&quot;,</span>
<a id="__codelineno-42-16" name="__codelineno-42-16"></a><span class="w"> </span>      &quot;Backend&quot;: {
<a id="__codelineno-42-17" name="__codelineno-42-17"></a><span class="w"> </span>        &quot;Type&quot;: &quot;vxlan&quot;
<a id="__codelineno-42-18" name="__codelineno-42-18"></a><span class="w"> </span>      }
<a id="__codelineno-42-19" name="__codelineno-42-19"></a><span class="w"> </span>    }
<a id="__codelineno-42-20" name="__codelineno-42-20"></a><span class="w"> </span>kind: ConfigMap
<a id="__codelineno-42-21" name="__codelineno-42-21"></a><span class="w"> </span>metadata:
<a id="__codelineno-42-22" name="__codelineno-42-22"></a><span class="w"> </span>  labels:
<a id="__codelineno-42-23" name="__codelineno-42-23"></a><span class="w"> </span>    app: flannel
<a id="__codelineno-42-24" name="__codelineno-42-24"></a><span class="w"> </span>    k8s-app: flannel
<a id="__codelineno-42-25" name="__codelineno-42-25"></a><span class="w"> </span>    tier: node
<a id="__codelineno-42-26" name="__codelineno-42-26"></a><span class="gu">@@ -129,20 +129,21 @@</span>
<a id="__codelineno-42-27" name="__codelineno-42-27"></a><span class="w"> </span>            nodeSelectorTerms:
<a id="__codelineno-42-28" name="__codelineno-42-28"></a><span class="w"> </span>            - matchExpressions:
<a id="__codelineno-42-29" name="__codelineno-42-29"></a><span class="w"> </span>              - key: kubernetes.io/os
<a id="__codelineno-42-30" name="__codelineno-42-30"></a><span class="w"> </span>                operator: In
<a id="__codelineno-42-31" name="__codelineno-42-31"></a><span class="w"> </span>                values:
<a id="__codelineno-42-32" name="__codelineno-42-32"></a><span class="w"> </span>                - linux
<a id="__codelineno-42-33" name="__codelineno-42-33"></a><span class="w"> </span>      containers:
<a id="__codelineno-42-34" name="__codelineno-42-34"></a><span class="w"> </span>      - args:
<a id="__codelineno-42-35" name="__codelineno-42-35"></a><span class="w"> </span>        - --ip-masq
<a id="__codelineno-42-36" name="__codelineno-42-36"></a><span class="w"> </span>        - --kube-subnet-mgr
<a id="__codelineno-42-37" name="__codelineno-42-37"></a><span class="gi">+        - --iface=tailscale0</span>
<a id="__codelineno-42-38" name="__codelineno-42-38"></a><span class="w"> </span>        command:
<a id="__codelineno-42-39" name="__codelineno-42-39"></a><span class="w"> </span>        - /opt/bin/flanneld
<a id="__codelineno-42-40" name="__codelineno-42-40"></a><span class="w"> </span>        env:
<a id="__codelineno-42-41" name="__codelineno-42-41"></a><span class="w"> </span>        - name: POD_NAME
<a id="__codelineno-42-42" name="__codelineno-42-42"></a><span class="w"> </span>          valueFrom:
<a id="__codelineno-42-43" name="__codelineno-42-43"></a><span class="w"> </span>            fieldRef:
<a id="__codelineno-42-44" name="__codelineno-42-44"></a><span class="w"> </span>              fieldPath: metadata.name
<a id="__codelineno-42-45" name="__codelineno-42-45"></a><span class="w"> </span>        - name: POD_NAMESPACE
<a id="__codelineno-42-46" name="__codelineno-42-46"></a><span class="w"> </span>          valueFrom:
<a id="__codelineno-42-47" name="__codelineno-42-47"></a><span class="w"> </span>            fieldRef:
<a id="__codelineno-42-48" name="__codelineno-42-48"></a>root@kube02-m1:~#
</code></pre></div></td></tr></table></div>
<p>Apply the manifest:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>kube-flannel.yml
</code></pre></div>
<details class="example">
<summary>Example flannel-ds logs <code>kubectl -n kube-flannel logs kube-flannel-ds-h2rp2</code></summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-44-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-44-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-44-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-44-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-44-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-44-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-44-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-44-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-44-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-44-10">10</a></span>
<span class="normal"><a href="#__codelineno-44-11">11</a></span>
<span class="normal"><a href="#__codelineno-44-12">12</a></span>
<span class="normal"><a href="#__codelineno-44-13">13</a></span>
<span class="normal"><a href="#__codelineno-44-14">14</a></span>
<span class="normal"><a href="#__codelineno-44-15">15</a></span>
<span class="normal"><a href="#__codelineno-44-16">16</a></span>
<span class="normal"><a href="#__codelineno-44-17">17</a></span>
<span class="normal"><a href="#__codelineno-44-18">18</a></span>
<span class="normal"><a href="#__codelineno-44-19">19</a></span>
<span class="normal"><a href="#__codelineno-44-20">20</a></span>
<span class="normal"><a href="#__codelineno-44-21">21</a></span>
<span class="normal"><a href="#__codelineno-44-22">22</a></span>
<span class="normal"><a href="#__codelineno-44-23">23</a></span>
<span class="normal"><a href="#__codelineno-44-24">24</a></span>
<span class="normal"><a href="#__codelineno-44-25">25</a></span>
<span class="normal"><a href="#__codelineno-44-26">26</a></span>
<span class="normal"><a href="#__codelineno-44-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1"></a>Defaulted container &quot;kube-flannel&quot; out of: kube-flannel, install-cni-plugin (init), install-cni (init)
<a id="__codelineno-44-2" name="__codelineno-44-2"></a>I0425 06:34:24.144883       1 main.go:211] CLI flags config: {etcdEndpoints:http://127.0.0.1:4001,http://127.0.0.1:2379 etcdPrefix:/coreos.com/network etcdKeyfile: etcdCertfile: etcdCAFile: etcdUsername: etcdPassword: version:false kubeSubnetMgr:true kubeApiUrl: kubeAnnotationPrefix:flannel.alpha.coreos.com kubeConfigFile: iface:[tailscale0] ifaceRegex:[] ipMasq:true ifaceCanReach: subnetFile:/run/flannel/subnet.env publicIP: publicIPv6: subnetLeaseRenewMargin:60 healthzIP:0.0.0.0 healthzPort:0 iptablesResyncSeconds:5 iptablesForwardRules:true netConfPath:/etc/kube-flannel/net-conf.json setNodeNetworkUnavailable:true useMultiClusterCidr:false}
<a id="__codelineno-44-3" name="__codelineno-44-3"></a>W0425 06:34:24.146218       1 client_config.go:617] Neither --kubeconfig nor --master was specified.  Using the inClusterConfig.  This might not work.
<a id="__codelineno-44-4" name="__codelineno-44-4"></a>I0425 06:34:24.207098       1 kube.go:144] Waiting 10m0s for node controller to sync
<a id="__codelineno-44-5" name="__codelineno-44-5"></a>I0425 06:34:24.207158       1 kube.go:485] Starting kube subnet manager
<a id="__codelineno-44-6" name="__codelineno-44-6"></a><span class="hll">I0425 06:34:24.220083       1 kube.go:506] Creating the node lease for IPv4. This is the n.Spec.PodCIDRs: [10.25.0.0/24]
</span><a id="__codelineno-44-7" name="__codelineno-44-7"></a><span class="hll">I0425 06:34:24.220116       1 kube.go:506] Creating the node lease for IPv4. This is the n.Spec.PodCIDRs: [10.25.1.0/24]
</span><a id="__codelineno-44-8" name="__codelineno-44-8"></a><span class="hll">I0425 06:34:24.220245       1 kube.go:506] Creating the node lease for IPv4. This is the n.Spec.PodCIDRs: [10.25.2.0/24]
</span><a id="__codelineno-44-9" name="__codelineno-44-9"></a><span class="hll">I0425 06:34:25.207246       1 kube.go:151] Node controller sync successful
</span><a id="__codelineno-44-10" name="__codelineno-44-10"></a>I0425 06:34:25.207266       1 main.go:231] Created subnet manager: Kubernetes Subnet Manager - kube02-m1
<a id="__codelineno-44-11" name="__codelineno-44-11"></a>I0425 06:34:25.207272       1 main.go:234] Installing signal handlers
<a id="__codelineno-44-12" name="__codelineno-44-12"></a>I0425 06:34:25.207991       1 main.go:542] Found network config - Backend type: vxlan
<a id="__codelineno-44-13" name="__codelineno-44-13"></a>I0425 06:34:25.208718       1 match.go:259] Using interface with name tailscale0 and address 100.122.123.2
<a id="__codelineno-44-14" name="__codelineno-44-14"></a>I0425 06:34:25.208762       1 match.go:281] Defaulting external address to interface address (100.122.123.2)
<a id="__codelineno-44-15" name="__codelineno-44-15"></a>I0425 06:34:25.208917       1 vxlan.go:140] VXLAN config: VNI=1 Port=0 GBP=false Learning=false DirectRouting=false
<a id="__codelineno-44-16" name="__codelineno-44-16"></a>I0425 06:34:25.210776       1 main.go:356] Setting up masking rules
<a id="__codelineno-44-17" name="__codelineno-44-17"></a>I0425 06:34:25.252429       1 main.go:407] Changing default FORWARD chain policy to ACCEPT
<a id="__codelineno-44-18" name="__codelineno-44-18"></a>I0425 06:34:25.253690       1 iptables.go:290] generated 7 rules
<a id="__codelineno-44-19" name="__codelineno-44-19"></a>I0425 06:34:25.256468       1 main.go:435] Wrote subnet file to /run/flannel/subnet.env
<a id="__codelineno-44-20" name="__codelineno-44-20"></a>I0425 06:34:25.256489       1 main.go:439] Running backend.
<a id="__codelineno-44-21" name="__codelineno-44-21"></a>I0425 06:34:25.256646       1 iptables.go:290] generated 3 rules
<a id="__codelineno-44-22" name="__codelineno-44-22"></a>I0425 06:34:25.257126       1 vxlan_network.go:64] watching for new subnet leases
<a id="__codelineno-44-23" name="__codelineno-44-23"></a>I0425 06:34:25.258108       1 watch.go:51] Batch elem [0] is { subnet.Event{Type:0, Lease:subnet.Lease{EnableIPv4:true, EnableIPv6:false, Subnet:ip.IP4Net{IP:0xa190100, PrefixLen:0x18}, IPv6Subnet:ip.IP6Net{IP:(*ip.IP6)(nil), PrefixLen:0x0}, Attrs:subnet.LeaseAttrs{PublicIP:0x64678009, PublicIPv6:(*ip.IP6)(nil), BackendType:&quot;vxlan&quot;, BackendData:json.RawMessage{0x7b, 0x22, 0x56, 0x4e, 0x49, 0x22, 0x3a, 0x31, 0x2c, 0x22, 0x56, 0x74, 0x65, 0x70, 0x4d, 0x41, 0x43, 0x22, 0x3a, 0x22, 0x35, 0x32, 0x3a, 0x39, 0x65, 0x3a, 0x32, 0x62, 0x3a, 0x63, 0x33, 0x3a, 0x38, 0x34, 0x3a, 0x63, 0x37, 0x22, 0x7d}, BackendV6Data:json.RawMessage(nil)}, Expiration:time.Date(1, time.January, 1, 0, 0, 0, 0, time.UTC), Asof:0}} }
<a id="__codelineno-44-24" name="__codelineno-44-24"></a>I0425 06:34:25.258185       1 watch.go:51] Batch elem [0] is { subnet.Event{Type:0, Lease:subnet.Lease{EnableIPv4:true, EnableIPv6:false, Subnet:ip.IP4Net{IP:0xa190200, PrefixLen:0x18}, IPv6Subnet:ip.IP6Net{IP:(*ip.IP6)(nil), PrefixLen:0x0}, Attrs:subnet.LeaseAttrs{PublicIP:0x647c4661, PublicIPv6:(*ip.IP6)(nil), BackendType:&quot;vxlan&quot;, BackendData:json.RawMessage{0x7b, 0x22, 0x56, 0x4e, 0x49, 0x22, 0x3a, 0x31, 0x2c, 0x22, 0x56, 0x74, 0x65, 0x70, 0x4d, 0x41, 0x43, 0x22, 0x3a, 0x22, 0x33, 0x61, 0x3a, 0x38, 0x31, 0x3a, 0x36, 0x30, 0x3a, 0x63, 0x64, 0x3a, 0x66, 0x63, 0x3a, 0x62, 0x63, 0x22, 0x7d}, BackendV6Data:json.RawMessage(nil)}, Expiration:time.Date(1, time.January, 1, 0, 0, 0, 0, time.UTC), Asof:0}} }
<a id="__codelineno-44-25" name="__codelineno-44-25"></a>I0425 06:34:25.290612       1 iptables.go:283] bootstrap done
<a id="__codelineno-44-26" name="__codelineno-44-26"></a>I0425 06:34:25.311445       1 iptables.go:283] bootstrap done
<a id="__codelineno-44-27" name="__codelineno-44-27"></a>I0425 06:34:25.322841       1 main.go:460] Waiting for all goroutines to exit
</code></pre></div></td></tr></table></div>
</details>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Choose only one CNI plugin, do not install both flannel and weave.
If you want to replace weave you should remove it: </p>
<ul>
<li><code>kubectl delete -f weave-daemonset-k8s.yaml</code></li>
<li><code>rm /etc/cni/net.d/10-weave.conflist</code></li>
<li>Additionally rebooting the nodes may be necessary.</li>
<li>After you applied the kube manifest run <code>kubectl delete pods --all -A</code> command. <strong>This will recreate all pods in the entire cluster!!!</strong></li>
</ul>
<p>I really recommend you to choose CNI network plugin carefully before you getting use your cluster, and avoid changing CNI in the future.</p>
</div>
<h3 id="switch-between-iptables-legacy-and-iptables-nft">Switch Between iptables-legacy And iptables-nft<a class="headerlink" href="#switch-between-iptables-legacy-and-iptables-nft" title="Permanent link">&para;</a></h3>
<p>If you want or need to change iptables to or from iptables-legacy please check this link: <a href="https://wiki.debian.org/iptables">https://wiki.debian.org/iptables</a></p>
<p>Example, how to change to legacy:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a>apt-get<span class="w"> </span>install<span class="w"> </span>arptables
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a>update-alternatives<span class="w"> </span>--set<span class="w"> </span>iptables<span class="w"> </span>/usr/sbin/iptables-legacy
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a>update-alternatives<span class="w"> </span>--set<span class="w"> </span>ip6tables<span class="w"> </span>/usr/sbin/ip6tables-legacy
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a>update-alternatives<span class="w"> </span>--set<span class="w"> </span>arptables<span class="w"> </span>/usr/sbin/arptables-legacy
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a>update-alternatives<span class="w"> </span>--set<span class="w"> </span>ebtables<span class="w"> </span>/usr/sbin/ebtables-legacy
</code></pre></div>
<h2 id="bonus-persistent-storage">(bonus) - Persistent Storage<a class="headerlink" href="#bonus-persistent-storage" title="Permanent link">&para;</a></h2>
<p>Almost all Kubernetes Cluster have some kind of PersistentVolume solution for storing data. Now we will deploy <a href="https://longhorn.io/docs/1.4.1/deploy/install/install-with-kubectl/">Longhorn</a></p>
<p><strong>It is just a simple command:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/longhorn/longhorn/v1.4.1/deploy/longhorn.yaml
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>If you want to use RWX volumes NFSv4 client must be installed on all Kubernetes nodes. <a href="https://longhorn.io/docs/1.4.1/advanced-resources/rwx-workloads/index.html#requirements">LINK</a></p>
</div>
<h3 id="create-pvc">Create PVC<a class="headerlink" href="#create-pvc" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-47-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-47-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-47-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-47-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-47-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-47-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-47-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-47-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-47-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-47-10">10</a></span>
<span class="normal"><a href="#__codelineno-47-11">11</a></span>
<span class="normal"><a href="#__codelineno-47-12">12</a></span>
<span class="normal"><a href="#__codelineno-47-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1"></a><span class="l l-Scalar l-Scalar-Plain">cat &lt;&lt;EOF | kubectl apply -f -</span>
<a id="__codelineno-47-2" name="__codelineno-47-2"></a><span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-47-3" name="__codelineno-47-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
<a id="__codelineno-47-4" name="__codelineno-47-4"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-47-5" name="__codelineno-47-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test-pvc-02</span>
<a id="__codelineno-47-6" name="__codelineno-47-6"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-47-7" name="__codelineno-47-7"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">longhorn</span><span class="w"> </span><span class="c1">#(1)</span>
<a id="__codelineno-47-8" name="__codelineno-47-8"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
<a id="__codelineno-47-9" name="__codelineno-47-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteMany</span><span class="w"> </span><span class="c1"># (2)</span>
<a id="__codelineno-47-10" name="__codelineno-47-10"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
<a id="__codelineno-47-11" name="__codelineno-47-11"></a><span class="w">    </span><span class="nt">requests</span><span class="p">:</span>
<a id="__codelineno-47-12" name="__codelineno-47-12"></a><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span>
<a id="__codelineno-47-13" name="__codelineno-47-13"></a><span class="l l-Scalar l-Scalar-Plain">EOF</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>This is the default Storage Class</li>
<li>Use one of: <code>ReadWriteOnce, ReadOnlyMany or ReadWriteMany, see AccessModes</code></li>
</ol>
<p><strong>Create Pod To Consume The Storage</strong></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-48-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-48-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-48-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-48-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-48-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-48-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-48-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-48-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-48-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-48-10">10</a></span>
<span class="normal"><a href="#__codelineno-48-11">11</a></span>
<span class="normal"><a href="#__codelineno-48-12">12</a></span>
<span class="normal"><a href="#__codelineno-48-13">13</a></span>
<span class="normal"><a href="#__codelineno-48-14">14</a></span>
<span class="normal"><a href="#__codelineno-48-15">15</a></span>
<span class="normal"><a href="#__codelineno-48-16">16</a></span>
<span class="normal"><a href="#__codelineno-48-17">17</a></span>
<span class="normal"><a href="#__codelineno-48-18">18</a></span>
<span class="normal"><a href="#__codelineno-48-19">19</a></span>
<span class="normal"><a href="#__codelineno-48-20">20</a></span>
<span class="normal"><a href="#__codelineno-48-21">21</a></span>
<span class="normal"><a href="#__codelineno-48-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1"></a>cat<span class="w"> </span><span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
<a id="__codelineno-48-2" name="__codelineno-48-2"></a><span class="s">apiVersion: v1</span>
<a id="__codelineno-48-3" name="__codelineno-48-3"></a><span class="s">kind: Pod</span>
<a id="__codelineno-48-4" name="__codelineno-48-4"></a><span class="s">metadata:</span>
<a id="__codelineno-48-5" name="__codelineno-48-5"></a><span class="s">  name: hello-pvc</span>
<a id="__codelineno-48-6" name="__codelineno-48-6"></a><span class="s">  namespace: default</span>
<a id="__codelineno-48-7" name="__codelineno-48-7"></a><span class="s">spec:</span>
<a id="__codelineno-48-8" name="__codelineno-48-8"></a><span class="s">  volumes:</span>
<a id="__codelineno-48-9" name="__codelineno-48-9"></a><span class="s">  - name: storage</span>
<a id="__codelineno-48-10" name="__codelineno-48-10"></a><span class="s">    persistentVolumeClaim:</span>
<a id="__codelineno-48-11" name="__codelineno-48-11"></a><span class="s">      claimName: test-pvc-02</span>
<a id="__codelineno-48-12" name="__codelineno-48-12"></a><span class="s">  containers:</span>
<a id="__codelineno-48-13" name="__codelineno-48-13"></a><span class="s">  - name: hello-container</span>
<a id="__codelineno-48-14" name="__codelineno-48-14"></a><span class="s">    image: busybox</span>
<a id="__codelineno-48-15" name="__codelineno-48-15"></a><span class="s">    command:</span>
<a id="__codelineno-48-16" name="__codelineno-48-16"></a><span class="s">       - sh</span>
<a id="__codelineno-48-17" name="__codelineno-48-17"></a><span class="s">       - -c</span>
<a id="__codelineno-48-18" name="__codelineno-48-18"></a><span class="s">       - &#39;while true; do echo &quot;`date` [`hostname`] Hello from Longhorn PV.&quot; &gt;&gt; /mnt/store/greet.txt; sleep $(($RANDOM % 5 + 300)); done&#39;</span>
<a id="__codelineno-48-19" name="__codelineno-48-19"></a><span class="s">    volumeMounts:</span>
<a id="__codelineno-48-20" name="__codelineno-48-20"></a><span class="s">    - mountPath: /mnt/store</span>
<a id="__codelineno-48-21" name="__codelineno-48-21"></a><span class="s">      name: storage</span>
<a id="__codelineno-48-22" name="__codelineno-48-22"></a><span class="s">EOF</span>
</code></pre></div></td></tr></table></div>







  
  




  


<script src="https://giscus.app/client.js"
        data-repo="jvincze84/jvincze84.github.io"
        data-repo-id="R_kgDOGJolJg"
        data-category-id="DIC_kwDOGJolJs4CPryr"
        data-mapping="title"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="transparent_dark"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>
      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <!-- Cookie Consent by https://www.CookieConsent.com -->
<script type="text/javascript" src="//www.cookieconsent.com/releases/4.0.0/cookie-consent.js" charset="UTF-8"></script>
<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({"notice_banner_type":"headline","consent_type":"express","palette":"light","language":"en","page_load_consent_levels":["strictly-necessary"],"notice_banner_reject_button_hide":false,"preferences_center_close_button_hide":false,"website_name":"Blog"});
});
</script>

<noscript>ePrivacy and GPDR Cookie Consent by <a href="https://www.CookieConsent.com/" rel="nofollow noopener">Cookie Consent</a></noscript>
<!-- End Cookie Consent by https://www.CookieConsent.com -->

      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../../..", "features": ["navigation.indexes", "navigation.top", "search.suggest", "search.highlight", "search.highlight", "header.autohide", "content.code.annotate", "content.code.copy"], "search": "../../../../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>