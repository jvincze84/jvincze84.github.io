
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://readthedocs.vinczejanos.info/Blog/2021/10/27/install-matrix-home-server-on-kubernetes/">
      
      
        <link rel="prev" href="../../10/get-started-with-portainer/">
      
      
        <link rel="next" href="../../../12/11/home-assistant-switch-timer-with-tasmota-pulsetime/">
      
      
        
      
      
      <link rel="icon" href="../../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Install Matrix Home Server On Kubernetes - Vincze Janos Blog</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../css/width.css">
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#install-matrix-home-server-on-kubernetes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../.." title="Vincze Janos Blog" class="md-header__button md-logo" aria-label="Vincze Janos Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Vincze Janos Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Install Matrix Home Server On Kubernetes
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="light-green" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/jvincze84/jvincze84.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="Vincze Janos Blog" class="md-nav__button md-logo" aria-label="Vincze Janos Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Vincze Janos Blog
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/jvincze84/jvincze84.github.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Welcome Here
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Tips_And_Tricks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tips And Tricks 2024a
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../new-file/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Ez egy uj test file
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Blog
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Blog
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Kubernetes Templates
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Kubernetes Templates
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Kubernetes_Templates/ConfigMap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ConfigMap
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Kubernetes_Templates/Deployment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deployments
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Kubernetes_Templates/Ingress/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Ingress
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Kubernetes_Templates/PersistentVolumeClaim/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PersistentVolumeClaim
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Kubernetes_Templates/ReverseProxy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Kubernetes Reverse Proxy With Ingress, Service And Endpoint
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Kubernetes_Templates/Secret/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Secret
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Kubernetes_Templates/StatefulSet/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    StatefulSet
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Kubernetes_Templates/services/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Services
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Old Blog Contents
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Old Blog Contents
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1" >
        
          
          <label class="md-nav__link" for="__nav_6_1" id="__nav_6_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Linux
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Linux
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/linux/Compile_Apache_Httpd_2.4.x_Php/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Compile Apache HTTPD 2.4.X &amp; PHP
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/linux/Create_Self_Signed_Certificate_For_Apache_Webserver/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Create Self Signed Certificate For Apache Webserver
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/linux/Install_%28compile%29_%26_Configure_Motion_Av_Tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Install (compile) & Configure Motion Av Tools
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/linux/Install_Mps-youtube_Console_Based_Youtube_Player/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Install Mps youtube Console Based Youtube Player
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/linux/create_Your_Own_Dyndns_Service_With_Bind_named/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    create Your Own Dyndns Service With Bind named
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2" >
        
          
          <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Nodemcu
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Nodemcu
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/nodemcu/How_To_Compile_Nodemcu_Firmware/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    How To Compile Nodemcu Firmware
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/nodemcu/How_To_Unbrick_Esp8266_blinking_Blue_Led/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    How To Unbrick Esp8266 blinking Blue Led
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/nodemcu/Install_Openalpr_On_Raspberry_Pi_3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Install OpenALPR on Raspberry PI 3
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/nodemcu/Logging_Mqtt_Data_%28subscription%29_To_Mysql_With_Shell_Script/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Logging Mqtt Data (subscription) To Mysql With Shell Script
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/nodemcu/Reliable_MQTT_conenction_with_NodeMCU/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Reliable MQTT conenction with NodeMCU
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/nodemcu/Reliable_Mqtt_Connection_With_Nodemcu_%28part_2%29/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Reliable Mqtt Connection With Nodemcu (part 2)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/nodemcu/Very_Simple_Way_To_Send_Email_Using_Nodemcu_Firmware/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Very Simple Way to Send Email Using NodeMCU firmware
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3" >
        
          
          <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Other
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Other
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/other/Collect_Network_Statistic_With_Telegraf_Vnstat/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Collect Network Statistic With Telegraf &amp; VNSTAT
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/other/Iptables_Examples/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Iptables Examples
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/other/Nokia_6120c_%28bb5%29_Forgotten_Security_Code/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Nokia 6120c (BB5) Forgotten Security Code
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/other/Sonoff_Relays_With_Openhab_And_Tasmota_Firmware/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sonoff Relays With OpenHab And Tasmota Firmware
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_4" >
        
          
          <label class="md-nav__link" for="__nav_6_4" id="__nav_6_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Raspberry
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Raspberry
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/raspberry/Compile_Go_Language_On_Raspberry_Pi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Compile Go Language On Raspberry Pi
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/raspberry/Google_Cloud_Print_With_Orange_Pi_or_Rpi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Google Cloud Print With Orange Pi or Rpi
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/raspberry/How_To_Install_Nodered_On_Raspberry_Pi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    How To Install Nodered On Raspberry Pi
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/raspberry/Install_Debian_Jessie_To_Orange_Pi_Plus_2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Install Debian Jessie to Orange PI Plus 2
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/raspberry/Install_Openalpr_On_Raspberry_Pi_3_part_2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Install Openalpr On Raspberry Pi 3 part 2
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/raspberry/Mount_Sd_Card_Image_partitioned_Image_Wo_Kpartx/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mount SD card image (partitioned image) w/o kpartx
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/raspberry/Move_Root_File_System_To_Usb_Storage_%28rpi2_%26_Rpi3%29/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Move root file system to USB storage (RPI2 &amp; RPI3)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/raspberry/Raspberry_Pi_2_As_Print_Server_Airprint/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Raspberry Pi 2 As Print Server Airprint
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../Old_Blog_Contents/raspberry/Raspberry_Pi_3_As_Wifi_Range_Extender/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Raspberry Pi 3 As Wifi Range Extender
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#preface" class="md-nav__link">
    <span class="md-ellipsis">
      
        Preface
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    <span class="md-ellipsis">
      
        Requirements
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docker-compose" class="md-nav__link">
    <span class="md-ellipsis">
      
        Docker Compose
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Docker Compose">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#generate-the-matrix-config-file" class="md-nav__link">
    <span class="md-ellipsis">
      
        Generate The Matrix Config File
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inititalize-the-database" class="md-nav__link">
    <span class="md-ellipsis">
      
        Inititalize The Database
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#edit-homeserveryaml" class="md-nav__link">
    <span class="md-ellipsis">
      
        Edit homeserver.yaml
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#inititalize-the-caddyfile" class="md-nav__link">
    <span class="md-ellipsis">
      
        Inititalize The Caddyfile
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#start-everything" class="md-nav__link">
    <span class="md-ellipsis">
      
        Start Everything
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#federation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Federation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#login" class="md-nav__link">
    <span class="md-ellipsis">
      
        Login
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-to-kubernetes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deploy To Kubernetes
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deploy To Kubernetes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-the-namespace" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create the namespace
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prepare-matrix-configmap-storage" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prepare Matrix Configmap &amp; Storage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-matrix-homeserver" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deploy Matrix Homeserver
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deploy Matrix Homeserver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-service" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create Service
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-postgres-sql" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deploy Postgres SQL
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deploy Postgres SQL">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-the-persistentvolumeclaim" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create The PersistentVolumeClaim
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-secret" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create Secret
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deployment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deployment
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#service" class="md-nav__link">
    <span class="md-ellipsis">
      
        Service
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connect-matix-homeserver-to-postgres" class="md-nav__link">
    <span class="md-ellipsis">
      
        Connect Matix Homeserver To Postgres
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Connect Matix Homeserver To Postgres">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prepare-the-databse" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prepare The Databse
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modify-the-homeserver-configmap" class="md-nav__link">
    <span class="md-ellipsis">
      
        Modify The Homeserver Configmap
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ingress" class="md-nav__link">
    <span class="md-ellipsis">
      
        Ingress
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Ingress">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#simple-ingress" class="md-nav__link">
    <span class="md-ellipsis">
      
        Simple Ingress
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cert-manager" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cert Manager
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#final-thoughts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Final Thoughts
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../../" class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg>
                        <time datetime="2021-10-27 00:00:00+00:00" class="md-ellipsis">October 27, 2021</time>
                      </div>
                    </li>
                    
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg>
                          <span class="md-ellipsis">
                            
                              17 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
            
          </nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  



  
  


<h1 id="install-matrix-home-server-on-kubernetes">Install Matrix Home Server On Kubernetes<a class="headerlink" href="#install-matrix-home-server-on-kubernetes" title="Permanent link">&para;</a></h1>
<h2 id="preface">Preface<a class="headerlink" href="#preface" title="Permanent link">&para;</a></h2>
<p><strong>What is Matrix?</strong></p>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
<p>Matrix is an open standard for interoperable, decentralised, real-time communication over IP. It can be used to power Instant Messaging, VoIP/WebRTC signalling, Internet of Things communication - or anywhere you need a standard HTTP API for publishing and subscribing to data whilst tracking the conversation history.</p>
</div>
<p>Link: <a href="https://matrix.org/faq/#what-is-matrix%3F">https://matrix.org/faq/#what-is-matrix%3F</a></p>
<p>So we are about to install a private real time messaging (Chat) server. It can be useful for you if you want to replace Whatsapp, Telegram, FB messenger, Viber, etc, or just want your own messaging server. Or if you don't trust in these services and want a service which focuses on your privacy. Another question is how your partners with whom you want to chat trust your server.</p>
<p>I'm wondering if you have ever thought  about having your own messaging server. If the answer is yes, it's time to build one. I hope you will easily achieve  this with the help of this article.</p>
<h2 id="requirements">Requirements<a class="headerlink" href="#requirements" title="Permanent link">&para;</a></h2>
<ul>
<li>First and most important to have a valid domain name. If you don't have any you can pick up one free from <a href="https://www.duckdns.org">DuckDNS</a></li>
<li>Installed Kubernets cluster</li>
<li>Public Internet access. </li>
<li>At least 2 GB of free RAM. </li>
</ul>
<p>I assume you build this server for your family and friends, and don't want to share with the whole World. For some tens of people you don't need to purchase an expensive server, but according to the number of attachments (file, pictures, videos,etc) you may need some hundreds of GB disk space.</p>
<!-- more -->

<h2 id="docker-compose">Docker Compose<a class="headerlink" href="#docker-compose" title="Permanent link">&para;</a></h2>
<p>Maybe the easiest way to install everything all together is writing a Docker compose file. The compose file below can be used with <code>docker-compose</code> command or as Stack in <a href="https://www.portainer.io">Portainer</a>.  Later in this article we will use this compose file as reference for writing the Kubernetes manifest files (cm, deployment, sevice, pvc, etc).</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename"><a href="https://raw.githubusercontent.com/jvincze84/jvincze84.github.io/master/docs/files/matrix/docker-compose.yaml" target="_blank">Click Here For Raw Source</a></span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;3&quot;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nt">services</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">matrix</span><span class="p">:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrixdotorg/synapse:latest</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">synapse-matrix</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/opt/docker/matrix/config:/config</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/opt/docker/matrix/data:/data</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TZ=Europe/Budapest</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SYNAPSE_CONFIG_DIR=/data</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SYNAPSE_CONFIG_PATH=/config/homeserver.yaml</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8008:8008</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">  </span><span class="nt">caddy</span><span class="p">:</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">caddy:latest</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix-web-caddy</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/opt/docker/matrix/caddy/Caddyfile:/etc/caddy/Caddyfile</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/opt/docker/matrix/caddy/srv:/srv</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/opt/docker/matrix/caddy/data:/data</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/opt/docker/matrix/caddy/config:/config</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80:80</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443:443</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="w">  </span><span class="nt">postgres</span><span class="p">:</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:14.0-alpine</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix-postgres</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=MatrixPass</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER=matrix</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PGDATA=/data</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TZ=Europe/Budapest</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/opt/docker/matrix/postgres:/data</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="nt">networks</span><span class="p">:</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="w">  </span><span class="nt">matrix</span><span class="p">:</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="w">    </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bridge</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="w">    </span><span class="nt">ipam</span><span class="p">:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="w">      </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="w">      </span><span class="nt">config</span><span class="p">:</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10.101.0.8/29&quot;</span>
</code></pre></div></td></tr></table></div>
<p>You can see that we have 3 services:</p>
<ul>
<li><strong>matrix</strong> : The Matrix server</li>
<li><strong>caddy</strong> : Web server for use as reverse proxy. <ul>
<li>You can use any other web server you like (eg.: Apache httpd, Nginx)</li>
<li>I chose Caddy because it is super easy to configure as a reverse proxy and supports automatic SSL certificate generation and maintenance.</li>
</ul>
</li>
<li><strong>postgres</strong> : Database engine.<ul>
<li>You can skip this if you want to use the default sqlite engine, but it is not recommended for daily (production) use.</li>
</ul>
</li>
</ul>
<p>Before you <code>up</code> this compose file create the necessary directories:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">1</a></span>
<span class="normal"><a href="#__codelineno-1-2">2</a></span>
<span class="normal"><a href="#__codelineno-1-3">3</a></span>
<span class="normal"><a href="#__codelineno-1-4">4</a></span>
<span class="normal"><a href="#__codelineno-1-5">5</a></span>
<span class="normal"><a href="#__codelineno-1-6">6</a></span>
<span class="normal"><a href="#__codelineno-1-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>/opt/docker/matrix/config
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>mkdir<span class="w"> </span>/opt/docker/matrix/data
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>mkdir<span class="w"> </span>/opt/docker/matrix/caddy
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>mkdir<span class="w"> </span>/opt/docker/matrix/caddy/srv
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>mkdir<span class="w"> </span>/opt/docker/matrix/caddy/data
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>mkdir<span class="w"> </span>/opt/docker/matrix/caddy/config
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>mkdir<span class="w"> </span>/opt/docker/matrix/postgres
</code></pre></div></td></tr></table></div>
<p>Matrix process run as <code>991</code> userID and groupID so we need to run <code>chown</code> command:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>chown<span class="w"> </span>-R<span class="w"> </span><span class="m">991</span>:991<span class="w"> </span>/opt/docker/matrix
</code></pre></div>
<h3 id="generate-the-matrix-config-file">Generate The Matrix Config File<a class="headerlink" href="#generate-the-matrix-config-file" title="Permanent link">&para;</a></h3>
<p>For generating the initial config files please follow these steps:</p>
<p><div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Command</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">1</a></span>
<span class="normal"><a href="#__codelineno-3-2">2</a></span>
<span class="normal"><a href="#__codelineno-3-3">3</a></span>
<span class="normal"><a href="#__codelineno-3-4">4</a></span>
<span class="normal"><a href="#__codelineno-3-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a>docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>--rm<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span>--mount<span class="w"> </span><span class="nv">type</span><span class="o">=</span>bind,src<span class="o">=</span>/opt/docker/matrix/config,dst<span class="o">=</span>/data<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span>-e<span class="w"> </span><span class="nv">SYNAPSE_SERVER_NAME</span><span class="o">=</span>matrix.vincze.work<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span>-e<span class="w"> </span><span class="nv">SYNAPSE_REPORT_STATS</span><span class="o">=</span>yes<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">    </span>matrixdotorg/synapse:latest<span class="w"> </span>generate
</code></pre></div></td></tr></table></div>
<div class="highlight"><span class="filename">Output</span><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>Unable to find image &#39;matrixdotorg/synapse:latest&#39; locally
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>latest: Pulling from matrixdotorg/synapse
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>7d63c13d9b9b: Pull complete
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>7c9d54bd144b: Pull complete
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>6c659176d5c8: Pull complete
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>31bfadeaf52b: Pull complete
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>b0be2954cd61: Pull complete
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>24d50aa74e2c: Pull complete
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>1816510873a0: Pull complete
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>227c613c4a00: Pull complete
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>097ac90fbed0: Pull complete
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>Digest: sha256:2c74baa38d3241aaf4a059a7e7c01786ba51ac5fe6fcf473ede3eb148f9358ba
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>Status: Downloaded newer image for matrixdotorg/synapse:latest
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>Creating log config /data/matrix.vincze.work.log.config
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>Generating config file /data/homeserver.yaml
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>Generating signing key file /data/matrix.vincze.work.signing.key
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>A config file has been generated in &#39;/data/homeserver.yaml&#39; for server name &#39;matrix.vincze.work&#39;. Please review this file and customise it to your needs.
</code></pre></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Command</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">1</a></span>
<span class="normal"><a href="#__codelineno-5-2">2</a></span>
<span class="normal"><a href="#__codelineno-5-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nb">cd</span><span class="w"> </span>/opt/docker/matrix
<a id="__codelineno-5-2" name="__codelineno-5-2"></a>mv<span class="w"> </span>./config/matrix.vincze.work.signing.key<span class="w"> </span>./config/matrix.vincze.work.log.config<span class="w"> </span>./data
<a id="__codelineno-5-3" name="__codelineno-5-3"></a>find<span class="w"> </span>data/<span class="w"> </span>config/
</code></pre></div></td></tr></table></div>
<div class="highlight"><span class="filename">Output</span><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>data/
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>data/matrix.vincze.work.signing.key
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>data/matrix.vincze.work.log.config
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>config/
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>config/homeserver.yaml
</code></pre></div></p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>You have to change <code>SYNAPSE_SERVER_NAME</code> to point to your own domain.</p>
</div>
<h3 id="inititalize-the-database">Inititalize The Database<a class="headerlink" href="#inititalize-the-database" title="Permanent link">&para;</a></h3>
<ul>
<li>Start the a postgres instance</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Command</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1">1</a></span>
<span class="normal"><a href="#__codelineno-7-2">2</a></span>
<span class="normal"><a href="#__codelineno-7-3">3</a></span>
<span class="normal"><a href="#__codelineno-7-4">4</a></span>
<span class="normal"><a href="#__codelineno-7-5">5</a></span>
<span class="normal"><a href="#__codelineno-7-6">6</a></span>
<span class="normal"><a href="#__codelineno-7-7">7</a></span>
<span class="normal"><a href="#__codelineno-7-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a>--name<span class="w"> </span>postgres-init<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a>--env<span class="w"> </span><span class="nv">POSTGRES_PASSWORD</span><span class="o">=</span>rootpass<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a>--env<span class="w"> </span><span class="nv">POSTGRES_USER</span><span class="o">=</span>root<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a>--env<span class="w"> </span><span class="nv">PGDATA</span><span class="o">=</span>/data<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a>--env<span class="w"> </span><span class="nv">TZ</span><span class="o">=</span>Europe/Budapest<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a>-v<span class="w"> </span>/opt/docker/matrix/postgres:/data<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a>postgres:14.0-alpine
</code></pre></div></td></tr></table></div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Use the same environment values as in the compose file!</p>
</div>
<p>You may want to check the logs:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>docker<span class="w"> </span>logs<span class="w"> </span>postgres-init<span class="w"> </span>-f
</code></pre></div>
<p>You should see the following lines:
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>PostgreSQL init process complete; ready for start up.
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>2021-10-22 13:20:19.900 CEST [1] LOG:  starting PostgreSQL 14.0 on x86_64-pc-linux-musl, compiled by gcc (Alpine 10.3.1_git20210424) 10.3.1 20210424, 64-bit
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>2021-10-22 13:20:19.900 CEST [1] LOG:  listening on IPv4 address &quot;0.0.0.0&quot;, port 5432
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>2021-10-22 13:20:19.900 CEST [1] LOG:  listening on IPv6 address &quot;::&quot;, port 5432
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>2021-10-22 13:20:19.974 CEST [1] LOG:  listening on Unix socket &quot;/var/run/postgresql/.s.PGSQL.5432&quot;
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>2021-10-22 13:20:20.042 CEST [51] LOG:  database system was shut down at 2021-10-22 13:20:19 CEST
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>2021-10-22 13:20:20.077 CEST [1] LOG:  database system is ready to accept connections
</code></pre></div></p>
<ul>
<li>Get into the container and create the user and database</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>postgres-init<span class="w"> </span>/bin/bash
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>createuser<span class="w"> </span>--pwprompt<span class="w"> </span>synapse_user
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>Enter<span class="w"> </span>password<span class="w"> </span><span class="k">for</span><span class="w"> </span>new<span class="w"> </span>role:
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>Enter<span class="w"> </span>it<span class="w"> </span>again:
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>createdb<span class="w"> </span>--encoding<span class="o">=</span>UTF8<span class="w"> </span>--locale<span class="o">=</span>C<span class="w"> </span>--template<span class="o">=</span>template0<span class="w"> </span>--owner<span class="o">=</span>synapse_user<span class="w"> </span>synapse
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="nb">exit</span>
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>If you use another user than <code>root</code> (<code>POSTGRES_USER=root</code>) add <code>-U [USERNAME]</code> paramter at the and of the commands. <code>createuser --pwprompt synapse_user -U [USERNAME]</code></p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Note your provided password, you will need it when configuring Matrix!</p>
</div>
<ul>
<li>Remove The Container</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>docker<span class="w"> </span>stop<span class="w"> </span>postgres-init
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>docker<span class="w"> </span>rm<span class="w"> </span>postgres-init
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>If something went wrong you can simply stop and remove the container and delete the content of the database directory. </p>
<p><code>rm -rf /opt/docker/matrix/postgres/*</code></p>
<p>And you can start over the init process of the database.</p>
</div>
<h3 id="edit-homeserveryaml">Edit <code>homeserver.yaml</code><a class="headerlink" href="#edit-homeserveryaml" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="gd">--- homeserver.yaml-org 2021-10-22 13:43:26.753645597 +0200</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="gi">+++ homeserver.yaml     2021-10-22 13:45:27.948188284 +0200</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="gu">@@ -742,25 +742,25 @@</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w"> </span>#
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w"> </span># Example Postgres configuration:
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w"> </span>#
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="gd">-#database:</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="gd">-#  name: psycopg2</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="gd">-#  txn_limit: 10000</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="gd">-#  args:</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="gd">-#    user: synapse_user</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="gd">-#    password: synapse</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="gd">-#    database: synapse</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="gd">-#    host: localhost</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="gd">-#    port: 5432</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a><span class="gd">-#    cp_min: 5</span>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a><span class="gd">-#    cp_max: 10</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a><span class="gi">+database:</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a><span class="gi">+  name: psycopg2</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a><span class="gi">+  txn_limit: 10000</span>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a><span class="gi">+  args:</span>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a><span class="gi">+    user: synapse_user</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a><span class="gi">+    password: 12345678</span>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a><span class="gi">+    database: synapse</span>
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a><span class="gi">+    host: matrix-postgres</span>
<a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a><span class="gi">+    port: 5432</span>
<a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a><span class="gi">+    cp_min: 5</span>
<a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a><span class="gi">+    cp_max: 10</span>
<a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a><span class="w"> </span>#
<a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a><span class="w"> </span># For more information on using Synapse with Postgres,
<a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a><span class="w"> </span># see https://matrix-org.github.io/synapse/latest/postgres.html.
<a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a><span class="w"> </span>#
<a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a><span class="gd">-database:</span>
<a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a><span class="gd">-  name: sqlite3</span>
<a id="__codelineno-12-35" name="__codelineno-12-35" href="#__codelineno-12-35"></a><span class="gd">-  args:</span>
<a id="__codelineno-12-36" name="__codelineno-12-36" href="#__codelineno-12-36"></a><span class="gd">-    database: /data/homeserver.db</span>
<a id="__codelineno-12-37" name="__codelineno-12-37" href="#__codelineno-12-37"></a><span class="gi">+#database:</span>
<a id="__codelineno-12-38" name="__codelineno-12-38" href="#__codelineno-12-38"></a><span class="gi">+#  name: sqlite3</span>
<a id="__codelineno-12-39" name="__codelineno-12-39" href="#__codelineno-12-39"></a><span class="gi">+#  args:</span>
<a id="__codelineno-12-40" name="__codelineno-12-40" href="#__codelineno-12-40"></a><span class="gi">+#    database: /data/homeserver.db</span>
<a id="__codelineno-12-41" name="__codelineno-12-41" href="#__codelineno-12-41"></a>
<a id="__codelineno-12-42" name="__codelineno-12-42" href="#__codelineno-12-42"></a>
<a id="__codelineno-12-43" name="__codelineno-12-43" href="#__codelineno-12-43"></a><span class="w"> </span>## Logging ##
</code></pre></div>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Don't forget to remove sqlite3 related lines as the example shows.</p>
</div>
<h3 id="inititalize-the-caddyfile">Inititalize The Caddyfile<a class="headerlink" href="#inititalize-the-caddyfile" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="nb">cd</span><span class="w"> </span>/opt/docker/matrix/caddy
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>docker<span class="w">  </span>run<span class="w"> </span>-it<span class="w">  </span>--entrypoint<span class="o">=</span>/bin/sh<span class="w">  </span>caddy:latest<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;cat /etc/caddy/Caddyfile&quot;</span><span class="w">  </span>&gt;Caddyfile
</code></pre></div>
<p>This will create a minimal <code>Caddyfile</code> example. Actually this command does nothing than copy the <code>Caddyfile</code> from the container to the directory where you are.</p>
<p><strong>Edit this file</strong></p>
<p>You Caddyfile should look like this:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span>
<span class="normal"><a href="#__codelineno-14-12">12</a></span>
<span class="normal"><a href="#__codelineno-14-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a>matrix.vincze.work {
<a id="__codelineno-14-2" name="__codelineno-14-2"></a>  # Set this path to your site&#39;s directory.
<a id="__codelineno-14-3" name="__codelineno-14-3"></a>  root * /usr/share/caddy
<a id="__codelineno-14-4" name="__codelineno-14-4"></a>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a>  # Enable the static file server.
<a id="__codelineno-14-6" name="__codelineno-14-6"></a>  file_server
<a id="__codelineno-14-7" name="__codelineno-14-7"></a>
<a id="__codelineno-14-8" name="__codelineno-14-8"></a>  # Another common task is to set up a reverse proxy:
<a id="__codelineno-14-9" name="__codelineno-14-9"></a>  reverse_proxy synapse-matrix:8008
<a id="__codelineno-14-10" name="__codelineno-14-10"></a>
<a id="__codelineno-14-11" name="__codelineno-14-11"></a>  # Or serve a PHP site through php-fpm:
<a id="__codelineno-14-12" name="__codelineno-14-12"></a>  # php_fastcgi localhost:9000
<a id="__codelineno-14-13" name="__codelineno-14-13"></a>}
</code></pre></div></td></tr></table></div>
<h3 id="start-everything">Start Everything<a class="headerlink" href="#start-everything" title="Permanent link">&para;</a></h3>
<p>We are ready to start the Matrix HomeServer. Save the <code>docker-compose.yaml</code> file if you haven't already do that, and run:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>docker-compose<span class="w"> </span>up<span class="w"> </span>--detach
</code></pre></div>
<p>And wait for <code>up</code> condition:</p>
<p><div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Command</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a>docker-compose<span class="w"> </span>ps
</code></pre></div></td></tr></table></div>
<div class="highlight"><span class="filename">Output</span><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>      Name                    Command                  State                                            Ports                                      
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>---------------------------------------------------------------------------------------------------------------------------------------------------
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>matrix-postgres    docker-entrypoint.sh postgres    Up             5432/tcp                                                                        
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>matrix-web-caddy   caddy run --config /etc/ca ...   Up             2019/tcp, 0.0.0.0:443-&gt;443/tcp,:::443-&gt;443/tcp, 0.0.0.0:80-&gt;80/tcp,:::80-&gt;80/tcp
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>synapse-matrix     /start.py                        Up (healthy)   0.0.0.0:8008-&gt;8008/tcp,:::8008-&gt;8008/tcp, 8009/tcp, 8448/tcp
</code></pre></div></p>
<p><strong>Check your matrix server:</strong></p>
<p><div class="highlight"><span class="filename">Command</span><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>curl<span class="w"> </span>https://matrix.vincze.work/health
</code></pre></div>
<div class="highlight"><span class="filename">Output</span><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>OK
</code></pre></div></p>
<p><strong>Browser Screenshot:</strong></p>
<p><img alt="DeepinScreenshot_select-area_20211023165557.png" src="/assets/images/DeepinScreenshot_select-area_20211023165557.png" /></p>
<h3 id="federation">Federation<a class="headerlink" href="#federation" title="Permanent link">&para;</a></h3>
<p>What does federated mean?</p>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
<p>Federation allows separate deployments of a communication service to communicate with each other - for instance a mail server run by Google federates with a mail server run by Microsoft when you send email from @gmail.com to @hotmail.com.</p>
<p>interoperable clients may simply be running on the same deployment - whereas in federation the deployments themselves are exchanging data in a compatible manner.</p>
<p>Matrix provides open federation - meaning that anyone on the internet can join into the Matrix ecosystem by deploying their own server.</p>
</div>
<p>In order to the <code>federation</code> work you need to modify the <code>Caddyfile</code> and <code>docker-compose.yaml</code>.</p>
<p><strong><code>docker-compose.yaml</code></strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="gd">--- docker-compose.yaml 2021-10-23 16:31:16.567890416 +0200</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="gi">+++ docker-compose.yaml-orig  2021-10-23 17:04:08.640359385 +0200</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="gu">@@ -31,6 +31,7 @@</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w"> </span>    ports:
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="w"> </span>      - 80:80
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="w"> </span>      - 443:443
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="gi">+      - 8448:8448</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="w"> </span>    networks:
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="w"> </span>      - matrix
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="w"> </span>  postgres:
</code></pre></div>
<p><strong><code>Caddyfile</code></strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="gu">@@ -8,7 +8,7 @@</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="w"> </span># this machine&#39;s public IP, then replace &quot;:80&quot; below with your
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="w"> </span># domain name.
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="gd">-matrix.vincze.work {</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="gi">+matrix.vincze.work:443 matrix.vincze.work:8448 {</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="w"> </span> # Set this path to your site&#39;s directory.
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="w"> </span> root * /usr/share/caddy
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="gu">@@ -24,4 +24,3 @@</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="w"> </span># Refer to the Caddy docs for more information:
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="w"> </span># https://caddyserver.com/docs/caddyfile
</code></pre></div>
<p>You can check if fedearation work or not: <a href="https://federationtester.matrix.org">https://federationtester.matrix.org</a></p>
<p><strong>ScreenShot:</strong></p>
<p><img alt="DeepinScreenshot_select-area_20211023171814.png" src="/assets/images/DeepinScreenshot_select-area_20211023171814.png" /></p>
<h3 id="login">Login<a class="headerlink" href="#login" title="Permanent link">&para;</a></h3>
<p>We don't have any user, yet. We have three option for registering new users:</p>
<ol>
<li>Enable registration in the homeserver.yaml (<code>enable_registration: true</code>)</li>
<li>Use the <code>registration_shared_secret</code>. <ul>
<li><a href="">https://matrix-org.github.io/synapse/latest/admin_api/register_api.html#shared-secret-registration</a></li>
</ul>
</li>
<li>Or use command line interface inside the container.</li>
</ol>
<p>I will show the third option:</p>
<ul>
<li>Get Into the container</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>docker<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>synapse-matrix<span class="w"> </span>/bin/bash
</code></pre></div>
<ul>
<li>Register new user</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>register_new_matrix_user<span class="w"> </span>-u<span class="w"> </span>jvincze<span class="w"> </span>-p<span class="w"> </span>Matrix1234<span class="w"> </span>-a<span class="w"> </span>-c<span class="w"> </span>/config/homeserver.yaml<span class="w"> </span>http://localhost:8008
</code></pre></div>
<ul>
<li>Open <a href="https://app.element.io/#/welcome">https://app.element.io/#/welcome</a> in your browser</li>
<li>Click on "Sign In"</li>
<li>Change the "Homeserver" URL</li>
</ul>
<p><img alt="DeepinScreenshot_select-area_20211023174014.png" src="/assets/images/DeepinScreenshot_select-area_20211023174014.png" /></p>
<ul>
<li>Enter your credentials </li>
</ul>
<p>And we are done. We have a fully functional Matrix Homeserver. Of course there are a lot of configurations available in the <code>homesever.yaml</code>, and I recommend going through this file at least once to get to know the possibilities.</p>
<p>We are going to deploy this minimal installation of Matrix to Kubernetes cluster in the next section.</p>
<h2 id="deploy-to-kubernetes">Deploy To Kubernetes<a class="headerlink" href="#deploy-to-kubernetes" title="Permanent link">&para;</a></h2>
<h3 id="create-the-namespace">Create the namespace<a class="headerlink" href="#create-the-namespace" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>kubectl<span class="w"> </span>create<span class="w"> </span>ns<span class="w"> </span>matrix
</code></pre></div>
<h3 id="prepare-matrix-configmap-storage">Prepare Matrix Configmap &amp; Storage<a class="headerlink" href="#prepare-matrix-configmap-storage" title="Permanent link">&para;</a></h3>
<ul>
<li>Generate the config files</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>/tmp/matrix/config<span class="w"> </span>/tmp/matrix/data
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>--rm<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="w">    </span>--mount<span class="w"> </span><span class="nv">type</span><span class="o">=</span>bind,src<span class="o">=</span>/tmp/matrix/config,dst<span class="o">=</span>/config<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="w">    </span>--mount<span class="w"> </span><span class="nv">type</span><span class="o">=</span>bind,src<span class="o">=</span>/tmp/matrix/data,dst<span class="o">=</span>/data<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="w">    </span>-e<span class="w"> </span><span class="nv">SYNAPSE_SERVER_NAME</span><span class="o">=</span>matrix-kub-test.duckdns.org<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="w">    </span>-e<span class="w"> </span><span class="nv">SYNAPSE_REPORT_STATS</span><span class="o">=</span>yes<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="w">    </span>-e<span class="w"> </span><span class="nv">SYNAPSE_CONFIG_DIR</span><span class="o">=</span>/config<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="w">    </span>-e<span class="w"> </span><span class="nv">SYNAPSE_CONFIG_PATH</span><span class="o">=</span>/config/homeserver.yaml<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="w">    </span>matrixdotorg/synapse:latest<span class="w"> </span>generate
</code></pre></div>
<ul>
<li>Create the Configmap &amp; Secret</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="nb">cd</span><span class="w"> </span>/tmp/matrix
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>matrix<span class="w"> </span>create<span class="w"> </span>cm<span class="w"> </span>matrix<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>--from-file<span class="o">=</span>homeserver.yaml<span class="o">=</span>./config/homeserver.yaml<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>--from-file<span class="o">=</span>matrix-kub-test.duckdns.org.log.config<span class="o">=</span>./config/matrix-kub-test.duckdns.org.log.config
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>matrix<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>generic<span class="w"> </span>matrix-key<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>--from-file<span class="w"> </span>config/matrix-kub-test.duckdns.org.signing.key
</code></pre></div>
<ul>
<li>Create Persistent Volume</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename"><a href="https://raw.githubusercontent.com/jvincze84/jvincze84.github.io/master/docs/files/matrix/PersistentVolumeClaim-matrix.yaml" target="_blank">Click Here For Raw Source</a></span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-27-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-27-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-27-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-27-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-27-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-27-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-27-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-27-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-27-10">10</a></span>
<span class="normal"><a href="#__codelineno-27-11">11</a></span>
<span class="normal"><a href="#__codelineno-27-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="err">apiVersio</span><span class="kc">n</span><span class="p">:</span><span class="w"> </span><span class="err">v</span><span class="mi">1</span>
<a id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="err">ki</span><span class="kc">n</span><span class="err">d</span><span class="p">:</span><span class="w"> </span><span class="err">Persis</span><span class="kc">tent</span><span class="err">VolumeClaim</span>
<a id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="err">me</span><span class="kc">ta</span><span class="err">da</span><span class="kc">ta</span><span class="p">:</span>
<a id="__codelineno-27-4" name="__codelineno-27-4"></a><span class="w">  </span><span class="kc">na</span><span class="err">me</span><span class="p">:</span><span class="w"> </span><span class="err">ma</span><span class="kc">tr</span><span class="err">ix</span><span class="mi">-</span><span class="err">s</span><span class="kc">t</span><span class="err">orage</span>
<a id="__codelineno-27-5" name="__codelineno-27-5"></a><span class="w">  </span><span class="kc">na</span><span class="err">mespace</span><span class="p">:</span><span class="w"> </span><span class="err">ma</span><span class="kc">tr</span><span class="err">ix</span>
<a id="__codelineno-27-6" name="__codelineno-27-6"></a><span class="err">spec</span><span class="p">:</span>
<a id="__codelineno-27-7" name="__codelineno-27-7"></a><span class="w">  </span><span class="err">s</span><span class="kc">t</span><span class="err">orageClassName</span><span class="p">:</span><span class="w"> </span><span class="err">ope</span><span class="kc">ne</span><span class="err">bs</span><span class="mi">-</span><span class="err">hos</span><span class="kc">t</span><span class="err">pa</span><span class="kc">t</span><span class="err">h</span>
<a id="__codelineno-27-8" name="__codelineno-27-8"></a><span class="w">  </span><span class="err">accessModes</span><span class="p">:</span>
<a id="__codelineno-27-9" name="__codelineno-27-9"></a><span class="w">    </span><span class="mi">-</span><span class="w"> </span><span class="err">ReadWri</span><span class="kc">te</span><span class="err">O</span><span class="kc">n</span><span class="err">ce</span>
<a id="__codelineno-27-10" name="__codelineno-27-10"></a><span class="w">  </span><span class="err">resources</span><span class="p">:</span>
<a id="__codelineno-27-11" name="__codelineno-27-11"></a><span class="w">    </span><span class="err">reques</span><span class="kc">ts</span><span class="p">:</span>
<a id="__codelineno-27-12" name="__codelineno-27-12"></a><span class="w">      </span><span class="err">s</span><span class="kc">t</span><span class="err">orage</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="err">Gi</span>
</code></pre></div></td></tr></table></div>
<p><strong>Download &amp; Apply</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>curl<span class="w">  </span>-L<span class="w"> </span>-o<span class="w"> </span>/tmp/PersistentVolumeClaim-matrix.yaml<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>https://raw.githubusercontent.com/jvincze84/jvincze84.github.io/master/docs/files/matrix/PersistentVolumeClaim-matrix.yaml
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>/tmp/matrix-pvc.yaml
</code></pre></div>
<h3 id="deploy-matrix-homeserver">Deploy Matrix Homeserver<a class="headerlink" href="#deploy-matrix-homeserver" title="Permanent link">&para;</a></h3>
<p>First we deploy the Matrix homeserver without any configuration changes. Later we can update the <code>homeserver.yaml</code> in the Configmap.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename"><a href="https://raw.githubusercontent.com/jvincze84/jvincze84.github.io/master/docs/files/matrix/Deployment-matrix.yaml" target="_blank">Click Here For Raw Source</a></span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-29-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-29-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-29-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-29-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-29-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-29-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-29-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-29-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-29-10">10</a></span>
<span class="normal"><a href="#__codelineno-29-11">11</a></span>
<span class="normal"><a href="#__codelineno-29-12">12</a></span>
<span class="normal"><a href="#__codelineno-29-13">13</a></span>
<span class="normal"><a href="#__codelineno-29-14">14</a></span>
<span class="normal"><a href="#__codelineno-29-15">15</a></span>
<span class="normal"><a href="#__codelineno-29-16">16</a></span>
<span class="normal"><a href="#__codelineno-29-17">17</a></span>
<span class="normal"><a href="#__codelineno-29-18">18</a></span>
<span class="normal"><a href="#__codelineno-29-19">19</a></span>
<span class="normal"><a href="#__codelineno-29-20">20</a></span>
<span class="normal"><a href="#__codelineno-29-21">21</a></span>
<span class="normal"><a href="#__codelineno-29-22">22</a></span>
<span class="normal"><a href="#__codelineno-29-23">23</a></span>
<span class="normal"><a href="#__codelineno-29-24">24</a></span>
<span class="normal"><a href="#__codelineno-29-25">25</a></span>
<span class="normal"><a href="#__codelineno-29-26">26</a></span>
<span class="normal"><a href="#__codelineno-29-27">27</a></span>
<span class="normal"><a href="#__codelineno-29-28">28</a></span>
<span class="normal"><a href="#__codelineno-29-29">29</a></span>
<span class="normal"><a href="#__codelineno-29-30">30</a></span>
<span class="normal"><a href="#__codelineno-29-31">31</a></span>
<span class="normal"><a href="#__codelineno-29-32">32</a></span>
<span class="normal"><a href="#__codelineno-29-33">33</a></span>
<span class="normal"><a href="#__codelineno-29-34">34</a></span>
<span class="normal"><a href="#__codelineno-29-35">35</a></span>
<span class="normal"><a href="#__codelineno-29-36">36</a></span>
<span class="normal"><a href="#__codelineno-29-37">37</a></span>
<span class="normal"><a href="#__codelineno-29-38">38</a></span>
<span class="normal"><a href="#__codelineno-29-39">39</a></span>
<span class="normal"><a href="#__codelineno-29-40">40</a></span>
<span class="normal"><a href="#__codelineno-29-41">41</a></span>
<span class="normal"><a href="#__codelineno-29-42">42</a></span>
<span class="normal"><a href="#__codelineno-29-43">43</a></span>
<span class="normal"><a href="#__codelineno-29-44">44</a></span>
<span class="normal"><a href="#__codelineno-29-45">45</a></span>
<span class="normal"><a href="#__codelineno-29-46">46</a></span>
<span class="normal"><a href="#__codelineno-29-47">47</a></span>
<span class="normal"><a href="#__codelineno-29-48">48</a></span>
<span class="normal"><a href="#__codelineno-29-49">49</a></span>
<span class="normal"><a href="#__codelineno-29-50">50</a></span>
<span class="normal"><a href="#__codelineno-29-51">51</a></span>
<span class="normal"><a href="#__codelineno-29-52">52</a></span>
<span class="normal"><a href="#__codelineno-29-53">53</a></span>
<span class="normal"><a href="#__codelineno-29-54">54</a></span>
<span class="normal"><a href="#__codelineno-29-55">55</a></span>
<span class="normal"><a href="#__codelineno-29-56">56</a></span>
<span class="normal"><a href="#__codelineno-29-57">57</a></span>
<span class="normal"><a href="#__codelineno-29-58">58</a></span>
<span class="normal"><a href="#__codelineno-29-59">59</a></span>
<span class="normal"><a href="#__codelineno-29-60">60</a></span>
<span class="normal"><a href="#__codelineno-29-61">61</a></span>
<span class="normal"><a href="#__codelineno-29-62">62</a></span>
<span class="normal"><a href="#__codelineno-29-63">63</a></span>
<span class="normal"><a href="#__codelineno-29-64">64</a></span>
<span class="normal"><a href="#__codelineno-29-65">65</a></span>
<span class="normal"><a href="#__codelineno-29-66">66</a></span>
<span class="normal"><a href="#__codelineno-29-67">67</a></span>
<span class="normal"><a href="#__codelineno-29-68">68</a></span>
<span class="normal"><a href="#__codelineno-29-69">69</a></span>
<span class="normal"><a href="#__codelineno-29-70">70</a></span>
<span class="normal"><a href="#__codelineno-29-71">71</a></span>
<span class="normal"><a href="#__codelineno-29-72">72</a></span>
<span class="normal"><a href="#__codelineno-29-73">73</a></span>
<span class="normal"><a href="#__codelineno-29-74">74</a></span>
<span class="normal"><a href="#__codelineno-29-75">75</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<a id="__codelineno-29-2" name="__codelineno-29-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<a id="__codelineno-29-3" name="__codelineno-29-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-29-4" name="__codelineno-29-4"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-29-5" name="__codelineno-29-5"></a><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix</span>
<a id="__codelineno-29-6" name="__codelineno-29-6"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix</span>
<a id="__codelineno-29-7" name="__codelineno-29-7"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix</span>
<a id="__codelineno-29-8" name="__codelineno-29-8"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-29-9" name="__codelineno-29-9"></a><span class="w">  </span><span class="nt">progressDeadlineSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">600</span>
<a id="__codelineno-29-10" name="__codelineno-29-10"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id="__codelineno-29-11" name="__codelineno-29-11"></a><span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<a id="__codelineno-29-12" name="__codelineno-29-12"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<a id="__codelineno-29-13" name="__codelineno-29-13"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<a id="__codelineno-29-14" name="__codelineno-29-14"></a><span class="w">      </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix</span>
<a id="__codelineno-29-15" name="__codelineno-29-15"></a><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span>
<a id="__codelineno-29-16" name="__codelineno-29-16"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Recreate</span>
<a id="__codelineno-29-17" name="__codelineno-29-17"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<a id="__codelineno-29-18" name="__codelineno-29-18"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-29-19" name="__codelineno-29-19"></a><span class="w">      </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
<a id="__codelineno-29-20" name="__codelineno-29-20"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-29-21" name="__codelineno-29-21"></a><span class="w">        </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix</span>
<a id="__codelineno-29-22" name="__codelineno-29-22"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix</span>
<a id="__codelineno-29-23" name="__codelineno-29-23"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-29-24" name="__codelineno-29-24"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-29-25" name="__codelineno-29-25"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">env</span><span class="p">:</span>
<a id="__codelineno-29-26" name="__codelineno-29-26"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SYNAPSE_CONFIG_DIR</span>
<a id="__codelineno-29-27" name="__codelineno-29-27"></a><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/config</span>
<a id="__codelineno-29-28" name="__codelineno-29-28"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SYNAPSE_CONFIG_PATH</span>
<a id="__codelineno-29-29" name="__codelineno-29-29"></a><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/config/homeserver.yaml</span>
<a id="__codelineno-29-30" name="__codelineno-29-30"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrixdotorg/synapse:latest</span>
<a id="__codelineno-29-31" name="__codelineno-29-31"></a><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<a id="__codelineno-29-32" name="__codelineno-29-32"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix</span>
<a id="__codelineno-29-33" name="__codelineno-29-33"></a><span class="w">        </span><span class="nt">securityContext</span><span class="p">:</span>
<a id="__codelineno-29-34" name="__codelineno-29-34"></a><span class="w">          </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-29-35" name="__codelineno-29-35"></a><span class="w">        </span><span class="nt">terminationMessagePath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/dev/termination-log</span>
<a id="__codelineno-29-36" name="__codelineno-29-36"></a><span class="w">        </span><span class="nt">terminationMessagePolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">File</span>
<a id="__codelineno-29-37" name="__codelineno-29-37"></a><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span>
<a id="__codelineno-29-38" name="__codelineno-29-38"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/config/homeserver.yaml</span>
<a id="__codelineno-29-39" name="__codelineno-29-39"></a><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix-cm</span>
<a id="__codelineno-29-40" name="__codelineno-29-40"></a><span class="w">          </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">homeserver.yaml</span>
<a id="__codelineno-29-41" name="__codelineno-29-41"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/config/matrix-kub-test.duckdns.org.log.config</span>
<a id="__codelineno-29-42" name="__codelineno-29-42"></a><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix-cm</span>
<a id="__codelineno-29-43" name="__codelineno-29-43"></a><span class="w">          </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix-kub-test.duckdns.org.log.config</span>
<a id="__codelineno-29-44" name="__codelineno-29-44"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data</span>
<a id="__codelineno-29-45" name="__codelineno-29-45"></a><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix-pv</span>
<a id="__codelineno-29-46" name="__codelineno-29-46"></a><span class="w">          </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix</span>
<a id="__codelineno-29-47" name="__codelineno-29-47"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/config/matrix-kub-test.duckdns.org.signing.key</span>
<a id="__codelineno-29-48" name="__codelineno-29-48"></a><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix-key</span>
<a id="__codelineno-29-49" name="__codelineno-29-49"></a><span class="w">          </span><span class="nt">subPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix-kub-test.duckdns.org.signing.key</span>
<a id="__codelineno-29-50" name="__codelineno-29-50"></a><span class="w">      </span><span class="nt">dnsPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterFirst</span>
<a id="__codelineno-29-51" name="__codelineno-29-51"></a><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<a id="__codelineno-29-52" name="__codelineno-29-52"></a><span class="w">      </span><span class="nt">securityContext</span><span class="p">:</span>
<a id="__codelineno-29-53" name="__codelineno-29-53"></a><span class="w">        </span><span class="nt">fsGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">991</span>
<a id="__codelineno-29-54" name="__codelineno-29-54"></a><span class="w">      </span><span class="nt">schedulerName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default-scheduler</span>
<a id="__codelineno-29-55" name="__codelineno-29-55"></a><span class="w">      </span><span class="nt">terminationGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<a id="__codelineno-29-56" name="__codelineno-29-56"></a><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
<a id="__codelineno-29-57" name="__codelineno-29-57"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix-key</span>
<a id="__codelineno-29-58" name="__codelineno-29-58"></a><span class="w">        </span><span class="nt">secret</span><span class="p">:</span>
<a id="__codelineno-29-59" name="__codelineno-29-59"></a><span class="w">          </span><span class="nt">defaultMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">420</span>
<a id="__codelineno-29-60" name="__codelineno-29-60"></a><span class="w">          </span><span class="nt">items</span><span class="p">:</span>
<a id="__codelineno-29-61" name="__codelineno-29-61"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix-kub-test.duckdns.org.signing.key</span>
<a id="__codelineno-29-62" name="__codelineno-29-62"></a><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix-kub-test.duckdns.org.signing.key</span>
<a id="__codelineno-29-63" name="__codelineno-29-63"></a><span class="w">          </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix-key</span>
<a id="__codelineno-29-64" name="__codelineno-29-64"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix-pv</span>
<a id="__codelineno-29-65" name="__codelineno-29-65"></a><span class="w">        </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span>
<a id="__codelineno-29-66" name="__codelineno-29-66"></a><span class="w">          </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix-storage</span>
<a id="__codelineno-29-67" name="__codelineno-29-67"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix-cm</span>
<a id="__codelineno-29-68" name="__codelineno-29-68"></a><span class="w">        </span><span class="nt">configMap</span><span class="p">:</span>
<a id="__codelineno-29-69" name="__codelineno-29-69"></a><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix</span>
<a id="__codelineno-29-70" name="__codelineno-29-70"></a><span class="w">          </span><span class="nt">defaultMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">420</span>
<a id="__codelineno-29-71" name="__codelineno-29-71"></a><span class="w">          </span><span class="nt">items</span><span class="p">:</span>
<a id="__codelineno-29-72" name="__codelineno-29-72"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">homeserver.yaml</span>
<a id="__codelineno-29-73" name="__codelineno-29-73"></a><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">homeserver.yaml</span>
<a id="__codelineno-29-74" name="__codelineno-29-74"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix-kub-test.duckdns.org.log.config</span>
<a id="__codelineno-29-75" name="__codelineno-29-75"></a><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix-kub-test.duckdns.org.log.config</span>
</code></pre></div></td></tr></table></div>
<div class="admonition failure">
<p class="admonition-title">2023-04-28 - Permission denied</p>
<p>You may experince permission denied error on the mounted <code>/data</code> directory.
This is likely because your persistent volume provider mount the path with wrong uid/guid. Matirx uses 991:991 by default. So I added the followings to the Deployment manifest:
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="w">      </span><span class="nt">securityContext</span><span class="p">:</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="w">        </span><span class="nt">fsGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">991</span>
</code></pre></div></p>
</div>
<p><strong>Download &amp; Apply</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>curl<span class="w">  </span>-L<span class="w"> </span>-o<span class="w"> </span>/tmp/Deployment-matrix.yaml<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>https://raw.githubusercontent.com/jvincze84/jvincze84.github.io/master/docs/files/matrix/Deployment-matrix.yaml
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>/tmp/Deployment-matrix.yaml
</code></pre></div>
<p><strong>Check The Deployment</strong></p>
<p><div class="highlight"><span class="filename">Command</span><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>matrix<span class="w"> </span>get<span class="w"> </span>deployment
</code></pre></div>
<div class="highlight"><span class="filename">Output</span><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>NAME     READY   UP-TO-DATE   AVAILABLE   AGE
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>matrix   1/1     1            1           3d1h 
</code></pre></div></p>
<h4 id="create-service">Create Service<a class="headerlink" href="#create-service" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename"><a href="https://raw.githubusercontent.com/jvincze84/jvincze84.github.io/master/docs/files/matrix/Service-matrix.yaml" target="_blank">Click Here For Raw Source</a></span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-34-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-34-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-34-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-34-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-34-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-34-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-34-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-34-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-34-10">10</a></span>
<span class="normal"><a href="#__codelineno-34-11">11</a></span>
<span class="normal"><a href="#__codelineno-34-12">12</a></span>
<span class="normal"><a href="#__codelineno-34-13">13</a></span>
<span class="normal"><a href="#__codelineno-34-14">14</a></span>
<span class="normal"><a href="#__codelineno-34-15">15</a></span>
<span class="normal"><a href="#__codelineno-34-16">16</a></span>
<span class="normal"><a href="#__codelineno-34-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-34-2" name="__codelineno-34-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<a id="__codelineno-34-3" name="__codelineno-34-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-34-4" name="__codelineno-34-4"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-34-5" name="__codelineno-34-5"></a><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<a id="__codelineno-34-6" name="__codelineno-34-6"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix</span>
<a id="__codelineno-34-7" name="__codelineno-34-7"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix</span>
<a id="__codelineno-34-8" name="__codelineno-34-8"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-34-9" name="__codelineno-34-9"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-34-10" name="__codelineno-34-10"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix</span>
<a id="__codelineno-34-11" name="__codelineno-34-11"></a><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8008</span>
<a id="__codelineno-34-12" name="__codelineno-34-12"></a><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<a id="__codelineno-34-13" name="__codelineno-34-13"></a><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8008</span>
<a id="__codelineno-34-14" name="__codelineno-34-14"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<a id="__codelineno-34-15" name="__codelineno-34-15"></a><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix</span>
<a id="__codelineno-34-16" name="__codelineno-34-16"></a><span class="w">  </span><span class="nt">sessionAffinity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">None</span>
<a id="__codelineno-34-17" name="__codelineno-34-17"></a><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIP</span>
</code></pre></div></td></tr></table></div>
<p><strong>Download &amp; Apply</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>curl<span class="w">  </span>-L<span class="w"> </span>-o<span class="w"> </span>/tmp/Service-matrix.yaml<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>https://raw.githubusercontent.com/jvincze84/jvincze84.github.io/master/docs/files/matrix/Service-matrix.yaml
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>/tmp/Service-matrix.yaml
</code></pre></div>
<p><strong>Check The Service</strong></p>
<p><div class="highlight"><span class="filename">Command</span><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>matrix<span class="w"> </span>describe<span class="w"> </span>svc<span class="w"> </span>matrix
</code></pre></div>
<div class="highlight"><span class="filename">Output</span><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>Name:              matrix
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>Namespace:         matrix
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>Labels:            k8s-app=postgres
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>Annotations:       &lt;none&gt;
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>Selector:          k8s-app=matrix
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a>Type:              ClusterIP
<a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a>IP Family Policy:  SingleStack
<a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a>IP Families:       IPv4
<a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a>IP:                10.22.84.86
<a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a>IPs:               10.22.84.86
<a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a>Port:              matrix  8008/TCP
<a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a>TargetPort:        8008/TCP
<a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a>Endpoints:         10.32.0.3:8008
<a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a>Session Affinity:  None
<a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a>Events:            &lt;none&gt; 
</code></pre></div></p>
<h3 id="deploy-postgres-sql">Deploy Postgres SQL<a class="headerlink" href="#deploy-postgres-sql" title="Permanent link">&para;</a></h3>
<h4 id="create-the-persistentvolumeclaim">Create The <code>PersistentVolumeClaim</code><a class="headerlink" href="#create-the-persistentvolumeclaim" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename"><a href="https://raw.githubusercontent.com/jvincze84/jvincze84.github.io/master/docs/files/matrix/PersistentVolumeClaim-postgres.yaml" target="_blank">Click Here For Raw Source</a></span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-38-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-38-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-38-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-38-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-38-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-38-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-38-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-38-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-38-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-38-10">10</a></span>
<span class="normal"><a href="#__codelineno-38-11">11</a></span>
<span class="normal"><a href="#__codelineno-38-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-38-2" name="__codelineno-38-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
<a id="__codelineno-38-3" name="__codelineno-38-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-38-4" name="__codelineno-38-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres-storage</span>
<a id="__codelineno-38-5" name="__codelineno-38-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix</span>
<a id="__codelineno-38-6" name="__codelineno-38-6"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-38-7" name="__codelineno-38-7"></a><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openebs-hostpath</span>
<a id="__codelineno-38-8" name="__codelineno-38-8"></a><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
<a id="__codelineno-38-9" name="__codelineno-38-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
<a id="__codelineno-38-10" name="__codelineno-38-10"></a><span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
<a id="__codelineno-38-11" name="__codelineno-38-11"></a><span class="w">    </span><span class="nt">requests</span><span class="p">:</span>
<a id="__codelineno-38-12" name="__codelineno-38-12"></a><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50Gi</span>
</code></pre></div></td></tr></table></div>
<p><strong>Download &amp; Apply</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a>curl<span class="w"> </span>-L<span class="w"> </span>-o<span class="w"> </span>/tmp/PersistentVolumeClaim-postgres.yaml<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>https://raw.githubusercontent.com/jvincze84/jvincze84.github.io/master/docs/files/matrix/PersistentVolumeClaim-postgres.yaml
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>/tmp/PersistentVolumeClaim-postgres.yaml
</code></pre></div>
<h4 id="create-secret">Create Secret<a class="headerlink" href="#create-secret" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>matrix<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>generic<span class="w"> </span>postgres-password<span class="w"> </span>--from-literal<span class="o">=</span><span class="nv">pgpass</span><span class="o">=</span><span class="m">12345678</span>
</code></pre></div>
<p>This password will be used in the <code>Deployment</code> as the password of the initial user (<code>POSTGRES_USER</code> = <code>matrix</code>).</p>
<h4 id="deployment">Deployment<a class="headerlink" href="#deployment" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename"><a href="https://raw.githubusercontent.com/jvincze84/jvincze84.github.io/master/docs/files/matrix/Deployment-postgres.yaml" target="_blank">Click Here For Raw Source</a></span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-41-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-41-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-41-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-41-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-41-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-41-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-41-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-41-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-41-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-41-10">10</a></span>
<span class="normal"><a href="#__codelineno-41-11">11</a></span>
<span class="normal"><a href="#__codelineno-41-12">12</a></span>
<span class="normal"><a href="#__codelineno-41-13">13</a></span>
<span class="normal"><a href="#__codelineno-41-14">14</a></span>
<span class="normal"><a href="#__codelineno-41-15">15</a></span>
<span class="normal"><a href="#__codelineno-41-16">16</a></span>
<span class="normal"><a href="#__codelineno-41-17">17</a></span>
<span class="normal"><a href="#__codelineno-41-18">18</a></span>
<span class="normal"><a href="#__codelineno-41-19">19</a></span>
<span class="normal"><a href="#__codelineno-41-20">20</a></span>
<span class="normal"><a href="#__codelineno-41-21">21</a></span>
<span class="normal"><a href="#__codelineno-41-22">22</a></span>
<span class="normal"><a href="#__codelineno-41-23">23</a></span>
<span class="normal"><a href="#__codelineno-41-24">24</a></span>
<span class="normal"><a href="#__codelineno-41-25">25</a></span>
<span class="normal"><a href="#__codelineno-41-26">26</a></span>
<span class="normal"><a href="#__codelineno-41-27">27</a></span>
<span class="normal"><a href="#__codelineno-41-28">28</a></span>
<span class="normal"><a href="#__codelineno-41-29">29</a></span>
<span class="normal"><a href="#__codelineno-41-30">30</a></span>
<span class="normal"><a href="#__codelineno-41-31">31</a></span>
<span class="normal"><a href="#__codelineno-41-32">32</a></span>
<span class="normal"><a href="#__codelineno-41-33">33</a></span>
<span class="normal"><a href="#__codelineno-41-34">34</a></span>
<span class="normal"><a href="#__codelineno-41-35">35</a></span>
<span class="normal"><a href="#__codelineno-41-36">36</a></span>
<span class="normal"><a href="#__codelineno-41-37">37</a></span>
<span class="normal"><a href="#__codelineno-41-38">38</a></span>
<span class="normal"><a href="#__codelineno-41-39">39</a></span>
<span class="normal"><a href="#__codelineno-41-40">40</a></span>
<span class="normal"><a href="#__codelineno-41-41">41</a></span>
<span class="normal"><a href="#__codelineno-41-42">42</a></span>
<span class="normal"><a href="#__codelineno-41-43">43</a></span>
<span class="normal"><a href="#__codelineno-41-44">44</a></span>
<span class="normal"><a href="#__codelineno-41-45">45</a></span>
<span class="normal"><a href="#__codelineno-41-46">46</a></span>
<span class="normal"><a href="#__codelineno-41-47">47</a></span>
<span class="normal"><a href="#__codelineno-41-48">48</a></span>
<span class="normal"><a href="#__codelineno-41-49">49</a></span>
<span class="normal"><a href="#__codelineno-41-50">50</a></span>
<span class="normal"><a href="#__codelineno-41-51">51</a></span>
<span class="normal"><a href="#__codelineno-41-52">52</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<a id="__codelineno-41-2" name="__codelineno-41-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<a id="__codelineno-41-3" name="__codelineno-41-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-41-4" name="__codelineno-41-4"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-41-5" name="__codelineno-41-5"></a><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<a id="__codelineno-41-6" name="__codelineno-41-6"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<a id="__codelineno-41-7" name="__codelineno-41-7"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix</span>
<a id="__codelineno-41-8" name="__codelineno-41-8"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-41-9" name="__codelineno-41-9"></a><span class="w">  </span><span class="nt">progressDeadlineSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">600</span>
<a id="__codelineno-41-10" name="__codelineno-41-10"></a><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<a id="__codelineno-41-11" name="__codelineno-41-11"></a><span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<a id="__codelineno-41-12" name="__codelineno-41-12"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<a id="__codelineno-41-13" name="__codelineno-41-13"></a><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<a id="__codelineno-41-14" name="__codelineno-41-14"></a><span class="w">      </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<a id="__codelineno-41-15" name="__codelineno-41-15"></a><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span>
<a id="__codelineno-41-16" name="__codelineno-41-16"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Recreate</span>
<a id="__codelineno-41-17" name="__codelineno-41-17"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<a id="__codelineno-41-18" name="__codelineno-41-18"></a><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-41-19" name="__codelineno-41-19"></a><span class="w">      </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
<a id="__codelineno-41-20" name="__codelineno-41-20"></a><span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-41-21" name="__codelineno-41-21"></a><span class="w">        </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<a id="__codelineno-41-22" name="__codelineno-41-22"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<a id="__codelineno-41-23" name="__codelineno-41-23"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-41-24" name="__codelineno-41-24"></a><span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<a id="__codelineno-41-25" name="__codelineno-41-25"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">env</span><span class="p">:</span>
<a id="__codelineno-41-26" name="__codelineno-41-26"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD</span>
<a id="__codelineno-41-27" name="__codelineno-41-27"></a><span class="w">          </span><span class="nt">valueFrom</span><span class="p">:</span>
<a id="__codelineno-41-28" name="__codelineno-41-28"></a><span class="w">            </span><span class="nt">secretKeyRef</span><span class="p">:</span>
<a id="__codelineno-41-29" name="__codelineno-41-29"></a><span class="w">              </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pgpass</span>
<a id="__codelineno-41-30" name="__codelineno-41-30"></a><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres-password</span>
<a id="__codelineno-41-31" name="__codelineno-41-31"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER</span>
<a id="__codelineno-41-32" name="__codelineno-41-32"></a><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix</span>
<a id="__codelineno-41-33" name="__codelineno-41-33"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PGDATA</span>
<a id="__codelineno-41-34" name="__codelineno-41-34"></a><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/postgresql/data/pgdata</span>
<a id="__codelineno-41-35" name="__codelineno-41-35"></a><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:13</span>
<a id="__codelineno-41-36" name="__codelineno-41-36"></a><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<a id="__codelineno-41-37" name="__codelineno-41-37"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<a id="__codelineno-41-38" name="__codelineno-41-38"></a><span class="w">        </span><span class="nt">securityContext</span><span class="p">:</span>
<a id="__codelineno-41-39" name="__codelineno-41-39"></a><span class="w">          </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<a id="__codelineno-41-40" name="__codelineno-41-40"></a><span class="w">        </span><span class="nt">terminationMessagePath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/dev/termination-log</span>
<a id="__codelineno-41-41" name="__codelineno-41-41"></a><span class="w">        </span><span class="nt">terminationMessagePolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">File</span>
<a id="__codelineno-41-42" name="__codelineno-41-42"></a><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span>
<a id="__codelineno-41-43" name="__codelineno-41-43"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/postgresql/data</span>
<a id="__codelineno-41-44" name="__codelineno-41-44"></a><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgresdata</span>
<a id="__codelineno-41-45" name="__codelineno-41-45"></a><span class="w">      </span><span class="nt">dnsPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterFirst</span>
<a id="__codelineno-41-46" name="__codelineno-41-46"></a><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<a id="__codelineno-41-47" name="__codelineno-41-47"></a><span class="w">      </span><span class="nt">schedulerName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default-scheduler</span>
<a id="__codelineno-41-48" name="__codelineno-41-48"></a><span class="w">      </span><span class="nt">terminationGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<a id="__codelineno-41-49" name="__codelineno-41-49"></a><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
<a id="__codelineno-41-50" name="__codelineno-41-50"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgresdata</span>
<a id="__codelineno-41-51" name="__codelineno-41-51"></a><span class="w">        </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span>
<a id="__codelineno-41-52" name="__codelineno-41-52"></a><span class="w">          </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres-storage</span>
</code></pre></div></td></tr></table></div>
<p><strong>Download &amp; Apply</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>curl<span class="w"> </span>-L<span class="w"> </span>-o<span class="w"> </span>/tmp/PersistentVolumeClaim-postgres.yaml<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>https://raw.githubusercontent.com/jvincze84/jvincze84.github.io/master/docs/files/matrix/Deployment-postgres.yaml
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>/tmp/Deployment-postgres.yaml
</code></pre></div>
<p><strong>Check The Pod &amp; Logs</strong></p>
<p><div class="highlight"><span class="filename">Command</span><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>matrix<span class="w"> </span>get<span class="w"> </span>deployment
</code></pre></div>
<div class="highlight"><span class="filename">Output</span><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a>NAME       READY   UP-TO-DATE   AVAILABLE   AGE
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a>matrix     1/1     1            1           3d2h
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>postgres   1/1     1            1           6m15s
</code></pre></div>
<div class="highlight"><span class="filename">Command</span><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>matrix<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-o<span class="w"> </span>wide
</code></pre></div>
<div class="highlight"><span class="filename">Output</span><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>NAME                        READY   STATUS    RESTARTS   AGE     IP          NODE                           NOMINATED NODE   READINESS GATES
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>matrix-7658b9d5db-49kcc     1/1     Running   5          5d19h   10.32.0.3   kube-test.int.vinyosoft.info   &lt;none&gt;           &lt;none&gt;
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>postgres-7698969f95-8c4jn   1/1     Running   1          2d18h   10.32.0.8   kube-test.int.vinyosoft.info   &lt;none&gt;           &lt;none&gt;
</code></pre></div>
<div class="highlight"><span class="filename">Command</span><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>matrix<span class="w"> </span>logs<span class="w"> </span><span class="k">$(</span>kubectl<span class="w"> </span>-n<span class="w"> </span>matrix<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-o<span class="w"> </span>name<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>postgres<span class="w"> </span><span class="k">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-n<span class="w"> </span><span class="m">3</span>
</code></pre></div>
<div class="highlight"><span class="filename">Output</span><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a>2021-10-26 18:41:34.085 UTC [1] LOG:  listening on Unix socket &quot;/var/run/postgresql/.s.PGSQL.5432&quot;
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a>2021-10-26 18:41:34.170 UTC [64] LOG:  database system was shut down at 2021-10-26 18:41:33 UTC
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a>2021-10-26 18:41:34.216 UTC [1] LOG:  database system is ready to accept connections
</code></pre></div></p>
<h4 id="service">Service<a class="headerlink" href="#service" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename"><a href="https://raw.githubusercontent.com/jvincze84/jvincze84.github.io/master/docs/files/matrix/Service-postgres.yaml" target="_blank">Click Here For Raw Source</a></span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-49-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-49-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-49-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-49-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-49-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-49-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-49-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-49-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-49-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-49-10">10</a></span>
<span class="normal"><a href="#__codelineno-49-11">11</a></span>
<span class="normal"><a href="#__codelineno-49-12">12</a></span>
<span class="normal"><a href="#__codelineno-49-13">13</a></span>
<span class="normal"><a href="#__codelineno-49-14">14</a></span>
<span class="normal"><a href="#__codelineno-49-15">15</a></span>
<span class="normal"><a href="#__codelineno-49-16">16</a></span>
<span class="normal"><a href="#__codelineno-49-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-49-2" name="__codelineno-49-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<a id="__codelineno-49-3" name="__codelineno-49-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-49-4" name="__codelineno-49-4"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-49-5" name="__codelineno-49-5"></a><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<a id="__codelineno-49-6" name="__codelineno-49-6"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<a id="__codelineno-49-7" name="__codelineno-49-7"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix</span>
<a id="__codelineno-49-8" name="__codelineno-49-8"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-49-9" name="__codelineno-49-9"></a><span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<a id="__codelineno-49-10" name="__codelineno-49-10"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<a id="__codelineno-49-11" name="__codelineno-49-11"></a><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5432</span>
<a id="__codelineno-49-12" name="__codelineno-49-12"></a><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<a id="__codelineno-49-13" name="__codelineno-49-13"></a><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5432</span>
<a id="__codelineno-49-14" name="__codelineno-49-14"></a><span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<a id="__codelineno-49-15" name="__codelineno-49-15"></a><span class="w">    </span><span class="nt">k8s-app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
<a id="__codelineno-49-16" name="__codelineno-49-16"></a><span class="w">  </span><span class="nt">sessionAffinity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">None</span>
<a id="__codelineno-49-17" name="__codelineno-49-17"></a><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIP</span>
</code></pre></div></td></tr></table></div>
<p><strong>Download &amp; Apply</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a>curl<span class="w"> </span>-L<span class="w"> </span>-o<span class="w"> </span>/tmp/Service-postgres.yaml<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>https://raw.githubusercontent.com/jvincze84/jvincze84.github.io/master/docs/files/matrix/Service-postgres.yaml
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>/tmp/Service-postgres.yaml
</code></pre></div>
<p><strong>Check The Service</strong></p>
<p><div class="highlight"><span class="filename">Command</span><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>matrix<span class="w"> </span>describe<span class="w"> </span>services<span class="w"> </span>postgres
</code></pre></div>
<div class="highlight"><span class="filename">Output</span><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a>Name:              postgres
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>Namespace:         matrix
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a>Labels:            k8s-app=postgres
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a>Annotations:       &lt;none&gt;
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a>Selector:          k8s-app=postgres
<a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a>Type:              ClusterIP
<a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a>IP Family Policy:  SingleStack
<a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a>IP Families:       IPv4
<a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a>IP:                10.22.24.132
<a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a>IPs:               10.22.24.132
<a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a>Port:              postgres  5432/TCP
<a id="__codelineno-52-12" name="__codelineno-52-12" href="#__codelineno-52-12"></a>TargetPort:        5432/TCP
<a id="__codelineno-52-13" name="__codelineno-52-13" href="#__codelineno-52-13"></a>Endpoints:         10.32.0.8:5432
<a id="__codelineno-52-14" name="__codelineno-52-14" href="#__codelineno-52-14"></a>Session Affinity:  None
<a id="__codelineno-52-15" name="__codelineno-52-15" href="#__codelineno-52-15"></a>Events:            &lt;none&gt; 
</code></pre></div></p>
<p>Check if the IP address and port of <code>Endpoints</code> are matching the Postgres POD IP address and port.</p>
<h3 id="connect-matix-homeserver-to-postgres">Connect Matix Homeserver To Postgres<a class="headerlink" href="#connect-matix-homeserver-to-postgres" title="Permanent link">&para;</a></h3>
<h4 id="prepare-the-databse">Prepare The Databse<a class="headerlink" href="#prepare-the-databse" title="Permanent link">&para;</a></h4>
<p>First we need to create a user and database for the homeserver, just like we did before in the compose section.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-53-1">1</a></span>
<span class="normal"><a href="#__codelineno-53-2">2</a></span>
<span class="normal"><a href="#__codelineno-53-3">3</a></span>
<span class="normal"><a href="#__codelineno-53-4">4</a></span>
<span class="normal"><a href="#__codelineno-53-5">5</a></span>
<span class="normal"><a href="#__codelineno-53-6">6</a></span>
<span class="normal"><a href="#__codelineno-53-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>matrix<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>postgres-7698969f95-8c4jn<span class="w"> </span>--<span class="w"> </span>/bin/bash
<a id="__codelineno-53-2" name="__codelineno-53-2"></a>
<a id="__codelineno-53-3" name="__codelineno-53-3"></a><span class="c1"># Inside the container:</span>
<a id="__codelineno-53-4" name="__codelineno-53-4"></a>createuser<span class="w"> </span>--pwprompt<span class="w"> </span>synapse_user<span class="w"> </span>-U<span class="w"> </span>matrix
<a id="__codelineno-53-5" name="__codelineno-53-5"></a>Enter<span class="w"> </span>password<span class="w"> </span><span class="k">for</span><span class="w"> </span>new<span class="w"> </span>role:<span class="w"> </span><span class="m">12345678</span>
<a id="__codelineno-53-6" name="__codelineno-53-6"></a>Enter<span class="w"> </span>it<span class="w"> </span>again:<span class="w"> </span><span class="m">12345678</span>
<a id="__codelineno-53-7" name="__codelineno-53-7"></a>createdb<span class="w"> </span>--encoding<span class="o">=</span>UTF8<span class="w"> </span>--locale<span class="o">=</span>C<span class="w"> </span>--template<span class="o">=</span>template0<span class="w"> </span>--owner<span class="o">=</span>synapse_user<span class="w"> </span>synapse<span class="w"> </span>-U<span class="w"> </span>matrix<span class="w">  </span>
</code></pre></div></td></tr></table></div>
<h4 id="modify-the-homeserver-configmap">Modify The Homeserver Configmap<a class="headerlink" href="#modify-the-homeserver-configmap" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>matrix<span class="w"> </span>edit<span class="w"> </span>cm<span class="w"> </span>matrix
</code></pre></div>
<ul>
<li>Lines To Remove</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="w">    </span><span class="nt">database</span><span class="p">:</span>
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sqlite3</span>
<a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="w">      </span><span class="nt">args</span><span class="p">:</span>
<a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="w">        </span><span class="nt">database</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/homeserver.db</span>
</code></pre></div>
<ul>
<li>Lines To add:</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="w">    </span><span class="nt">database</span><span class="p">:</span>
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">psycopg2</span>
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="w">      </span><span class="nt">txn_limit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000</span>
<a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="w">      </span><span class="nt">args</span><span class="p">:</span>
<a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="w">        </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">synapse_user</span>
<a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a><span class="w">        </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">12345678</span>
<a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a><span class="w">        </span><span class="nt">database</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">synapse</span>
<a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a><span class="w">        </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres.matrix.svc.cluster.local</span>
<a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5432</span>
<a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a><span class="w">        </span><span class="nt">cp_min</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a><span class="w">        </span><span class="nt">cp_max</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</code></pre></div>
<p>Basically we are done with set up the Homeserver. There is only one thing to do, somehow publish the homeserver to the Internet.</p>
<h3 id="ingress">Ingress<a class="headerlink" href="#ingress" title="Permanent link">&para;</a></h3>
<p>There are several options for accessing the Matrix Homeserver from the Internet. I don't know your architecture, but maybe you already have an Ingress Controller and a reverse proxy, etc...<br />
I'll show some solutions:</p>
<ul>
<li>My setup at home looks something like this: <code>*.mydomain.hu --&gt; Apache WebServer (reverse proxy) --&gt; Kubernetes Ingress</code>. <ul>
<li>Wildcard certificate installed on the Apache WebSever.</li>
<li>In this setup I need to create only an <code>Ingress</code> in Kubernets and the Homserver immediately becomes accessible. </li>
<li>I recommend using a separate reverse proxy for the incoming connection to Kubernetes. This reverse proxy could be Apache, Nginx, Caddy, etc. </li>
</ul>
</li>
<li>If you don't have separate reverse proxy:<ul>
<li>You can set up Homeserver to listen on a https port: <code>matrix.mydomain.hu --&gt; Ingress SSL Pass-through --&gt; Homeserver (https).</code> </li>
<li>Another way is to setup your <code>Ingress</code> to listen on https: <code>matrix.mydomain.hu --&gt; Ingress (SSL) --&gt; Homeserver (plain http)</code> If you chose this option take a look at this page: <a href="https://kubernetes.github.io/ingress-nginx/user-guide/tls/#automated-certificate-management-with-cert-manager">https://kubernetes.github.io/ingress-nginx/user-guide/tls/#automated-certificate-management-with-cert-manager</a>  </li>
<li>You can setup <code>Caddy</code> on the Kubernetes: <code>homeserver.mydomain.hu --&gt; Ingress To Caddy (http) --&gt; Caddy --&gt; Homserver (service)</code></li>
</ul>
</li>
</ul>
<p>I can't write example for the all available scenario, but I want to post here a working, overall solution, thus I show two examples:</p>
<h4 id="simple-ingress">Simple Ingress<a class="headerlink" href="#simple-ingress" title="Permanent link">&para;</a></h4>
<p>If you have already a working architecture you may need only an Ingress like this:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename"><a href="https://raw.githubusercontent.com/jvincze84/jvincze84.github.io/master/docs/files/matrix/Ingress-matrix.yaml" target="_blank">Click Here For Raw Source</a></span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-57-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-57-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-57-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-57-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-57-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-57-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-57-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-57-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-57-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-57-10">10</a></span>
<span class="normal"><a href="#__codelineno-57-11">11</a></span>
<span class="normal"><a href="#__codelineno-57-12">12</a></span>
<span class="normal"><a href="#__codelineno-57-13">13</a></span>
<span class="normal"><a href="#__codelineno-57-14">14</a></span>
<span class="normal"><a href="#__codelineno-57-15">15</a></span>
<span class="normal"><a href="#__codelineno-57-16">16</a></span>
<span class="normal"><a href="#__codelineno-57-17">17</a></span>
<span class="normal"><a href="#__codelineno-57-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<a id="__codelineno-57-2" name="__codelineno-57-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<a id="__codelineno-57-3" name="__codelineno-57-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-57-4" name="__codelineno-57-4"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<a id="__codelineno-57-5" name="__codelineno-57-5"></a><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/proxy-body-size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">110m</span>
<a id="__codelineno-57-6" name="__codelineno-57-6"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix</span>
<a id="__codelineno-57-7" name="__codelineno-57-7"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix</span>
<a id="__codelineno-57-8" name="__codelineno-57-8"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-57-9" name="__codelineno-57-9"></a><span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<a id="__codelineno-57-10" name="__codelineno-57-10"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix.k8s-test.loc</span>
<a id="__codelineno-57-11" name="__codelineno-57-11"></a><span class="w">    </span><span class="nt">http</span><span class="p">:</span>
<a id="__codelineno-57-12" name="__codelineno-57-12"></a><span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<a id="__codelineno-57-13" name="__codelineno-57-13"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">backend</span><span class="p">:</span>
<a id="__codelineno-57-14" name="__codelineno-57-14"></a><span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<a id="__codelineno-57-15" name="__codelineno-57-15"></a><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix</span>
<a id="__codelineno-57-16" name="__codelineno-57-16"></a><span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<a id="__codelineno-57-17" name="__codelineno-57-17"></a><span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8008</span>
<a id="__codelineno-57-18" name="__codelineno-57-18"></a><span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ImplementationSpecific</span>
</code></pre></div></td></tr></table></div>
<p><strong>Download &amp; Apply</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a>curl<span class="w"> </span>-L<span class="w"> </span>-o<span class="w"> </span>/tmp/Ingress-matrix.yaml<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a>https://raw.githubusercontent.com/jvincze84/jvincze84.github.io/master/docs/files/matrix/Ingress-matrix.yaml
<a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>/tmp/Ingress-matrix.yaml
</code></pre></div>
<p><strong>Check Ingress</strong></p>
<p><div class="highlight"><span class="filename">Command</span><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>matrix<span class="w"> </span>describe<span class="w"> </span>ingress<span class="w"> </span>matrix
</code></pre></div>
<div class="highlight"><span class="filename">Output</span><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a>Name:             matrix
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a>Namespace:        matrix
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a>Address:          172.16.1.214
<a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a>Default backend:  default-http-backend:80 (&lt;error: endpoints &quot;default-http-backend&quot; not found&gt;)
<a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a>Rules:
<a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a>  Host                 Path  Backends
<a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a>  ----                 ----  --------
<a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a><span class="hll">  matrix.k8s-test.loc  
</span><a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a><span class="hll">                          matrix:8008 (10.32.0.3:8008)
</span><a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a>Annotations:           nginx.ingress.kubernetes.io/proxy-body-size: 110m
<a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a>Events:
<a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a>  Type    Reason  Age                From                      Message
<a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a>  ----    ------  ----               ----                      -------
<a id="__codelineno-60-14" name="__codelineno-60-14" href="#__codelineno-60-14"></a>  Normal  Sync    24s (x3 over 17m)  nginx-ingress-controller  Scheduled for sync 
</code></pre></div></p>
<p><strong>How Ingress - Service And Deployment Are Related?</strong></p>
<p>If you want to know more about how these three things are related read the following article: <a href="https://dwdraju.medium.com/how-deployment-service-ingress-are-related-in-their-manifest-a2e553cf0ffb">https://dwdraju.medium.com/how-deployment-service-ingress-are-related-in-their-manifest-a2e553cf0ffb</a></p>
<p><img alt="deployment-service-ingress.png" src="/assets/images/deployment-service-ingress.png" /></p>
<p>In our case, this the flow:</p>
<p><img alt="DeepinScreenshot_select-area_20211031181702.png" src="/assets/images/DeepinScreenshot_select-area_20211031181702.png" /></p>
<h4 id="cert-manager">Cert Manager<a class="headerlink" href="#cert-manager" title="Permanent link">&para;</a></h4>
<p>First I wanted to write about <code>Caddy</code> here, but changed my mind. I think a much more suitable solution is using the <a href="https://cert-manager.io">Cert Manager</a>.<br />
My first thought was to deploy <code>Caddy</code>, setup as reverse proxy for the Matrix <code>Service</code>, and create an <code>Ingress</code> for <code>Caddy</code>. This would have been similar to what we did in the compose file before. I don't think anybody wants to use Ingress and Caddy in this way. </p>
<p>Documentations:</p>
<ul>
<li><a href="https://cert-manager.io">https://cert-manager.io</a></li>
<li><a href="https://kubernetes.github.io/ingress-nginx/user-guide/tls/#automated-certificate-management-with-cert-manager">https://kubernetes.github.io/ingress-nginx/user-guide/tls/#automated-certificate-management-with-cert-manager</a></li>
</ul>
<p>I'm using Nginx Ingrees Controller for this demo. I won't write here a step-by-step installation about the Ingress controller. If you need detailed documentation please consult the official site: <a href="https://kubernetes.github.io/ingress-nginx/deploy/">https://kubernetes.github.io/ingress-nginx/deploy/</a>, or see my single node Kubernetes installation article.</p>
<p><strong>Install Cert Manager</strong></p>
<p>Installing cert-manager is really simple, only one command:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://github.com/jetstack/cert-manager/releases/download/v1.6.0/cert-manager.yaml
</code></pre></div>
<p>For more details visit the official documentation <a href="https://cert-manager.io/docs/installation/kubectl/">here</a></p>
<p><strong>ClusterIssuer</strong></p>
<p>We are going to create two <code>ClusterIssuer</code>: </p>
<ol>
<li>Letsencrypt Staging</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager.io/v1</span>
<a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIssuer</span>
<a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-staging</span>
<a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a><span class="w">  </span><span class="nt">acme</span><span class="p">:</span>
<a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a><span class="w">    </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jvincze84@gmail.com</span>
<a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://acme-staging-v02.api.letsencrypt.org/directory</span>
<a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a><span class="w">    </span><span class="nt">privateKeySecretRef</span><span class="p">:</span>
<a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-staging</span>
<a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span>
<a id="__codelineno-62-12" name="__codelineno-62-12" href="#__codelineno-62-12"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http01</span><span class="p">:</span>
<a id="__codelineno-62-13" name="__codelineno-62-13" href="#__codelineno-62-13"></a><span class="w">        </span><span class="nt">ingress</span><span class="p">:</span>
<a id="__codelineno-62-14" name="__codelineno-62-14" href="#__codelineno-62-14"></a><span class="w">          </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</code></pre></div>
<ol>
<li>Letsencrypt Production</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cert-manager.io/v1</span>
<a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIssuer</span>
<a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
<a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a><span class="w">  </span><span class="nt">acme</span><span class="p">:</span>
<a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a><span class="w">    </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jvincze84@gmail.com</span>
<a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://acme-v02.api.letsencrypt.org/directory</span>
<a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a><span class="w">    </span><span class="nt">preferredChain</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ISRG</span><span class="nv"> </span><span class="s">Root</span><span class="nv"> </span><span class="s">X1&quot;</span>
<a id="__codelineno-63-10" name="__codelineno-63-10" href="#__codelineno-63-10"></a><span class="w">    </span><span class="nt">privateKeySecretRef</span><span class="p">:</span>
<a id="__codelineno-63-11" name="__codelineno-63-11" href="#__codelineno-63-11"></a><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
<a id="__codelineno-63-12" name="__codelineno-63-12" href="#__codelineno-63-12"></a><span class="w">    </span><span class="nt">solvers</span><span class="p">:</span>
<a id="__codelineno-63-13" name="__codelineno-63-13" href="#__codelineno-63-13"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">http01</span><span class="p">:</span>
<a id="__codelineno-63-14" name="__codelineno-63-14" href="#__codelineno-63-14"></a><span class="w">        </span><span class="nt">ingress</span><span class="p">:</span>
<a id="__codelineno-63-15" name="__codelineno-63-15" href="#__codelineno-63-15"></a><span class="w">          </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
</code></pre></div>
<p>Check:</p>
<p><div class="highlight"><span class="filename">Command</span><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>ClusterIssuer<span class="w"> </span>-o<span class="w"> </span>wide
</code></pre></div>
<div class="highlight"><span class="filename">Output</span><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a>NAME                  READY   STATUS                                                 AGE
<a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a>letsencrypt-prod      True    The ACME account was registered with the ACME server   49s
<a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a>letsencrypt-staging   True    The ACME account was registered with the ACME server   5h31m 
</code></pre></div></p>
<p><strong>Create <code>Ingress</code></strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a><span class="w">    </span><span class="nt">cert-manager.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>
<a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/proxy-body-size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">110m</span>
<a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix</span>
<a id="__codelineno-66-8" name="__codelineno-66-8" href="#__codelineno-66-8"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix</span>
<a id="__codelineno-66-9" name="__codelineno-66-9" href="#__codelineno-66-9"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-66-10" name="__codelineno-66-10" href="#__codelineno-66-10"></a><span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<a id="__codelineno-66-11" name="__codelineno-66-11" href="#__codelineno-66-11"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">homeserver.matrix-kub-test.duckdns.org</span>
<a id="__codelineno-66-12" name="__codelineno-66-12" href="#__codelineno-66-12"></a><span class="w">    </span><span class="nt">http</span><span class="p">:</span>
<a id="__codelineno-66-13" name="__codelineno-66-13" href="#__codelineno-66-13"></a><span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<a id="__codelineno-66-14" name="__codelineno-66-14" href="#__codelineno-66-14"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">backend</span><span class="p">:</span>
<a id="__codelineno-66-15" name="__codelineno-66-15" href="#__codelineno-66-15"></a><span class="w">          </span><span class="nt">service</span><span class="p">:</span>
<a id="__codelineno-66-16" name="__codelineno-66-16" href="#__codelineno-66-16"></a><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix</span>
<a id="__codelineno-66-17" name="__codelineno-66-17" href="#__codelineno-66-17"></a><span class="w">            </span><span class="nt">port</span><span class="p">:</span>
<a id="__codelineno-66-18" name="__codelineno-66-18" href="#__codelineno-66-18"></a><span class="w">              </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8008</span>
<a id="__codelineno-66-19" name="__codelineno-66-19" href="#__codelineno-66-19"></a><span class="w">        </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ImplementationSpecific</span>
<a id="__codelineno-66-20" name="__codelineno-66-20" href="#__codelineno-66-20"></a><span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
<a id="__codelineno-66-21" name="__codelineno-66-21" href="#__codelineno-66-21"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span>
<a id="__codelineno-66-22" name="__codelineno-66-22" href="#__codelineno-66-22"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">homeserver.matrix-kub-test.duckdns.org</span>
<a id="__codelineno-66-23" name="__codelineno-66-23" href="#__codelineno-66-23"></a><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">matrix-prod-ingress</span>
</code></pre></div>
<p>That's all! :) If your Kubernetes Ingress accessible from the Internet on port 80 and 443 the certificate issued in some seconds. </p>
<p><strong>Checks</strong></p>
<p>If something is not working as expected, there are some <code>resources</code> you should check.</p>
<p><div class="highlight"><span class="filename">Command</span><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a>api-resources<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>cert-manager.io
</code></pre></div>
<div class="highlight"><span class="filename">Output</span><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a>challenges                                     acme.cert-manager.io/v1                true         Challenge
<a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a>orders                                         acme.cert-manager.io/v1                true         Order
<a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a>certificaterequests               cr,crs       cert-manager.io/v1                     true         CertificateRequest
<a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a>certificates                      cert,certs   cert-manager.io/v1                     true         Certificate
<a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a>clusterissuers                                 cert-manager.io/v1                     false        ClusterIssuer
<a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a>issuers                                        cert-manager.io/v1                     true         Issuer 
</code></pre></div></p>
<p>First check <code>challenges</code>:</p>
<p><div class="highlight"><span class="filename">Command</span><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>matrix<span class="w"> </span>get<span class="w"> </span>challenges
</code></pre></div>
<div class="highlight"><span class="filename">Output</span><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a>NAME                                              STATE     DOMAIN                                   AGE
<a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a>matrix-prod-ingress-gptxf-1059591821-1281697531   pending   homeserver.matrix-kub-test.duckdns.org   2m42s 
</code></pre></div></p>
<p>You can see that the <code>challenge</code> is in <code>pending</code> state. You can check what could be the problem with the following command:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>matrix<span class="w"> </span>get<span class="w"> </span>challenges<span class="w"> </span>matrix-prod-ingress-gptxf-1059591821-1281697531<span class="w"> </span>-o<span class="w"> </span>yaml
</code></pre></div>
<p>Example error message:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a>status:
<a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a>  presented: true
<a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a>  processing: true
<a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a>  reason: &#39;Waiting for HTTP-01 challenge propagation: failed to perform self check
<a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a>    GET request &#39;&#39;http://homeserver.matrix-kub-test.duckdns.org/.well-known/acme-challenge/lgUy6mCEhhbQ9n_v3w_C47cbVgc5Bfvoy6JW3oxrH1o&#39;&#39;:
<a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a>    Get &quot;http://homeserver.matrix-kub-test.duckdns.org/.well-known/acme-challenge/lgUy6mCEhhbQ9n_v3w_C47cbVgc5Bfvoy6JW3oxrH1o&quot;:
<a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a>    dial tcp 87.97.31.112:80: i/o timeout (Client.Timeout exceeded while awaiting
<a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a>    headers)&#39;
<a id="__codelineno-72-9" name="__codelineno-72-9" href="#__codelineno-72-9"></a>  state: pending
</code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Just for reference, in my case the problem was that hairpin NAT wasn't set up properly in my router. </p>
</div>
<p>Check <code>certificaterequests</code> and <code>certificates</code></p>
<p><div class="highlight"><span class="filename">Command</span><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>matrix<span class="w"> </span>get<span class="w"> </span>crs,certs
</code></pre></div>
<div class="highlight"><span class="filename">Command</span><pre><span></span><code><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a>NAME                                                           APPROVED   DENIED   READY   ISSUER             REQUESTOR                                         AGE
<a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a>certificaterequest.cert-manager.io/matrix-prod-ingress-gptxf   True                True    letsencrypt-prod   system:serviceaccount:cert-manager:cert-manager   19m
<a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a>
<a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a>NAME                                              READY   SECRET                AGE
<a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a>certificate.cert-manager.io/matrix-prod-ingress   True    matrix-prod-ingress   19m 
</code></pre></div></p>
<p>Your certificate is stored in this <code>Secret</code>: <code>secretName: matrix-prod-ingress</code></p>
<h2 id="final-thoughts">Final Thoughts<a class="headerlink" href="#final-thoughts" title="Permanent link">&para;</a></h2>
<p>I hope this article contains a lot of useful examples, use cases and help you to build your own Matrix Homeserver.<br />
Of course there are any other options to deploy the Homeserver to Kubernetes, the way I showed here contains many useful examples on how to use docker-compose, service, ingress, cert-manager, configmap, secret, etc...</p>







  
  




  


<script src="https://giscus.app/client.js"
        data-repo="jvincze84/jvincze84.github.io"
        data-repo-id="R_kgDOGJolJg"
        data-category-id="DIC_kwDOGJolJs4CPryr"
        data-mapping="title"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="transparent_dark"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>
      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <!-- Cookie Consent by https://www.CookieConsent.com -->
<script type="text/javascript" src="//www.cookieconsent.com/releases/4.0.0/cookie-consent.js" charset="UTF-8"></script>
<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({"notice_banner_type":"headline","consent_type":"express","palette":"light","language":"en","page_load_consent_levels":["strictly-necessary"],"notice_banner_reject_button_hide":false,"preferences_center_close_button_hide":false,"website_name":"Blog"});
});
</script>

<noscript>ePrivacy and GPDR Cookie Consent by <a href="https://www.CookieConsent.com/" rel="nofollow noopener">Cookie Consent</a></noscript>
<!-- End Cookie Consent by https://www.CookieConsent.com -->

      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../../../..", "features": ["navigation.indexes", "navigation.top", "search.suggest", "search.highlight", "search.highlight", "header.autohide", "content.code.annotate", "content.code.copy"], "search": "../../../../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>