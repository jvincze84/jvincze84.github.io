
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="http://proba.voda.net/site/old/nodemcu/Reliable_MQTT_conenction_with_NodeMCU/">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.3.0">
    
    
      
        <title>Reliable MQTT conenction with NodeMCU - Vincze Janos blog</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.8b42a75e.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../../../css/width.css">
    
      <link rel="stylesheet" href="../../../css/prism.css">
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="ligh" data-md-color-primary="" data-md-color-accent="">
  
    
    <script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#reliable-mqtt-conenction-with-nodemcu" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Vincze Janos blog" class="md-header__button md-logo" aria-label="Vincze Janos blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Vincze Janos blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Reliable MQTT conenction with NodeMCU
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Vincze Janos blog" class="md-nav__button md-logo" aria-label="Vincze Janos blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Vincze Janos blog
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          Outdated Docs (WARIN)
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Outdated Docs (WARIN)" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Outdated Docs (WARIN)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Collect_Network_Statistic_With_Telegraf_Vnstat/" class="md-nav__link">
        Collect Network Statistic With Telegraf & VNSTAT
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Iptables_Examples/" class="md-nav__link">
        Iptables Examples
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Nokia_6120c_%28bb5%29_Forgotten_Security_Code/" class="md-nav__link">
        Nokia 6120c (BB5) Forgotten Security Code
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Sonoff_Relays_With_Openhab_And_Tasmota_Firmware/" class="md-nav__link">
        Sonoff Relays With OpenHab And Tasmota Firmware
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_5" type="checkbox" id="__nav_1_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1_5">
          Raspberry & Orange PI
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Raspberry & Orange PI" data-md-level="2">
        <label class="md-nav__title" for="__nav_1_5">
          <span class="md-nav__icon md-icon"></span>
          Raspberry & Orange PI
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../raspberry/Move_Root_File_System_To_Usb_Storage_%28rpi2_%26_Rpi3%29/" class="md-nav__link">
        Move root file system to USB storage (RPI2 & RPI3)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../raspberry/Raspberry_Pi_3_As_Wifi_Range_Extender/" class="md-nav__link">
        Raspberry PI 3 As Wifi Range Extender
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../raspberry/How_To_Install_Nodered_On_Raspberry_Pi/" class="md-nav__link">
        How To Install NodeRED on Raspberry PI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../raspberry/Compile_Go_Language_On_Raspberry_Pi/" class="md-nav__link">
        Compile GO language on Raspberry PI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../raspberry/Raspberry_Pi_2_As_Print_Server_Airprint/" class="md-nav__link">
        Raspberry PI 2 as print server + AirPrint
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../raspberry/Google_Cloud_Print_With_Orange_Pi_or_Rpi/" class="md-nav__link">
        Google Cloud Print With Orange PI (or RPI)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../raspberry/Install_Debian_Jessie_To_Orange_Pi_Plus_2/" class="md-nav__link">
        Install Debian Jessie to Orange PI Plus 2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../raspberry/Mount_Sd_Card_Image_partitioned_Image_Wo_Kpartx/" class="md-nav__link">
        Mount SD card image (partitioned image) w/o kpartx
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Install_Openalpr_On_Raspberry_Pi_3/" class="md-nav__link">
        Install OpenALPR on Raspberry PI 3
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../raspberry/Install_Openalpr_On_Raspberry_Pi_3_part_2/" class="md-nav__link">
        Install OpenALPR on Raspberry PI 3 (Part 2)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_6" type="checkbox" id="__nav_1_6" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_1_6">
          NodeMCU - LUA / ESP8266
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="NodeMCU - LUA / ESP8266" data-md-level="2">
        <label class="md-nav__title" for="__nav_1_6">
          <span class="md-nav__icon md-icon"></span>
          NodeMCU - LUA / ESP8266
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../How_To_Unbrick_Esp8266_blinking_Blue_Led/" class="md-nav__link">
        How To Unbrick ESP8266 (Blinking Blue Led)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Very_Simple_Way_To_Send_Email_Using_Nodemcu_Firmware/" class="md-nav__link">
        Very Simple Way to Send Email Using NodeMCU firmware
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Reliable MQTT conenction with NodeMCU
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Reliable MQTT conenction with NodeMCU
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tldr" class="md-nav__link">
    TL;DR
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-kind-of-problem-can-occurr" class="md-nav__link">
    What kind of problem can occurr?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#checklwt" class="md-nav__link">
    checkLwt()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connectreconnect-tmr" class="md-nav__link">
    connectReconnect() &amp; tmr()
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Reliable_Mqtt_Connection_With_Nodemcu_%28part_2%29/" class="md-nav__link">
        Reliable MQTT connection with NodeMCU (part 2)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../How_To_Compile_Nodemcu_Firmware/" class="md-nav__link">
        How to compile NodeMCU firmware
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Logging_Mqtt_Data_%28subscription%29_To_Mysql_With_Shell_Script/" class="md-nav__link">
        Logging MQTT data (subscription) to MySQL with Shell Script
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_7" type="checkbox" id="__nav_1_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1_7">
          Linux Tutorials
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Linux Tutorials" data-md-level="2">
        <label class="md-nav__title" for="__nav_1_7">
          <span class="md-nav__icon md-icon"></span>
          Linux Tutorials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/Install_%28compile%29_%26_Configure_Motion_Av_Tools/" class="md-nav__link">
        Install (compile) & Configure motion + AV tools
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/Create_Self_Signed_Certificate_For_Apache_Webserver/" class="md-nav__link">
        Create Self Signed Certificate for Apache WebServer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/Compile_Apache_Httpd_2.4.x_Php/" class="md-nav__link">
        Compile Apache HTTPD 2.4.X & PHP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/Install_Mps-youtube_Console_Based_Youtube_Player/" class="md-nav__link">
        Install mps-youtube console based youtube player
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/create_Your_Own_Dyndns_Service_With_Bind_named/" class="md-nav__link">
        Create Your Own DynDns Service with Bind (Named)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../Tips_And_Tricks/" class="md-nav__link">
        Tips And Tricks
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tldr" class="md-nav__link">
    TL;DR
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-kind-of-problem-can-occurr" class="md-nav__link">
    What kind of problem can occurr?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#checklwt" class="md-nav__link">
    checkLwt()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connectreconnect-tmr" class="md-nav__link">
    connectReconnect() &amp; tmr()
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <div class="admonition caution">
<p class="admonition-title">Caution</p>
<p><strong>This page has been updated a long time ago.</strong>  Information found here could be outdated and may lead to missconfiguration.<br />
Some of the links and references may be broken or lead to non existing pages.<br />
Please use this docs carefully. Most of the information here now is only for reference or example!</p>
</div>
<h1 id="reliable-mqtt-conenction-with-nodemcu">Reliable MQTT conenction with NodeMCU<a class="headerlink" href="#reliable-mqtt-conenction-with-nodemcu" title="Permanent link">&para;</a></h1>
<h2 id="tldr">TL;DR<a class="headerlink" href="#tldr" title="Permanent link">&para;</a></h2>
<p>I want to use ESP modules for my brand new project: **H**ome **A**utomatization **W**ith **O**penHAB (HAWO). :) To realise this I want to connect some ESP module to my OpenHAB server using MQTT broker (mosquitto). Building a complete Smart Home is not my goal (at least not now), I only want to control some lights / stuff with my phone (or tablet) and place some DHT22 (Temperature and Humidity) sensors in my house, workshop and garden.<br />
I started working with NodeMCU some months ago and I ran into several problems and bugs during my coding. I cannot write all my experience to this post, but I hope this will be helpful for you. :)</p>
<p>Steps to be done before you can connect to mqtt broker:</p>
<ul>
<li>Install and configure mosquitto mqtt broker </li>
<li>Connect ESP8266 module to your Wi-fi network  </li>
</ul>
<p>Maybe later I will write a posts about these steps, but now I want to give more details only about mqtt connection in this thread. 
So I need a reliable connection to my mqtt broker which can handle network or other errors. Unfortunately for some reason mqtt module can not re-connect to broker for example if Wi-fi disconnect and reconnect. 
To better understand here is a basic example to connect to the broker.</p>
<pre><code class="language-lua">m = mqtt.Client(&quot;ClienID&quot;, 60, &quot;test&quot;, &quot;test123&quot;)
m:connect(&quot;192.168.10.10&quot;, 1883, 0, 
  function(client) 
     print(&quot;connected&quot;) 
   end, 
 function(client, reason) 
  print(&quot;failed reason: &quot;..reason) 
end)
</code></pre>
<p>When you specify <code>mqtt.client:connect()</code> you have on option to turn on/off auto-reconnect. 
<code>mqtt:connect(host[, port[, secure[, autoreconnect]]][, function(client)[, function(client, reason)]])</code></p>
<h2 id="what-kind-of-problem-can-occurr">What kind of problem can occurr?<a class="headerlink" href="#what-kind-of-problem-can-occurr" title="Permanent link">&para;</a></h2>
<ul>
<li>Wi-fi disconnection </li>
<li>MQTT broker become unavailable or is being restarted.</li>
<li>Other network issues (eg.: DNS error)</li>
<li>Misconfiguration: bad username, password, etc.</li>
</ul>
<p>My biggest problem is that the connection between ESP and the broker cannot be tested in any way. 
Based on my experiences I ran into these problems:</p>
<ul>
<li>Using <strong>autoreconnect true</strong></li>
<li>If I restart mosquitto the clients reconnect to it successfully. </li>
<li>But if I disconnect and connect to Wi-fi, the clients can not reconnect. This is a big problem because you can not reconnect to the broker. If you try <code>mqtt.client:connect()</code> again ESP will give you "Already Connected" error message. If you try firstly <code>mqtt.client:close()</code> the ESP will be restarted. I do not know if this behavior is a bug or a feature but it is really annoying.</li>
</ul>
<p>I tried to check if the connection is established or not with this <code>if</code> condition:  </p>
<pre><code class="language-lua">if  m:publish(config.mqttLwtTopic,&quot;Active&quot;,0,1)
  then
    DO SOMETHING
  else
    DO SOMETHING ELSE
end
</code></pre>
<p>But if you use autoreconnect=true it will return with true in any case, regardless whether  the message has been delivered or not. </p>
<ul>
<li>Using <strong>autoreconnect false</strong><br />
It can be a good option but in this case we have to check the connection manually, and reconnect if something happens. </li>
</ul>
<p>My final solution is two functions and a timer combined with each other:</p>
<pre><code class="language-lua">local function checkLwt()
    if  m:publish(config.mqttLwtTopic,&quot;Active&quot;,0,1)
        then
            return true
        else
            return false
    end
end

local function connectReconnect()
    m:connect(config.mqttHost, config.mqttPort, 0, 0,
    function(client) 
            print(&quot;MQTT connected to: &quot;..config.mqttHost) 
            subsribe()
            onMessage()
            tmr.start(config.mqttCheckTimerId)
    end, 
    function(client, reason) 
            print(&quot;failed reason: &quot;..reason) 
            print(&quot;Sleep for 10 secs&quot;)
            tmr.alarm(6,10000,tmr.ALARM_SINGLE, function()
                connectReconnect()
            end)


    end)
end
tmr.register(config.mqttCheckTimerId,config.mqttTmrDelay, tmr.ALARM_AUTO,
function()
        local status, err = pcall(checkLwt)
        if status == true and err == true
        then
            print(&quot;LWT OK&quot;)
            updateStatus()
        elseif status == true and err == false
        then
            print(&quot;LWT FAILED&quot;)
            connectReconnect()
        end
        if status == false and err ~= true
        then
                print(&quot;LWT faild with notconnected...&quot;)
                tmr.stop(config.mqttCheckTimerId)
        end


end)
</code></pre>
<h2 id="checklwt">checkLwt()<a class="headerlink" href="#checklwt" title="Permanent link">&para;</a></h2>
<p>There are three scenarios:</p>
<ul>
<li>Message is successfully delivered. Return true.</li>
<li>Message is failed to deliver. Return false.</li>
<li>And the last one is the worst. :( If this function is called while the client is trying to connect to the broker it will fail with "Not Connected" exception and ESP will be restarted. That's why I use <code>pcall</code> (Protected Call) in the timer.</li>
</ul>
<pre><code class="language-lua">local status, err = pcall(checkLwt)
if status == true and err == true
...

</code></pre>
<p>The <code>status</code> is true when the function returns without exception. It prevents the ESP from restarting if the function throws an exception (Not Connected). Status can be true or false.
The <code>err</code> can be <code>true</code> or the error message of the exception.
Based on that 3 scenario exists:</p>
<ul>
<li><code>status == true and err == true</code><br />
  The function successfully finished. Everything is OK.</li>
<li><code>status == true and err == false</code><br />
In this situation probably there is something with mqtt server. For example it stopped or is unreachable.</li>
<li><code>status == false and err ~= true</code><br />
Please not that I use "not equal" <code>~=</code> because err can be an error message as well. 
So in this situation it is likely that we get "not connected" exception, and maybe something happened with the Wi-fi connection.</li>
<li>bonus: <code>status == false and err == true</code><br />
O.K. This is not possible. If status is false it means that we got an exception thus err could not be true.</li>
</ul>
<h2 id="connectreconnect-tmr">connectReconnect() &amp; tmr()<a class="headerlink" href="#connectreconnect-tmr" title="Permanent link">&para;</a></h2>
<p>This is the main part of my code. What will happen when connectReconnect function is called?</p>
<ol>
<li>If the connection to the broker is successful</li>
<li>the timer will be started</li>
<li>and some other functions will be called. </li>
<li>If the client failed to connect to the broker</li>
<li>Wait 10 secs and the function will call itself.<br />
As you can see this is a recursive function which continuously call itself until the connection is established.
The timer check whether the publication is working or not. Why  is it necessary to use 2 different error conditions? If the checkLwt fails, we have to know why, because if it fails due to <strong>the broker unavailability</strong>, callback events of <code>mqtt.client:connect()</code> won't work, neither the success nor the failed function will run.</li>
</ol>
<p>At first <code>status == true and err == false</code> condition will be always true, and connectReconnect() function will be called. From that point there are two error case:</p>
<ul>
<li>There is some network error, for example "DNS failure!". In this case the function will call itself. BUT! The timer is still running and will run into the <code>status == false and err ~= true</code> condition (because of "Not Connected" exception). We have to stop the timer because it is unnecessary.  The recursive function will call itself until the connection is not ready, and if we call <code>mqtt.client:connect()</code> multiple times, we will get "Already Connected" exception.</li>
<li>The broker is shut down: <code>status == true and err == false</code> As I mentioned in this case the callback event of  <code>mqtt.client:connect()</code> won't work that's why we have to call connectReconnect() until the connection is not ready. </li>
</ul>
<p>I've created a table for the better understanding of <code>status</code> and <code>err</code>:</p>
<p><img alt="Table" src="/assets/images/2016/09/2016-09-23_114913.jpg" /></p>
<p><strong>Two</strong> more very <strong>important</strong> things:</p>
<ul>
<li>Call connectReconnect() function after the network connection is successfully established. </li>
<li>Register the "offline" callback event:</li>
</ul>
<pre><code class="language-lua">m:on(&quot;offline&quot;, function(con) 
    print (&quot;Offline&quot;) 
    setup.resetRelay()
    tmr.start(config.mqttCheckTimerId)
end) 
</code></pre>
<p><strong><mark>NOTE</mark></strong><br />
Always start the connection procedure by starting the timer, not by calling conenctReconnect() function. (<code>tmr.start(config.mqttCheckTimerId)</code>)!!! 
Why? Because if you are connected to Wi-fi network and call connectReconnect() function, but MQTT broker is unavailable the timer never will be started, because <code>mqtt.client:connect()</code> will fail and neither the true nor the false function will be called (because of previously mentioned bug).</p>
<p><strong>Summary:</strong></p>
<p>Maybe this is not the best solution but I failed to find better one. I tried uncountable   variations of functions and timers and their combinations. The most important for me that the connection has to be reliable, and in case of any error ESP has to be reconnected to the broker.
Maybe when the mentioned bugs will be fixed in the future, it will be enough to use only the reconnect=true option.</p>
<p>You can download my full example from this <a href="https://drive.google.com/drive/folders/0B4xTxuaiVCZyZm0yMEpJMWNGclk?usp=sharing">link</a>.</p>
<p><strong><mark>References:</mark></strong></p>
<ul>
<li>https://docs.coronalabs.com/api/library/index.html</li>
<li>https://nodemcu.readthedocs.io/en/master/</li>
<li>https://www.lua.org/pil/8.5.html</li>
</ul>
<p><mark><strong>UPDATE:</strong></mark> <a href="http://blog.vinczejanos.info/2016/12/21/reliable-mqtt-connection-with-nodemcu-part-2/">Reliable MQTT connection with NodeMCU (part 2)</a></p>
                
              
              
                


  <h2 id="__comments">Comments</h2>
  <div id="disqus_thread"></div>
  <script>var disqus_config=function(){this.page.url="http://proba.voda.net/site/old/nodemcu/Reliable_MQTT_conenction_with_NodeMCU/",this.page.identifier="old/nodemcu/Reliable_MQTT_conenction_with_NodeMCU/"};window.addEventListener("load",function(){var e=document,i=e.createElement("script");i.src="//shortname-jvincze-test.disqus.com/embed.js",i.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(i)})</script>

              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Back to top
          </a>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../Very_Simple_Way_To_Send_Email_Using_Nodemcu_Firmware/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Very Simple Way to Send Email Using NodeMCU firmware" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Very Simple Way to Send Email Using NodeMCU firmware
            </div>
          </div>
        </a>
      
      
        
        <a href="../Reliable_Mqtt_Connection_With_Nodemcu_%28part_2%29/" class="md-footer__link md-footer__link--next" aria-label="Next: Reliable MQTT connection with NodeMCU (part 2)" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Reliable MQTT connection with NodeMCU (part 2)
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tracking", "navigation.sections", "navigation.top", "search.suggest", "search.highlight", "search.suggest", "search.highlight"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../assets/javascripts/workers/search.f8263e09.min.js", "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.4fc53ad4.min.js"></script>
      
        <script src="../../../js/prism.js"></script>
      
    
  </body>
</html>